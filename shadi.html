<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nikah Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4 text-center">💍 Nikah Portal</h1>

  <!-- User Form -->
  <form id="profileForm" class="bg-white p-4 rounded shadow mb-6 space-y-2">
    <h2 class="font-semibold">Submit Profile</h2>
    <input name="name" placeholder="Full Name" class="border p-2 w-full rounded" required/>
    <input name="age" type="number" placeholder="Age" class="border p-2 w-full rounded" required/>
    <input name="birthdate" type="date" class="border p-2 w-full rounded"/>
    <input name="postingDate" type="date" class="border p-2 w-full rounded"/>
    <input name="address" placeholder="Address" class="border p-2 w-full rounded"/>
    <input name="whatsapp" placeholder="WhatsApp Number" class="border p-2 w-full rounded"/>
    <input type="file" id="photoInput" accept="image/*" class="border p-2 w-full rounded"/>
    <button class="bg-green-500 text-white px-4 py-2 rounded">Submit</button>
  </form>

  <!-- Public Posts -->
  <div id="postsList" class="grid md:grid-cols-2 gap-4"></div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="mt-10">
    <h2 class="text-xl font-bold mb-2">🛠 Admin Panel</h2>
    <div id="adminList" class="space-y-4"></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, onSnapshot, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Random gradient
function randomGradient(){
  const colors=[
    "from-pink-200 via-purple-200 to-indigo-200",
    "from-green-200 via-teal-200 to-blue-200",
    "from-yellow-200 via-red-200 to-pink-200",
    "from-indigo-200 via-purple-200 to-pink-200"
  ];
  return "bg-gradient-to-r "+colors[Math.floor(Math.random()*colors.length)];
}

// Image Upload to imgbb
async function uploadImage(file){
  const form=new FormData();
  form.append("image",file);
  const res=await fetch("https://api.imgbb.com/1/upload?key=YOUR_IMGBB_KEY",{method:"POST",body:form});
  const data=await res.json();
  return data.data.display_url;
}

// Profile Form Submit
document.getElementById("profileForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const file=document.getElementById("photoInput").files[0];
  let photoUrl="";
  if(file) photoUrl=await uploadImage(file);

  await addDoc(collection(db,"profiles"),{
    name:fd.get("name"),
    age:fd.get("age"),
    birthdate:fd.get("birthdate"),
    postingDate:fd.get("postingDate"),
    address:fd.get("address"),
    whatsapp:fd.get("whatsapp"),
    photoUrl,
    approvals:{}, // Admin will approve
    likes:[]
  });
  e.target.reset();
  alert("✅ Profile submitted for approval!");
});

// Render Public Profiles
function renderProfiles(profiles){
  const postsList=document.getElementById("postsList");
  postsList.innerHTML="";
  profiles.forEach(p=>{
    if(!p.approvals) return;
    const approvedFields=Object.keys(p.approvals).filter(f=>p.approvals[f]);
    if(approvedFields.length===0) return;

    const card=document.createElement("div");
    card.className="p-4 rounded shadow "+randomGradient();

    let html=`<div>`;
    if(p.approvals.photoUrl && p.photoUrl) html+=`<img src="${p.photoUrl}" class="w-40 h-48 object-cover rounded border mb-2">`;
    if(p.approvals.name) html+=`<p><strong>👤 Name:</strong> ${p.name}</p>`;
    if(p.approvals.age) html+=`<p><strong>🎂 Age:</strong> ${p.age}</p>`;
    if(p.approvals.birthdate) html+=`<p><strong>📅 Birth Date:</strong> ${p.birthdate}</p>`;
    if(p.approvals.postingDate) html+=`<p><strong>🗓 Posting Date:</strong> ${p.postingDate}</p>`;
    if(p.approvals.address) html+=`<p><strong>🏠 Address:</strong> ${p.address}</p>`;
    if(p.approvals.whatsapp) html+=`<p><strong>📱 WhatsApp:</strong> ${p.whatsapp}</p>`;
    html+=`</div>`;
    html+=`<button class="bg-red-500 text-white px-3 py-1 mt-2 rounded likeBtn">❤️ Like & Contact</button>`;
    card.innerHTML=html;
    postsList.appendChild(card);

    // Like Button Click
    card.querySelector(".likeBtn").addEventListener("click",()=>{
      const likeName=prompt("Enter Your Name:");
      if(!likeName) return;
      updateDoc(doc(db,"profiles",p.id),{
        likes:arrayUnion({name:likeName,timestamp:serverTimestamp()})
      }).then(()=>{
        const waUrl=`https://wa.me/9112170192?text=Hello,%20I%20liked%20your%20profile%20on%20Nikah%20Portal!`;
        window.open(waUrl,"_blank");
        alert("✅ Like submitted! WhatsApp opened.");
      });
    });
  });
}

// Render Admin Panel
function renderAdmin(profiles){
  const adminList=document.getElementById("adminList");
  adminList.innerHTML="";
  profiles.forEach(p=>{
    const card=document.createElement("div");
    card.className="bg-white p-4 rounded shadow";
    let html=`<h3 class="font-semibold">Profile: ${p.name||""}</h3>`;
    html+=`<img src="${p.photoUrl}" class="w-40 h-48 object-cover rounded border mb-2">`;

    ["name","age","birthdate","postingDate","address","whatsapp","photoUrl"].forEach(f=>{
      const checked=p.approvals&&p.approvals[f];
      html+=`<label class="block"><input type="checkbox" class="approveField" data-id="${p.id}" data-field="${f}" ${checked?"checked":""}/> ${f}: ${p[f]||""}</label>`;
    });

    if(p.likes && p.likes.length>0){
      html+=`<div class="mt-2"><strong>Likes:</strong>`;
      p.likes.forEach(l=>{
        html+=`<p>👍 ${l.name||""} <a href="https://wa.me/9112170192" target="_blank" class="text-green-600 font-bold">WhatsApp</a></p>`;
      });
      html+=`</div>`;
    }

    card.innerHTML=html;
    adminList.appendChild(card);

    card.querySelectorAll(".approveField").forEach(cb=>{
      cb.addEventListener("change",async()=>{
        const fid=cb.dataset.id;
        const f=cb.dataset.field;
        await updateDoc(doc(db,"profiles",fid),{
          [`approvals.${f}`]:cb.checked
        });
      });
    });
  });
}

// Live Snapshot
onSnapshot(collection(db,"profiles"),snap=>{
  const profiles=snap.docs.map(d=>({id:d.id,...d.data()}));
  renderProfiles(profiles);
  renderAdmin(profiles);
});
</script>
</body>
</html>
