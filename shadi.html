<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üíç Nikah Portal</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background: #f0f4f8; font-family: sans-serif; }
.card-text { overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
.popup { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:50; }
.popup-content { background:white; padding:20px; border-radius:12px; max-width:500px; width:90%; text-align:center; position:relative; overflow-y:auto; max-height:80%; }
.whatsapp-btn { background:#25D366; color:white; padding:10px 20px; border-radius:12px; text-decoration:none; display:inline-block; font-weight:bold; transition: transform 0.2s; }
.whatsapp-btn:hover { transform: translateY(-3px); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
</style>
</head>
<body class="text-gray-800">

<header class="bg-blue-600 p-4 flex justify-between items-center text-white">
  <h1 class="text-2xl font-bold">üíç Nikah Portal</h1>
  <div>
    <button id="loginBtn" class="bg-green-500 px-3 py-1 rounded">Login</button>
    <button id="postBtn" class="bg-yellow-500 px-3 py-1 rounded hidden">‚ûï Post</button>
  </div>
</header>

<section id="postSection" class="hidden p-4 bg-white rounded m-4 shadow">
  <h2 class="font-bold text-lg mb-2">Post Your Profile</h2>
  <input id="name" class="w-full p-2 border rounded mb-2" placeholder="Full Name"/>
  <input id="age" type="number" class="w-full p-2 border rounded mb-2" placeholder="Age"/>
  <input id="gender" class="w-full p-2 border rounded mb-2" placeholder="Male/Female"/>
  <input id="address" class="w-full p-2 border rounded mb-2" placeholder="Full Address"/>
  <input id="education" class="w-full p-2 border rounded mb-2" placeholder="Education"/>
  <input id="profession" class="w-full p-2 border rounded mb-2" placeholder="Profession"/>
  <select id="status" class="w-full p-2 border rounded mb-2">
    <option value="">Marital Status</option>
    <option value="Single">Single</option>
    <option value="Married">Married</option>
    <option value="Divorced">Divorced</option>
    <option value="Widowed">Widowed</option>
  </select>
  <input id="children" class="w-full p-2 border rounded mb-2" placeholder="Number of Children (if any)"/>
  <input id="family" class="w-full p-2 border rounded mb-2" placeholder="Family Details"/>
  <input id="income" class="w-full p-2 border rounded mb-2" placeholder="Income"/>
  <input id="mobile" class="w-full p-2 border rounded mb-2" placeholder="WhatsApp Number"/>
  <input id="photo" type="file" class="w-full p-2 border rounded mb-2"/>
  <input id="aadhaar" type="file" class="w-full p-2 border rounded mb-2"/>
  <button id="submitPost" class="bg-purple-600 px-4 py-2 rounded text-white">Submit Profile</button>
</section>

<main id="postsList" class="p-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></main>

<div id="popup" class="popup hidden">
  <div class="popup-content">
    <p id="popupText" class="font-bold text-lg mb-2"></p>
    <p id="popupMeta" class="text-sm mb-1"></p>
    <p id="popupStatus" class="text-sm font-semibold mb-2"></p>
    <p id="popupDetails" class="text-sm mb-2"></p>
    <a id="popupWhatsapp" href="#" target="_blank" class="whatsapp-btn">WhatsApp</a>
    <button id="closePopup" class="bg-red-500 px-3 py-1 rounded text-white mt-2">‚ùå Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, onSnapshot, updateDoc, doc, orderBy, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:e387e1297663f11fc2463b"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const loginBtn=document.getElementById("loginBtn");
const postBtn=document.getElementById("postBtn");
const postSection=document.getElementById("postSection");
const submitPost=document.getElementById("submitPost");
const postsList=document.getElementById("postsList");

let currentUser=null;
const adminEmail="zaradigitalseva@gmail.com";
const imgbbKey="d12c2e4a8650157b2b6b9fe85336ea43";

loginBtn.addEventListener("click",async()=>{
  const provider=new GoogleAuthProvider();
  await signInWithPopup(auth,provider);
});

onAuthStateChanged(auth,user=>{
  currentUser=user;
  if(user){
    loginBtn.classList.add("hidden");
    postBtn.classList.remove("hidden");
  } else {
    loginBtn.classList.remove("hidden");
    postBtn.classList.add("hidden");
    postSection.classList.add("hidden");
  }
});

postBtn.addEventListener("click",()=>{
  if(currentUser) postSection.classList.toggle("hidden");
  else alert("‚ö†Ô∏è Please login!");
});

async function uploadImage(file){
  if(!file) return "";
  const formData=new FormData();
  formData.append("image",file);
  const res=await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`,{
    method:"POST",
    body:formData
  });
  const data=await res.json();
  return data.data.url;
}

submitPost.addEventListener("click",async()=>{
  const name=document.getElementById("name").value.trim();
  const age=document.getElementById("age").value.trim();
  const gender=document.getElementById("gender").value.trim();
  const address=document.getElementById("address").value.trim();
  const education=document.getElementById("education").value.trim();
  const profession=document.getElementById("profession").value.trim();
  const status=document.getElementById("status").value.trim();
  const children=document.getElementById("children").value.trim();
  const family=document.getElementById("family").value.trim();
  const income=document.getElementById("income").value.trim();
  const mobile=document.getElementById("mobile").value.trim();
  const photo=document.getElementById("photo").files[0];
  const aadhaar=document.getElementById("aadhaar").files[0];

  if(!name||!age||!gender) return alert("Name, Age, Gender required!");

  const photoUrl=await uploadImage(photo);
  const aadhaarUrl=await uploadImage(aadhaar);

  await addDoc(collection(db,"profiles"),{
    name, age, gender, address, education, profession, status, children, family, income, mobile,
    photoUrl, aadhaarUrl,
    uid:currentUser.uid, email:currentUser.email, approved:false,
    created:serverTimestamp()
  });

  alert("‚úÖ Submitted! Wait for admin approval.");
});

const q=query(collection(db,"profiles"),orderBy("created","desc"));
onSnapshot(q,(snapshot)=>{
  postsList.innerHTML="";
  snapshot.forEach(docSnap=>{
    const data=docSnap.data();
    const postId=docSnap.id;

    if(!data.approved && !(currentUser && (currentUser.email===data.email || currentUser.email===adminEmail))) return;

    const card=document.createElement("div");
    card.className="p-4 rounded shadow cursor-pointer bg-white flex flex-col justify-between";
    card.style.border="2px solid #"+Math.floor(Math.random()*16777215).toString(16);
    card.innerHTML=`
      <p class="font-bold text-lg card-text">${data.name} (${data.age})</p>
      <p class="text-sm">${data.gender} | ${data.address}</p>
      <p class="text-xs">Status: ${data.status} | Children: ${data.children}</p>
    `;

    if(currentUser && (currentUser.email===data.email || currentUser.email===adminEmail)){
      const delBtn=document.createElement("button");
      delBtn.textContent="üóëÔ∏è Delete";
      delBtn.className="bg-red-500 text-white px-2 py-1 rounded mt-2 self-start";
      delBtn.onclick=async e=>{
        e.stopPropagation();
        await updateDoc(doc(db,"profiles",postId),{approved:false});
      };
      card.appendChild(delBtn);
    }

    if(currentUser && currentUser.email===adminEmail && !data.approved){
      const approveBtn=document.createElement("button");
      approveBtn.textContent="‚úÖ Approve";
      approveBtn.className="bg-green-500 text-white px-2 py-1 rounded mt-2 self-start";
      approveBtn.onclick=async e=>{
        e.stopPropagation();
        await updateDoc(doc(db,"profiles",postId),{approved:true});
      };
      const rejectBtn=document.createElement("button");
      rejectBtn.textContent="‚ùå Reject";
      rejectBtn.className="bg-gray-500 text-white px-2 py-1 rounded mt-2 self-start";
      rejectBtn.onclick=async e=>{
        e.stopPropagation();
        await updateDoc(doc(db,"profiles",postId),{approved:false});
      };
      card.appendChild(approveBtn);
      card.appendChild(rejectBtn);
    }

    card.addEventListener("click",()=>{
      document.getElementById("popupText").textContent=data.name+" ("+data.age+")";
      document.getElementById("popupMeta").textContent=`${data.gender} | ${data.address}`;
      document.getElementById("popupStatus").textContent=data.approved?"‚úÖ Approved":"‚è≥ Pending";
      document.getElementById("popupDetails").innerHTML=`
        <p>Education: ${data.education}</p>
        <p>Profession: ${data.profession}</p>
        <p>Status: ${data.status}</p>
        <p>Children: ${data.children}</p>
        <p>Family: ${data.family}</p>
        <p>Income: ${data.income}</p>
        <p>Mobile: <a href="https://wa.me/9112170192" target="_blank" class="whatsapp-btn">WhatsApp</a></p>
      `;
      document.getElementById("popup").classList.remove("hidden");
    });

    postsList.appendChild(card);
  });
});

document.getElementById("closePopup").addEventListener("click",()=>{
  document.getElementById("popup").classList.add("hidden");
});
</script>
</body>
</html>
