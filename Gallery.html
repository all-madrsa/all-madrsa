<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gallery | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f1f5f9; }
.btn-3d { background:linear-gradient(90deg,#4d94ff,#4dffb8); color:#fff; font-weight:700; border-radius:10px; padding:.35rem .7rem; font-size:.85rem;
box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 10px rgba(0,0,0,.2);
transition: transform .12s ease, box-shadow .12s ease, filter .12s; cursor:pointer;}
.btn-3d:hover{filter:brightness(1.1); transform:translateY(-2px);}
.header-png{height:50px;width:50px;border-radius:50%;object-fit:cover;}
.gallery-img{cursor:pointer;transition:transform .2s;}
.gallery-img:hover{transform:scale(1.05);}
#lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:50;align-items:center;justify-content:center;}
#lightbox img{max-height:90%;max-width:90%;border-radius:.5rem;box-shadow:0 0 20px rgba(0,0,0,.6);}
#lightbox button{position:absolute;top:20px;right:20px;background:#f44336;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;}
.admin-btn{display:inline-block;margin:2px;padding:2px 6px;border-radius:5px;font-size:0.7rem;color:#fff;cursor:pointer;}
.admin-edit{background:#1d4ed8;}
.admin-delete{background:#dc2626;}
.notice-bar{background:#004080;color:white;padding:6px 10px;overflow:hidden;white-space:nowrap;}
.notice-text{display:inline-block;padding-left:100%;animation:scroll-left 15s linear infinite;}
.upload-area{border:2px dashed #4d94ff;padding:20px;text-align:center;border-radius:10px;cursor:pointer;transition:0.3s;}
.upload-area.dragover{background:#e0f7ff;}
.progress-bar{height:6px;background:#4d94ff;border-radius:3px;margin-top:5px;transition:width 0.2s;}
@keyframes scroll-left{0%{transform:translateX(0%);}100%{transform:translateX(-100%);}}
</style>
</head>
<body>

<header class="bg-blue-600" style="height:100px;">
  <div class="max-w-6xl mx-auto px-4 py-2 h-full flex flex-col justify-between">
    <div class="flex justify-center gap-2">
      <a href="index.html"><button class="btn-3d">üè† Home</button></a>
      <a href="nikah.html"><button class="btn-3d">üíç Nikah</button></a>
      <a href="news.html"><button class="btn-3d">üì∞ News</button></a>
    </div>
    <div class="flex justify-between items-center h-full mt-1">
      <img src="makka.png" alt="Makka" class="header-png">
      <div class="text-white font-bold text-2xl" style="text-shadow:2px 2px 8px rgba(0,0,0,.9); transform:translateY(-8px);">Talimi Ittehad</div>
      <img src="madina.png" alt="Madina" class="header-png">
    </div>
  </div>
</header>

<div class="notice-bar">
  <div id="noticeText" class="notice-text">Loading notices...</div>
</div>

<!-- Admin Upload -->
<div id="adminUpload" class="hidden mb-6 border p-3 rounded bg-white shadow max-w-md mx-auto mt-4">
  <h2 class="font-semibold mb-2">üñº Upload New Gallery Post</h2>
  <div id="uploadArea" class="upload-area mb-2">Drag & Drop Images Here or Click to Select</div>
  <input id="galleryFiles" type="file" accept="image/*" multiple class="hidden"/>
  <input id="galleryText" type="text" placeholder="Post Caption" class="mb-2 w-full rounded border p-1"/>
  <div class="w-full bg-gray-300 rounded overflow-hidden mb-2"><div id="progress" class="progress-bar w-0"></div></div>
  <button id="uploadBtn" class="btn-3d w-full py-2">Upload</button>
</div>

<main class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">üì∏ Gallery</h1>
  <div id="galleryGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
  <p id="emptyMsg" class="text-gray-500 text-sm mt-4 hidden">‚ö†Ô∏è No images uploaded yet.</p>
</main>

<div id="lightbox" class="flex">
  <img src="" alt="preview" id="lightbox-img">
  <button id="closeLightbox">‚úñ</button>
</div>

<footer class="bg-gray-100 text-center py-4 mt-10">
  <p class="text-xs text-gray-500">¬© 2025 Talimi Ittehad</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e387e1297663b11fc2463b"
};

const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
const IMGBB_API_KEY = "396fbc779807e34e4131a8a8e48ad03c";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const galleryDiv = document.getElementById("galleryGrid");
const uploadBtn = document.getElementById("uploadBtn");
const galleryText = document.getElementById("galleryText");
const emptyMsg = document.getElementById("emptyMsg");
const adminBox = document.getElementById("adminUpload");
const uploadArea = document.getElementById("uploadArea");
const galleryFiles = document.getElementById("galleryFiles");
const progressBar = document.getElementById("progress");

let currentUser = null;

// Base64 convert
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result.split(",")[1]);
    reader.onerror=e=>reject(e);
    reader.readAsDataURL(file);
  });
}

// Upload to ImgBB
async function uploadToImgBB(file){
  const base64 = await toBase64(file);
  const fd = new FormData();
  fd.append("image", base64);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:fd});
  const data = await res.json();
  if(data.success) return data.data.url;
  else throw new Error("Upload failed");
}

// Load Gallery
async function loadGallery(){
  galleryDiv.innerHTML="";
  const q=query(collection(db,"gallery"),orderBy("createdAt","desc"));
  const snap=await getDocs(q);
  if(snap.empty){ emptyMsg.classList.remove("hidden"); }
  else{
    emptyMsg.classList.add("hidden");
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const wrapper=document.createElement("div");
      wrapper.className="relative group";

      const img=document.createElement("img");
      img.src=d.url;
      img.className="gallery-img rounded shadow w-full";
      img.onclick=()=>{ document.getElementById("lightbox").style.display="flex"; document.getElementById("lightbox-img").src=d.url; };
      wrapper.appendChild(img);

      if(d.text){
        const caption=document.createElement("div");
        caption.textContent=d.text;
        caption.className="text-center text-sm mt-1 text-gray-700";
        wrapper.appendChild(caption);
      }

      if(currentUser && currentUser.email===ADMIN_EMAIL){
        const btnWrapper = document.createElement("div");
        btnWrapper.className = "flex justify-center gap-1 mt-1";

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "admin-btn admin-delete";
        delBtn.onclick = async()=>{
          if(confirm("Are you sure you want to delete this image?")){
            await deleteDoc(doc(db,"gallery",docSnap.id));
            loadGallery();
          }
        };
        btnWrapper.appendChild(delBtn);

        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "admin-btn admin-edit";
        editBtn.onclick = async()=>{
          const newText = prompt("Update caption:", d.text || "");
          if(newText !== null){
            await updateDoc(doc(db,"gallery",docSnap.id),{text:newText});
            loadGallery();
          }
        };
        btnWrapper.appendChild(editBtn);

        wrapper.appendChild(btnWrapper);
      }

      galleryDiv.appendChild(wrapper);
    });
  }
}

// File select/drag-drop
uploadArea.addEventListener("click",()=>galleryFiles.click());
uploadArea.addEventListener("dragover", e=>{ e.preventDefault(); uploadArea.classList.add("dragover"); });
uploadArea.addEventListener("dragleave", e=>{ e.preventDefault(); uploadArea.classList.remove("dragover"); });
uploadArea.addEventListener("drop", e=>{
  e.preventDefault(); uploadArea.classList.remove("dragover");
  galleryFiles.files = e.dataTransfer.files;
});

// Upload Images Sequentially
uploadBtn.onclick=async()=>{
  const files = Array.from(galleryFiles.files);
  if(files.length===0) return alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç!");
  const text=galleryText.value.trim();
  uploadBtn.textContent="‚è≥ Uploading...";
  progressBar.style.width="0%";
  try{
    for(let i=0;i<files.length;i++){
      const url = await uploadToImgBB(files[i]);
      await addDoc(collection(db,"gallery"),{url,text,createdAt
