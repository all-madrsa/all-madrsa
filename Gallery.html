<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gallery & Notice | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f1f5f9; }

/* Notice Bar */
#noticeBar {
  width: 100%;
  background: #fffae6;
  overflow: hidden;
  border-bottom: 2px solid #facc15;
  white-space: nowrap;
  position: relative;
  padding: 5px 0;
}
#noticeContent {
  display: inline-block;
  white-space: nowrap;
  padding-left: 100%;
  will-change: transform;
}
.notice-item {
  display: inline-block;
  margin-right: 50px;
  font-weight: bold;
  color: #b45309;
}
.notice-edit-btn {
  margin-left:5px;
  background:#dc2626;
  color:#fff;
  border:none;
  padding:2px 5px;
  border-radius:3px;
  cursor:pointer;
  font-size:0.7rem;
}

/* Gallery */
.gallery-img { cursor:pointer; transition:transform .2s; width:100%; border-radius:5px; }
.gallery-item { position: relative; }
.gallery-admin-btn { position: absolute; top:5px; right:5px; display:flex; gap:3px; flex-direction: column; }
.gallery-admin-btn button { font-size:0.7rem; padding:2px 5px; border-radius:3px; }

/* Lightbox */
#lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:50; align-items:center; justify-content:center; }
#lightbox img { max-height:90%; max-width:90%; border-radius:.5rem; box-shadow:0 0 20px rgba(0,0,0,.6); }
#lightbox button { position:absolute; top:20px; right:20px; background:#f44336; color:#fff; padding:6px 12px; border-radius:6px; }
</style>
</head>
<body>

<!-- Notice Bar -->
<div id="noticeBar">
  <div id="noticeContent"></div>
</div>

<!-- Admin Panel -->
<div id="adminBox" class="hidden p-3 bg-white max-w-md mx-auto mt-3 rounded shadow">
  <h2 class="font-bold mb-2">Admin Panel</h2>

  <!-- Notice Add -->
  <input type="text" id="noticeInput" placeholder="Add new notice" class="border p-1 mb-2 w-full rounded"/>
  <button id="addNoticeBtn" class="bg-blue-600 text-white px-3 py-1 rounded mb-3 w-full">Add Notice</button>

  <!-- Gallery Upload -->
  <input type="file" id="galleryFiles" accept="image/*" multiple class="border p-1 mb-2 w-full rounded"/>
  <input type="text" id="galleryText" placeholder="Gallery caption" class="border p-1 mb-2 w-full rounded"/>
  <button id="uploadBtn" class="bg-green-600 text-white px-3 py-1 rounded w-full">Upload Gallery</button>

  <div id="errorMsg" class="text-red-600 mt-2"></div>
</div>

<!-- Gallery -->
<main class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">üì∏ Gallery</h1>
  <div id="galleryGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
</main>

<!-- Lightbox -->
<div id="lightbox" class="flex">
  <img src="" alt="preview" id="lightbox-img">
  <button id="closeLightbox">‚úñ</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  databaseURL:"https://all-madrsa-default-rtdb.firebaseio.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e387e1297663b11fc2463b11fc2463b"
};

const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
const IMGBB_API_KEY = "396fbc779807e34e4131a8a8e48ad03c";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const noticeContent = document.getElementById("noticeContent");
const adminBox = document.getElementById("adminBox");
const noticeInput = document.getElementById("noticeInput");
const addNoticeBtn = document.getElementById("addNoticeBtn");
const galleryFiles = document.getElementById("galleryFiles");
const galleryText = document.getElementById("galleryText");
const uploadBtn = document.getElementById("uploadBtn");
const galleryGrid = document.getElementById("galleryGrid");
const errorMsg = document.getElementById("errorMsg");

let currentUser = null;

// Convert file to base64
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result.split(",")[1]);
    reader.onerror=e=>reject(e);
    reader.readAsDataURL(file);
  });
}

// ImgBB upload
async function uploadToImgBB(file){
  const base64 = await toBase64(file);
  const fd = new FormData();
  fd.append("image", base64);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:fd});
  const data = await res.json();
  if(data.success) return data.data.url;
  else throw new Error("ImgBB upload failed");
}

// Load Notices
async function loadNotices(){
  noticeContent.innerHTML = "";
  const q = query(collection(db,"notices"),orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  if(snap.empty){ noticeContent.textContent="No notices yet."; return; }
  snap.docs.forEach(docSnap=>{
    const d = docSnap.data();
    const span = document.createElement("span");
    span.className="notice-item";
    span.textContent=d.text;

    if(currentUser?.email===ADMIN_EMAIL){
      const editBtn = document.createElement("button");
      editBtn.textContent="‚úèÔ∏è";
      editBtn.className="notice-edit-btn";
      editBtn.onclick=async()=>{
        const newText = prompt("Edit notice:", d.text);
        if(newText!==null){ await updateDoc(doc(db,"notices",docSnap.id),{text:newText}); loadNotices(); }
      };
      const delBtn = document.createElement("button");
      delBtn.textContent="üóë";
      delBtn.className="notice-edit-btn";
      delBtn.onclick=async()=>{ if(confirm("Delete this notice?")){ await deleteDoc(doc(db,"notices",docSnap.id)); loadNotices(); } };
      span.appendChild(editBtn); span.appendChild(delBtn);
    }

    noticeContent.appendChild(span);
  });

  // Scroll animation
  const totalWidth = noticeContent.scrollWidth;
  const parentWidth = noticeContent.parentElement.offsetWidth;
  const duration = Math.max(totalWidth/50,10);
  noticeContent.style.transition = `transform ${duration}s linear`;
  noticeContent.style.transform = `translateX(${parentWidth}px)`;
  let start = null;
  function step(timestamp){
    if(!start) start = timestamp;
    const progress = timestamp-start;
    const x = parentWidth - (progress*50)/1000;
    noticeContent.style.transform = `translateX(${x}px)`;
    if(x + totalWidth > 0) requestAnimationFrame(step);
    else noticeContent.style.transform = `translateX(${parentWidth}px)` , requestAnimationFrame(step);
  }
  noticeContent.onmouseenter = ()=> noticeContent.style.transition="none";
  noticeContent.onmouseleave = ()=> { noticeContent.style.transition = `transform ${duration}s linear`; requestAnimationFrame(step); };
  requestAnimationFrame(step);
}

// Add Notice
addNoticeBtn.onclick=async()=>{
  const text = noticeInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,"notices"),{text,createdAt:serverTimestamp()});
  noticeInput.value="";
  loadNotices();
}

// Load Gallery
async function loadGallery(){
  galleryGrid.innerHTML="";
  const q = query(collection(db,"gallery"),orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  snap.forEach(docSnap=>{
    const d = docSnap.data();
    if(d.url){
      const wrapper = document.createElement("div");
      wrapper.className="gallery-item";

      const img = document.createElement("img");
      img.src=d.url;
      img.className="gallery-img";
      img.onclick=()=>{ document.getElementById("lightbox").style.display="flex"; document.getElementById("lightbox-img").src=d.url; };

      wrapper.appendChild(img);

      if(d.text){
        const cap = document.createElement("div");
        cap.textContent=d.text;
        cap.className="text-center text-sm mt-1";
        wrapper.appendChild(cap);
      }

      if(currentUser?.email===ADMIN_EMAIL){
        const btnDiv = document.createElement("div"); btnDiv.className="gallery-admin-btn";
        const editBtn=document.createElement("button"); editBtn.textContent="‚úèÔ∏è"; editBtn.onclick=async()=>{
          const newText=prompt("Edit caption:", d.text||"");
          if(newText!==null){ await updateDoc(doc(db,"gallery",docSnap.id),{text:newText}); loadGallery(); }
        };
        const delBtn=document.createElement("button"); delBtn.textContent="üóë"; delBtn.onclick=async()=>{
          if(confirm("Delete this image?")){ await deleteDoc(doc(db,"gallery",docSnap.id)); loadGallery(); }
        };
        btnDiv.appendChild(editBtn); btnDiv.appendChild(delBtn);
        wrapper.appendChild(btnDiv);
      }

      galleryGrid.appendChild(wrapper);
    }
  });
}

// Upload Gallery
uploadBtn.onclick=async()=>{
  const files = galleryFiles.files;
  if(!files.length) return alert("Select at least one file!");
  try{
    const urls = await Promise.all(Array.from(files).map(f=>uploadToImgBB(f)));
    await Promise.all(urls.map(url=>addDoc(collection(db,"gallery"),{url,text:galleryText.value,createdAt:serverTimestamp()})));
    galleryText.value=""; galleryFiles.value="";
    loadGallery();
  }catch(e){ errorMsg.textContent="Upload failed: "+e.message; }
}

// Auth check
onAuthStateChanged(auth,user=>{
  currentUser = user;
  if(user?.email===ADMIN_EMAIL) adminBox.classList.remove("hidden");
  else adminBox.classList.add("hidden");
  loadNotices(); loadGallery();
});

// Lightbox
document.getElementById("closeLightbox").onclick=()=>document.getElementById("lightbox").style.display="none";
document.getElementById("lightbox").onclick=e=>{ if(e.target.id==="lightbox") document.getElementById("lightbox").style.display="none"; };
document.addEventListener("keydown",e=>{ if(e.key==="Escape") document.getElementById("lightbox").style.display="none"; });
</script>

<!-- Donate -->
<a href="https://all-madrsa.netlify.app/upi" class="fixed top-1/2 right-4 transform -translate-y-1/2 bg-yellow-400 text-black font-bold px-5 py-3 rounded-lg shadow-lg hover:bg-yellow-300 z-50">üíù Donate</a>

</body>
</html>
