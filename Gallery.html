<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gallery & Notice | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f1f5f9; }

/* 3D Buttons */
.btn-3d, .btn-3d-home {
  color:#fff; font-weight:700; border-radius:10px; padding:.35rem .7rem; font-size:.85rem;
  box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 10px rgba(0,0,0,.2);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s; cursor:pointer;
}
.btn-3d:hover, .btn-3d-home:hover { filter:brightness(1.1); transform:translateY(-2px); box-shadow:0 6px 0 rgba(0,0,0,.25),0 8px 14px rgba(0,0,0,.25);}
.btn-3d:active, .btn-3d-home:active { transform:translateY(3px); box-shadow:0 3px 0 rgba(0,0,0,.25); }

/* Header Images */
.header-png { height:50px; width:50px; border-radius:50%; object-fit:cover; }

/* Gallery */
.gallery-img { cursor:pointer; transition:transform .2s; width:100%; }
.gallery-img:hover { transform:scale(1.05); }
.gallery-item { position:relative; }

/* Admin buttons on gallery */
.gallery-admin-btn { position:absolute; top:5px; right:5px; display:flex; gap:2px; }
.gallery-admin-btn button { background:#1d4ed8; color:#fff; border:none; border-radius:4px; padding:2px 6px; font-size:0.7rem; cursor:pointer; }
.gallery-admin-btn button.delete { background:#dc2626; }

/* Lightbox */
#lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:50; align-items:center; justify-content:center; }
#lightbox img { max-height:90%; max-width:90%; border-radius:.5rem; box-shadow:0 0 20px rgba(0,0,0,.6); }
#lightbox button { position:absolute; top:20px; right:20px; background:#f44336; color:#fff; padding:6px 12px; border-radius:6px; font-size:16px; }

/* Notice bar */
#noticeBar { width:100%; background:#fffae5; color:#333; overflow:hidden; white-space:nowrap; position:relative; height:30px; display:flex; align-items:center; }
#noticeText { display:inline-block; padding-left:100%; animation:scrollNotice linear infinite; }
#noticeBar:hover #noticeText { animation-play-state:paused; }
@keyframes scrollNotice { 0% { transform:translateX(0%);} 100% { transform:translateX(-100%);} }

/* Admin notice buttons */
.notice-admin-btn { margin-left:10px; font-size:0.8rem; padding:2px 6px; border:none; border-radius:4px; cursor:pointer; }
.notice-admin-btn.edit { background:#1d4ed8; color:white; }
.notice-admin-btn.delete { background:#dc2626; color:white; }

/* Upload form */
.admin-upload { display:none; margin:10px auto; padding:10px; background:white; border-radius:8px; max-width:600px; box-shadow:0 2px 6px rgba(0,0,0,.2); }
.admin-upload input, .admin-upload button { margin:4px 0; width:100%; padding:6px; border-radius:4px; border:1px solid #ccc; }
.admin-upload button { background:#4d94ff; color:white; border:none; cursor:pointer; }

</style>
</head>
<body>

<!-- Header -->
<header class="bg-blue-600 p-2 flex justify-center gap-2">
  <a href="index.html"><button class="btn-3d-home">üè† Home</button></a>
  <a href="gallery.html"><button class="btn-3d" style="background:linear-gradient(90deg,#4d94ff,#4dffb8)">üì∏ Gallery</button></a>
</header>

<!-- Notice Bar -->
<div id="noticeBar"><span id="noticeText">Loading notices...</span></div>

<!-- Admin Upload -->
<div class="admin-upload" id="adminBox">
  <h3 class="font-bold">Admin Upload</h3>
  <input type="text" id="noticeInput" placeholder="Enter notice text">
  <button id="addNoticeBtn">Add Notice</button>
  <input type="file" id="galleryFiles" multiple accept="image/*">
  <input type="text" id="galleryCaption" placeholder="Gallery caption">
  <button id="uploadGalleryBtn">Upload Gallery</button>
  <p id="errorMsg" class="text-red-600 text-sm"></p>
</div>

<!-- Gallery -->
<main class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">üì∏ Gallery</h1>
  <div id="galleryGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
  <p id="emptyMsg" class="text-gray-500 text-sm mt-4 hidden">‚ö†Ô∏è No images uploaded yet.</p>
</main>

<!-- Lightbox -->
<div id="lightbox" class="flex">
  <img src="" alt="preview" id="lightbox-img">
  <button id="closeLightbox">‚úñ</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  databaseURL:"https://all-madrsa-default-rtdb.firebaseio.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e387e1297663b11fc2463b"
};

const IMGBB_KEY="396fbc779807e34e4131a8a8e48ad03c";
const ADMIN_EMAIL="zaradigitalseva@gmail.com";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;

const galleryGrid = document.getElementById("galleryGrid");
const adminBox = document.getElementById("adminBox");
const emptyMsg = document.getElementById("emptyMsg");
const errorMsg = document.getElementById("errorMsg");
const noticeText = document.getElementById("noticeText");

// Convert file to base64
function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(",")[1]); r.onerror=e=>rej(e); r.readAsDataURL(file); }); }

// Upload image to ImgBB
async function uploadToImgBB(file){
  const base64 = await toBase64(file);
  const fd = new FormData();
  fd.append("image", base64);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`,{method:"POST",body:fd});
  const data = await res.json();
  if(data.success) return data.data.url;
  else throw new Error("ImgBB upload failed");
}

// Load gallery
async function loadGallery(){
  galleryGrid.innerHTML="";
  const q = query(collection(db,"gallery"),orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  if(snap.empty){ emptyMsg.classList.remove("hidden"); }
  else{ emptyMsg.classList.add("hidden"); snap.forEach(docSnap=>{
    const d = docSnap.data();
    if(d.url){
      const wrapper = document.createElement("div"); wrapper.className="gallery-item";
      const img = document.createElement("img"); img.src=d.url; img.className="gallery-img";
      img.onclick=()=>{ document.getElementById("lightbox").style.display="flex"; document.getElementById("lightbox-img").src=d.url; };
      wrapper.appendChild(img);

      if(d.text){ const cap=document.createElement("div"); cap.textContent=d.text; cap.className="text-center text-sm mt-1"; wrapper.appendChild(cap); }

      if(currentUser?.email===ADMIN_EMAIL){
        const btnDiv = document.createElement("div"); btnDiv.className="gallery-admin-btn";
        const editBtn=document.createElement("button"); editBtn.textContent="‚úèÔ∏è";
        editBtn.onclick=async()=>{ const newText=prompt("Edit caption:",d.text||""); if(newText!==null){ await updateDoc(doc(db,"gallery",docSnap.id),{text:newText}); loadGallery(); }};
        const delBtn=document.createElement("button"); delBtn.textContent="üóë"; delBtn.className="delete";
        delBtn.onclick=async()=>{ if(confirm("Delete this image?")){ await deleteDoc(doc(db,"gallery",docSnap.id)); loadGallery(); }};
        btnDiv.appendChild(editBtn); btnDiv.appendChild(delBtn); wrapper.appendChild(btnDiv);
      }

      galleryGrid.appendChild(wrapper);
    }
  });}
}

// Load notices
async function loadNotices(){
  const q = query(collection(db,"notices"),orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  if(snap.empty){ noticeText.textContent="No notices."; return; }
  let texts = [];
  snap.forEach(docSnap=>{ const d=docSnap.data(); let txt=d.text; if(currentUser?.email===ADMIN_EMAIL){ txt+=" "; /* Admin edit/delete buttons can be added later */ } texts.push(txt); });
  noticeText.textContent = texts.join(" ‚ö° ");
}

// Upload gallery
document.getElementById("uploadGalleryBtn").onclick=async()=>{
  const files = document.getElementById("galleryFiles").files;
  const text = document.getElementById("galleryCaption").value;
  if(!files.length){ errorMsg.textContent="Select at least one file!"; return; }
  errorMsg.textContent="";
  try{
    const urls = await Promise.all(Array.from(files).map(f=>uploadToImgBB(f)));
    await Promise.all(urls.map(url=>addDoc(collection(db,"gallery"),{url,text,createdAt:serverTimestamp()})));
    document.getElementById("galleryCaption").value=""; document.getElementById("galleryFiles").value="";
    loadGallery();
  }catch(e){ errorMsg.textContent="Upload failed: "+e.message; }
}

// Add notice
document.getElementById("addNoticeBtn").onclick=async()=>{
  const text=document.getElementById("noticeInput").value.trim();
  if(!text){ errorMsg.textContent="Enter notice text"; return; }
  errorMsg.textContent="";
  await addDoc(collection(db,"notices"),{text,createdAt:serverTimestamp()});
  document.getElementById("noticeInput").value="";
  loadNotices();
}

// Auth state
onAuthStateChanged(auth,user=>{
  currentUser=user;
  if(user?.email===ADMIN_EMAIL) adminBox.style.display="block"; else adminBox.style.display="none";
  loadGallery(); loadNotices();
});

// Lightbox
document.getElementById("closeLightbox").onclick=()=>document.getElementById("lightbox").style.display="none";
document.getElementById("lightbox").onclick=e=>{ if(e.target.id==="lightbox") document.getElementById("lightbox").style.display="none"; };
document.addEventListener("keydown",e=>{ if(e.key==="Escape") document.getElementById("lightbox").style.display="none"; });

</script>

<!-- Donate Button -->
<a href="https://all-madrsa.netlify.app/upi" class="fixed top-1/2 right-4 transform -translate-y-1/2 bg-yellow-400 text-black font-bold px-5 py-3 rounded-lg shadow-lg hover:bg-yellow-300 z-50">üíù Donate</a>

</body>
</html>
