<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gallery | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f1f5f9; }

/* 3D Button Base */
.btn-3d {
  color:#fff; font-weight:700; border-radius:10px; padding:.35rem .7rem; font-size:.85rem;
  box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 10px rgba(0,0,0,.2);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s; cursor:pointer;
}
.btn-3d:hover { filter:brightness(1.1); transform:translateY(-2px); box-shadow:0 6px 0 rgba(0,0,0,.25),0 8px 14px rgba(0,0,0,.25);}
.btn-3d:active { transform:translateY(3px); box-shadow:0 3px 0 rgba(0,0,0,.25); }

/* Header Images */
.header-png { height:50px; width:50px; border-radius:50%; object-fit:cover; }

/* Gallery */
.gallery-img { cursor:pointer; transition:transform .2s; }
.gallery-img:hover { transform:scale(1.05); }

#lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:50; align-items:center; justify-content:center; }
#lightbox img { max-height:90%; max-width:90%; border-radius:.5rem; box-shadow:0 0 20px rgba(0,0,0,.6); }
#lightbox button { position:absolute; top:20px; right:20px; background:#f44336; color:#fff; padding:6px 12px; border-radius:6px; }

#adminLoginBtn { display:block; margin:10px auto; background:#db4437; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; transition:all .15s; }
#adminLoginBtn:hover { filter:brightness(1.1); transform:translateY(-2px); }

.admin-btn { display:inline-block; margin:2px; padding:2px 6px; border-radius:5px; font-size:0.7rem; color:#fff; cursor:pointer; }
.admin-edit { background:#1d4ed8; }  /* Blue */
.admin-delete { background:#dc2626; } /* Red */

</style>
</head>
<body>

<!-- Header -->
<header class="bg-blue-600 p-2">
  <div class="max-w-6xl mx-auto flex flex-wrap justify-between items-center gap-2">

    <!-- Buttons + Home -->
    <div class="flex flex-wrap gap-2 justify-center">
      <a href="index.html"><button class="btn-3d">🏠 Home</button></a>
      <a href="nikah.html"><button class="btn-3d" style="background:linear-gradient(90deg,#ff4d4d,#ff914d);">💍 Nikah</button></a>
      <a href="news.html"><button class="btn-3d" style="background:linear-gradient(90deg,#4dffb8,#4d94ff);">📰 News</button></a>
      <a href="hadees.html"><button class="btn-3d" style="background:linear-gradient(90deg,#d24dff,#ff4dd2);">📜 Hadees</button></a>
    </div>

    <!-- Logo -->
    <div class="flex items-center gap-3">
      <img src="makka.png" alt="Makka" class="header-png">
      <div class="text-white font-bold text-xl" style="text-shadow:2px 2px 8px rgba(0,0,0,.9);">Talimi Ittehad</div>
      <img src="madina.png" alt="Madina" class="header-png">
    </div>
  </div>
</header>

<!-- Admin Login -->
<button id="adminLoginBtn">Login as Admin</button>

<main class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">📸 Gallery</h1>

  <!-- Admin Upload -->
  <div id="adminUpload" class="hidden mb-6 border p-3 rounded bg-white shadow max-w-md mx-auto">
    <h2 class="font-semibold mb-2">🖼 Upload New Gallery Images</h2>
    <input id="galleryFiles" type="file" accept="image/*" multiple class="mb-2 w-full rounded border p-1"/>
    <button id="uploadBtn" class="btn-3d w-full py-2" style="background:linear-gradient(90deg,#4d94ff,#4dffb8);">Upload</button>
  </div>

  <!-- Gallery Grid -->
  <div id="galleryGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
  <p id="emptyMsg" class="text-gray-500 text-sm mt-4 hidden">⚠️ No images uploaded yet.</p>
</main>

<!-- Lightbox -->
<div id="lightbox" class="flex">
  <img src="" alt="preview" id="lightbox-img">
  <button id="closeLightbox">✖</button>
</div>

<footer class="bg-gray-100 text-center py-4 mt-10">
  <p class="text-xs text-gray-500">© 2025 Talimi Ittehad</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  databaseURL:"https://all-madrsa-default-rtdb.firebaseio.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e387e1297663b11fc2463b"
};

const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
const IMGBB_API_KEY = "396fbc779807e34e4131a8a8e48ad03c";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const galleryDiv = document.getElementById("galleryGrid");
const adminBox = document.getElementById("adminUpload");
const uploadBtn = document.getElementById("uploadBtn");
const emptyMsg = document.getElementById("emptyMsg");
const adminLoginBtn = document.getElementById("adminLoginBtn");

let currentUser = null;

// Convert file → base64
function toBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result.split(",")[1]);reader.onerror=e=>reject(e);reader.readAsDataURL(file);});}

// Upload to ImgBB
async function uploadToImgBB(file){
  const base64 = await toBase64(file);
  const fd = new FormData();
  fd.append("image", base64);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:fd});
  const data = await res.json();
  if(data.success) return data.data.url;
  else throw new Error("ImgBB upload failed");
}

// Load gallery
async function loadGallery(){
  galleryDiv.innerHTML="";
  const snap = await getDocs(collection(db,"gallery"));
  if(snap.empty){ emptyMsg.classList.remove("hidden"); }
  else {
    emptyMsg.classList.add("hidden");
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      if(d.url){
        const wrapper = document.createElement("div");
        wrapper.className="relative group";

        const img = document.createElement("img");
        img.src = d.url;
        img.className="gallery-img rounded shadow w-full";
        img.onclick=()=>{ document.getElementById("lightbox").style.display="flex"; document.getElementById("lightbox-img").src=d.url; };
        wrapper.appendChild(img);

        if(currentUser?.email===ADMIN_EMAIL){
          // Edit Button
          const editBtn = document.createElement("button");
          editBtn.textContent="✏️";
          editBtn.className="admin-btn admin-edit absolute top-2 left-2 hidden group-hover:block";
          editBtn.onclick=async()=>{
            const newUrl = prompt("Enter new image URL:", d.url);
            if(newUrl){
              await updateDoc(doc(db,"gallery",docSnap.id),{url:newUrl});
              loadGallery();
            }
          };
          wrapper.appendChild(editBtn);

          // Delete Button
          const delBtn = document.createElement("button");
          delBtn.textContent="🗑";
          delBtn.className="admin-btn admin-delete absolute top-2 right-2 hidden group-hover:block";
          delBtn.onclick=async()=>{ if(confirm("Delete this image?")){ await deleteDoc(doc(db,"gallery",docSnap.id)); loadGallery(); }};
          wrapper.appendChild(delBtn);
        }

        galleryDiv.appendChild(wrapper);
      }
    });
  }
}

// Upload handler
uploadBtn.onclick = async ()=>{
  const files=document.getElementById("galleryFiles").files;
  if(!files.length)return alert("Select at least one file!");
  try{
    const uploads = Array.from(files).map(f=>uploadToImgBB(f));
    const urls = await Promise.all(uploads);
    const addDocs = urls.map(url=>addDoc(collection(db,"gallery"),{url,createdAt:serverTimestamp()}));
    await Promise.all(addDocs);
    document.getElementById("galleryFiles").value="";
    loadGallery();
  }catch(e){ alert("Upload failed: "+e.message); }
};

// Admin Login
adminLoginBtn.onclick=()=>signInWithPopup(auth,provider).catch(e=>alert("Login failed: "+e.message));

// Auth State
onAuthStateChanged(auth,user=>{
  currentUser=user;
  if(user?.email===ADMIN_EMAIL){ adminBox.classList.remove("hidden"); adminLoginBtn.style.display="none"; }
  else{ adminBox.classList.add("hidden"); adminLoginBtn.style.display="block"; }
  loadGallery();
});

// Lightbox
document.getElementById("closeLightbox").onclick=()=>document.getElementById("lightbox").style.display="none";
document.getElementById("lightbox").onclick=e=>{ if(e.target.id==="lightbox") document.getElementById("lightbox").style.display="none"; };
</script>

<!-- Fixed Donate Button -->
<a href="https://all-madrsa.netlify.app/upi" class="fixed top-1/2 right-4 transform -translate-y-1/2 bg-yellow-400 text-black font-bold px-5 py-3 rounded-lg shadow-lg hover:bg-yellow-300 z-50">💝 Donate</a>

</body>
</html>
