<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Donors | Talimi Ittehad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    .btn-3d {
      @apply px-3 py-1 rounded bg-purple-600 text-white text-sm font-semibold shadow-md hover:bg-purple-700;
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="bg-purple-700 text-white p-4 text-center font-bold text-xl">
    üïå Donor List - Talimi Ittehad
  </header>

  <!-- Admin login -->
  <div id="adminLogin" class="p-4 text-center hidden">
    <h2 class="text-lg font-bold mb-2">Admin Login</h2>
    <input id="adminEmail" type="email" placeholder="Email"
           class="border p-2 rounded w-64 mb-2">
    <input id="adminPass" type="password" placeholder="Password"
           class="border p-2 rounded w-64 mb-2">
    <button onclick="adminLogin()"
            class="bg-purple-600 text-white px-4 py-2 rounded shadow">
      Login
    </button>
  </div>

  <!-- Donor List -->
  <main class="p-4">
    <div id="donorList" class="grid md:grid-cols-3 gap-4"></div>
  </main>

  <script>
    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
      authDomain: "all-madrsa.firebaseapp.com",
      databaseURL: "https://all-madrsa-default-rtdb.firebaseio.com",
      projectId: "all-madrsa",
      storageBucket: "all-madrsa.appspot.com",
      messagingSenderId: "619313835874",
      appId: "1:619313835874:web:e387e1297663f11fc2463b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // üîë ‡§Ö‡§™‡§®‡§æ Admin Email ‡§Ø‡§π‡§æ‡§Ç ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
    const ADMIN_EMAIL = "zaradigitalseva@gmail.com";

    let currentUser = null;

    // Auth state check
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user && user.email === ADMIN_EMAIL) {
        adminLogin.classList.add("hidden");
        loadDonors();
      } else if (!user) {
        adminLogin.classList.remove("hidden");
        loadDonors(); // normal user ‡§ï‡•ã ‡§∏‡§ø‡§∞‡•ç‡§´ verified ‡§¶‡§ø‡§ñ‡•á
      } else {
        loadDonors(); // normal user logged in
      }
    });

    // Admin Login
    function adminLogin() {
      const email = document.getElementById("adminEmail").value;
      const pass = document.getElementById("adminPass").value;
      auth.signInWithEmailAndPassword(email, pass)
        .catch(err => alert(err.message));
    }

    // Donors List Load
    function loadDonors() {
      db.ref("site/donations").orderByChild("created").on("value", snapshot => {
        donorList.innerHTML = "";
        const donors = [];

        snapshot.forEach(child => {
          donors.push({ id: child.key, ...child.val() });
        });

        donors.reverse(); // latest first

        if (donors.length === 0) {
          donorList.innerHTML =
            "<p class='text-center text-gray-500 col-span-3'>No donors yet.</p>";
          return;
        }

        donors.forEach(d => {
          if (!currentUser || currentUser.email !== ADMIN_EMAIL) {
            if (!d.verified) return; // ‡§ï‡•á‡§µ‡§≤ verified ‡§¶‡§ø‡§ñ‡•á
          }

          const card = document.createElement("div");
          card.className = "bg-white rounded-lg shadow p-3";

          const dateStr = d.created
            ? new Date(Number(d.created) || Date.now()).toLocaleDateString("en-IN")
            : "";

          card.innerHTML = `
            ${d.screenshot ? `<img src="${d.screenshot}" class="w-full h-40 object-cover rounded mb-2"/>` : ""}
            <h2 class="font-bold text-lg">${d.name || "Anonymous"}</h2>
            <p class="text-sm text-gray-600">${d.address || ""}</p>
            <p class="mt-1">üí∞ <b>‚Çπ${d.amount || "-"}</b></p>
            <p class="text-xs text-gray-500">üìÖ ${dateStr}</p>
            <p class="text-sm ${d.verified ? 'text-green-600' : 'text-yellow-600'}">
              Status: ${d.verified ? "‚úÖ Verified" : "‚è≥ Pending"}
            </p>
          `;

          // Admin Controls
          if (currentUser && currentUser.email === ADMIN_EMAIL) {
            const btns = document.createElement("div");
            btns.className = "flex gap-2 mt-2";

            const verifyBtn = document.createElement("button");
            verifyBtn.textContent = "‚úÖ Verify";
            verifyBtn.className = "btn-3d";
            verifyBtn.onclick = () =>
              db.ref("site/donations/" + d.id).update({ verified: true });

            const rejectBtn = document.createElement("button");
            rejectBtn.textContent = "‚ùå Reject";
            rejectBtn.className = "btn-3d";
            rejectBtn.onclick = () =>
              db.ref("site/donations/" + d.id).update({ verified: false });

            btns.appendChild(verifyBtn);
            btns.appendChild(rejectBtn);
            card.appendChild(btns);
          }

          donorList.appendChild(card);
        });
      });
    }
  </script>
</body>
</html>
