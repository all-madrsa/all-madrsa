<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Donors | Talimi Ittehad</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="bg-purple-700 text-white p-4 text-center font-bold text-xl shadow">
    üßë‚Äçü§ù‚Äçüßë Donors List
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto p-4">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">All Donors</h2>
      <button id="authBtn" class="px-4 py-2 bg-purple-600 text-white rounded shadow hover:bg-purple-700">
        Login
      </button>
    </div>
    <div id="donorsList" class="space-y-3">
      ‚è≥ Loading donors...
    </div>
  </main>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { 
      getFirestore, collection, query, orderBy, onSnapshot, updateDoc, deleteDoc, doc 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ‚úÖ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
      authDomain: "all-madrsa.firebaseapp.com",
      projectId: "all-madrsa",
      storageBucket: "all-madrsa.appspot.com",
      messagingSenderId: "619313835874",
      appId: "1:619313835874:web:e387e1297663f11fc2463b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const donorsDiv = document.getElementById("donorsList");
    const authBtn = document.getElementById("authBtn");

    const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
    let currentUser = null;

    // üîê Auth Login/Logout
    authBtn.onclick = async () => {
      if (!auth.currentUser) {
        await signInWithPopup(auth, provider);
      } else {
        await signOut(auth);
      }
    };

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      authBtn.textContent = user ? "Logout" : "Login";
      loadDonors();
    });

    // üì• Load Donors
    function loadDonors() {
      donorsDiv.innerHTML = "‚è≥ Loading donors...";
      const qRef = query(
        collection(db, "site", "donations"),
        orderBy("created", "desc")
      );

      onSnapshot(qRef, (snap) => {
        if (snap.empty) {
          donorsDiv.innerHTML = "<p>No donors yet.</p>";
          return;
        }

        donorsDiv.innerHTML = "";
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          const donorCard = document.createElement("div");
          donorCard.className = "border bg-white p-3 rounded shadow";

          donorCard.innerHTML = `
            <h3 class="font-bold text-lg">${d.name || "Anonymous"}</h3>
            <p class="text-sm text-gray-600">${d.address || ""}</p>
            <p class="text-sm">üí∞ Amount: ‚Çπ${d.amount}</p>
            <p class="text-sm">‚úî Verified: ${d.verified ? "‚úÖ Yes" : "‚ùå No"}</p>
            ${d.screenshot ? `<img src="${d.screenshot}" class="w-32 mt-2 border rounded"/>` : ""}
            <div class="mt-2 adminControls hidden">
              <button class="verifyBtn px-2 py-1 bg-green-600 text-white text-sm rounded">Verify</button>
              <button class="deleteBtn px-2 py-1 bg-red-600 text-white text-sm rounded">Delete</button>
            </div>
          `;

          // üë®‚Äçüíª Admin controls
          if (currentUser?.email === ADMIN_EMAIL) {
            donorCard.querySelector(".adminControls").classList.remove("hidden");

            donorCard.querySelector(".verifyBtn").onclick = async () => {
              await updateDoc(doc(db, "site", "donations", docSnap.id), {
                verified: true
              });
              alert("‚úÖ Donor Verified!");
            };

            donorCard.querySelector(".deleteBtn").onclick = async () => {
              if (confirm("Are you sure to delete this donor?")) {
                await deleteDoc(doc(db, "site", "donations", docSnap.id));
              }
            };
          }

          donorsDiv.appendChild(donorCard);
        });
      });
    }
  </script>
</body>
</html>
