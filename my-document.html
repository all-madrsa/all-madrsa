<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Upload | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f1f5f9;}
header{background:#1e40af;color:#fff;font-weight:700;text-align:center;padding:1rem;font-size:1.25rem;}
.upload-area{border:2px dashed #4d94ff;padding:20px;text-align:center;border-radius:10px;cursor:pointer;transition:.3s;}
.upload-area.dragover{background:#e0f7ff;}
.progress-bar{height:6px;background:#4d94ff;border-radius:3px;margin-top:5px;transition:width .2s;}
.btn-3d{background:linear-gradient(90deg,#4d94ff,#4dffb8);color:#fff;font-weight:700;border-radius:10px;padding:.35rem .7rem;font-size:.85rem;
box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 10px rgba(0,0,0,.2);transition:transform .12s ease,box-shadow .12s ease,filter .12s;cursor:pointer;}
.btn-3d:hover{filter:brightness(1.1);transform:translateY(-2px);}
.admin-btn{display:inline-block;margin:2px;padding:2px 6px;border-radius:5px;font-size:.7rem;color:#fff;cursor:pointer;}
.admin-delete{background:#dc2626;}
.card-img{width:100%;height:200px;object-fit:cover;border-radius:5px;}
</style>
</head>
<body>

<header>üì§ Admin Upload Page</header>

<div id="adminUpload" class="max-w-md mx-auto mt-4 p-4 bg-white rounded shadow hidden">

  <h2 class="font-semibold mb-2">Upload Image</h2>
  <div id="uploadArea" class="upload-area mb-2">Drag & Drop Image or Click (JPG/PNG)</div>
  <input id="fileInput" type="file" accept=".jpg,.jpeg,.png" class="hidden"/>
  <input id="imgTitle" type="text" placeholder="Image Title" class="mb-2 w-full rounded border p-1"/>
  <div class="w-full bg-gray-300 rounded overflow-hidden mb-2"><div id="progress" class="progress-bar w-0"></div></div>
  <button id="uploadBtn" class="btn-3d w-full py-2 mb-4">Upload Image</button>

  <h2 class="font-semibold mb-2">Upload Text</h2>
  <input id="textTitle" type="text" placeholder="Title" class="mb-2 w-full rounded border p-1"/>
  <textarea id="textContent" placeholder="Enter text..." class="mb-2 w-full rounded border p-1"></textarea>
  <button id="textUploadBtn" class="btn-3d w-full py-2 mb-4">Upload Text</button>
</div>

<main class="max-w-md mx-auto p-4">
  <div id="itemList" class="space-y-3"></div>
  <p id="emptyMsg" class="text-gray-500 text-sm mt-4 hidden">‚ö†Ô∏è No items available.</p>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { getDatabase, ref as rRef, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e387e1297663b11fc2463b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const dbRT = getDatabase(app);
const storage = getStorage(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// DOM Elements
const adminUpload = document.getElementById("adminUpload");
const uploadArea = document.getElementById("uploadArea");
const fileInput = document.getElementById("fileInput");
const imgTitle = document.getElementById("imgTitle");
const uploadBtn = document.getElementById("uploadBtn");
const progressBar = document.getElementById("progress");

const textTitle = document.getElementById("textTitle");
const textContent = document.getElementById("textContent");
const textUploadBtn = document.getElementById("textUploadBtn");

const itemList = document.getElementById("itemList");
const emptyMsg = document.getElementById("emptyMsg");

let currentUser = null;
let isAdminUser = false;

// ========================
// Helper: check admin from Realtime DB
// ========================
async function checkAdmin(email){
  const snapshot = await get(rRef(dbRT,"admins"));
  if(snapshot.exists()){
    const admins = snapshot.val();
    return Object.values(admins).includes(email);
  }
  return false;
}

// ========================
// Drag & Drop
// ========================
uploadArea.addEventListener("click",()=>fileInput.click());
uploadArea.addEventListener("dragover",e=>{ e.preventDefault(); uploadArea.classList.add("dragover"); });
uploadArea.addEventListener("dragleave",e=>{ e.preventDefault(); uploadArea.classList.remove("dragover"); });
uploadArea.addEventListener("drop",e=>{
  e.preventDefault(); uploadArea.classList.remove("dragover");
  fileInput.files = e.dataTransfer.files;
});

// ========================
// Upload Image
// ========================
uploadBtn.onclick = async()=>{
  if(!isAdminUser){ alert("Only admin can upload!"); return; }
  const file = fileInput.files[0];
  if(!file) return alert("Select an image!");
  const title = imgTitle.value.trim();
  if(!title) return alert("Enter image title!");

  const storageRef = ref(storage,"uploads/"+Date.now()+"_"+file.name);
  const uploadTask = uploadBytesResumable(storageRef,file);

  progressBar.style.width="0%";
  uploadBtn.textContent="‚è≥ Uploading...";

  uploadTask.on('state_changed',
    snapshot=>{
      const percent = Math.round((snapshot.bytesTransferred/snapshot.totalBytes)*100);
      progressBar.style.width = percent+"%";
    },
    error=>{
      alert("Upload error: "+error.message);
      uploadBtn.textContent="Upload Image"; progressBar.style.width="0%";
    },
    async()=>{
      const url = await getDownloadURL(uploadTask.snapshot.ref);
      await addDoc(collection(db,"items"),{type:"image",title,url,createdAt:serverTimestamp()});
      imgTitle.value=""; fileInput.value="";
      uploadBtn.textContent="Upload Image"; progressBar.style.width="0%";
      loadItems();
    }
  );
};

// ========================
// Upload Text
// ========================
textUploadBtn.onclick = async()=>{
  if(!isAdminUser){ alert("Only admin can upload!"); return; }
  const title = textTitle.value.trim();
  const content = textContent.value.trim();
  if(!title || !content) return alert("Enter title and text!");
  await addDoc(collection(db,"items"),{type:"text",title,content,createdAt:serverTimestamp()});
  textTitle.value=""; textContent.value="";
  loadItems();
};

// ========================
// Load Items
// ========================
async function loadItems(){
  itemList.innerHTML="";
  const q=query(collection(db,"items"),orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  if(snap.empty){ emptyMsg.classList.remove("hidden"); return; }
  emptyMsg.classList.add("hidden");

  snap.forEach(docSnap=>{
    const d = docSnap.data();
    const div = document.createElement("div");
    div.className="bg-white p-3 rounded shadow";

    if(d.type==="image"){
      const img = document.createElement("img"); img.src=d.url; img.className="card-img mb-1"; div.appendChild(img);
      const span = document.createElement("div"); span.textContent=d.title; span.className="font-medium mb-1"; div.appendChild(span);
    } else {
      const h3 = document.createElement("div"); h3.textContent=d.title; h3.className="font-semibold mb-1"; div.appendChild(h3);
      const p = document.createElement("div"); p.textContent=d.content; div.appendChild(p);
    }

    if(isAdminUser){
      const delBtn = document.createElement("button"); delBtn.textContent="Delete"; delBtn.className="admin-btn admin-delete mt-2";
      delBtn.onclick=async()=>{ if(confirm("Delete this item?")){ await deleteDoc(doc(db,"items",docSnap.id)); loadItems(); } };
      div.appendChild(delBtn);
    }

    itemList.appendChild(div);
  });
}

// ========================
// Auth
// ========================
onAuthStateChanged(auth, async user=>{
  currentUser = user;
  if(!user){ signInWithPopup(auth,provider); return; }
  isAdminUser = await checkAdmin(user.email);
  if(isAdminUser){ adminUpload.classList.remove("hidden"); }
  loadItems();
});

/* ========================
üî• Important: CORS fix for Storage
========================
1. Create cors.json
[
  {
    "origin": ["https://all-madrsa.netlify.app"],
    "method": ["GET","POST","PUT","DELETE","OPTIONS"],
    "maxAgeSeconds": 3600
  }
]
2. Apply:
firebase login
firebase use --add
gsutil cors set cors.json gs://all-madrsa.appspot.com
*/
</script>

</body>
</html>
