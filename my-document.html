<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Trust Documents | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#f1f5f9; }
.btn-3d { background:linear-gradient(90deg,#4d94ff,#4dffb8); color:#fff; font-weight:700; border-radius:10px; padding:.35rem .7rem; font-size:.85rem;
box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 10px rgba(0,0,0,.2);
transition: transform .12s ease, box-shadow .12s ease, filter .12s; cursor:pointer;}
.btn-3d:hover{filter:brightness(1.1); transform:translateY(-2px);}
.upload-area{border:2px dashed #4d94ff;padding:20px;text-align:center;border-radius:10px;cursor:pointer;transition:0.3s;}
.upload-area.dragover{background:#e0f7ff;}
.progress-bar{height:6px;background:#4d94ff;border-radius:3px;margin-top:5px;transition:width 0.2s;}
.admin-btn{display:inline-block;margin:2px;padding:2px 6px;border-radius:5px;font-size:0.7rem;color:#fff;cursor:pointer;}
.admin-edit{background:#1d4ed8;}
.admin-delete{background:#dc2626;}
</style>
</head>
<body>

<header class="bg-blue-600 p-4 text-white text-center font-bold text-xl">üìÑ Trust Documents</header>

<!-- Admin Upload -->
<div id="adminUpload" class="hidden max-w-md mx-auto mt-4 p-4 bg-white rounded shadow">
  <h2 class="font-semibold mb-2">üì§ Upload New Document</h2>
  <div id="uploadArea" class="upload-area mb-2">Drag & Drop File Here or Click to Select (PDF/DOC/DOCX)</div>
  <input id="docFile" type="file" accept=".pdf,.doc,.docx" class="hidden"/>
  <input id="docTitle" type="text" placeholder="Document Title" class="mb-2 w-full rounded border p-1"/>
  <div class="w-full bg-gray-300 rounded overflow-hidden mb-2"><div id="progress" class="progress-bar w-0"></div></div>
  <button id="uploadBtn" class="btn-3d w-full py-2">Upload</button>
</div>

<main class="max-w-4xl mx-auto p-4">
  <div id="docList" class="space-y-3"></div>
  <p id="emptyMsg" class="text-gray-500 text-sm mt-4 hidden">‚ö†Ô∏è No documents available.</p>
</main>

<footer class="bg-gray-100 text-center py-4 mt-10">
  <p class="text-xs text-gray-500">¬© 2025 Talimi Ittehad</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e387e1297663b11fc2463b"
};

const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const adminBox = document.getElementById("adminUpload");
const uploadArea = document.getElementById("uploadArea");
const docFile = document.getElementById("docFile");
const docTitle = document.getElementById("docTitle");
const uploadBtn = document.getElementById("uploadBtn");
const progressBar = document.getElementById("progress");
const docList = document.getElementById("docList");
const emptyMsg = document.getElementById("emptyMsg");

let currentUser = null;

// Drag & drop
uploadArea.addEventListener("click",()=>docFile.click());
uploadArea.addEventListener("dragover",e=>{ e.preventDefault(); uploadArea.classList.add("dragover"); });
uploadArea.addEventListener("dragleave",e=>{ e.preventDefault(); uploadArea.classList.remove("dragover"); });
uploadArea.addEventListener("drop",e=>{
  e.preventDefault(); uploadArea.classList.remove("dragover");
  docFile.files = e.dataTransfer.files;
});

// Upload document
uploadBtn.onclick = async()=>{
  const file = docFile.files[0];
  if(!file) return alert("Select a file!");
  const title = docTitle.value.trim();
  if(!title) return alert("Enter document title!");

  const storageRef = ref(storage,"trust_docs/"+Date.now()+"_"+file.name);
  const uploadTask = uploadBytesResumable(storageRef,file);

  progressBar.style.width="0%";
  uploadBtn.textContent="‚è≥ Uploading...";

  uploadTask.on('state_changed',
    snapshot=>{
      const percent = Math.round((snapshot.bytesTransferred/snapshot.totalBytes)*100);
      progressBar.style.width = percent+"%";
    },
    error=>{ alert("Upload error: "+error.message); uploadBtn.textContent="Upload"; progressBar.style.width="0%"; },
    async()=>{
      const url = await getDownloadURL(uploadTask.snapshot.ref);
      await addDoc(collection(db,"trust_docs"),{title,url,createdAt:serverTimestamp()});
      docTitle.value=""; docFile.value="";
      uploadBtn.textContent="‚úÖ Done"; progressBar.style.width="0%";
      loadDocs();
    }
  );
};

// Load documents
async function loadDocs(){
  docList.innerHTML="";
  const q=query(collection(db,"trust_docs"),orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  if(snap.empty){ emptyMsg.classList.remove("hidden"); return; }
  emptyMsg.classList.add("hidden");

  snap.forEach(docSnap=>{
    const d = docSnap.data();
    const div = document.createElement("div");
    div.className="bg-white p-3 rounded shadow flex justify-between items-center";

    const link = document.createElement("a");
    link.href=d.url; link.target="_blank"; link.textContent=d.title;
    link.className="text-blue-600 hover:underline";
    div.appendChild(link);

    if(currentUser && currentUser.email===ADMIN_EMAIL){
      const btnWrapper = document.createElement("div");
      btnWrapper.className="flex gap-1";

      const delBtn = document.createElement("button");
      delBtn.textContent="Delete"; delBtn.className="admin-btn admin-delete";
      delBtn.onclick=async()=>{
        if(confirm("Delete this document?")){
          await deleteDoc(doc(db,"trust_docs",docSnap.id));
          loadDocs();
        }
      };
      btnWrapper.appendChild(delBtn);

      const editBtn = document.createElement("button");
      editBtn.textContent="Edit"; editBtn.className="admin-btn admin-edit";
      editBtn.onclick=async()=>{
        const newTitle = prompt("Update document title:",d.title);
        if(newTitle!==null && newTitle.trim()!==""){
          await updateDoc(doc(db,"trust_docs",docSnap.id),{title:newTitle});
          loadDocs();
        }
      };
      btnWrapper.appendChild(editBtn);

      div.appendChild(btnWrapper);
    }

    docList.appendChild(div);
  });
}

// Auth
onAuthStateChanged(auth,user=>{
  currentUser = user;
  if(user && user.email===ADMIN_EMAIL){ adminBox.classList.remove("hidden"); }
  if(!user){ signInWithPopup(auth,provider); }
  loadDocs();
});
</script>

</body>
</html>
