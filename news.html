<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vasai Live News ‚Äî Final</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

<style>
/* ---------- BASE ---------- */
:root { --header-h:56px; --ticker-h:28px; }
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:#f6f7fb;color:#0b2540;}

/* ---------- HEADER ---------- */
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 12px;background:#1e40af;color:#fff;
  position:sticky;top:0;z-index:1000;height:var(--header-h);
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}
header .brand{display:flex;align-items:center;gap:8px}
header img{height:48px;width:48px;border-radius:6px;object-fit:cover}
.header-buttons button{margin-left:8px;padding:6px 12px;border-radius:6px;font-weight:600;cursor:pointer}
.header-buttons .hidden{display:none}

/* ---------- TICKERS ---------- */
.notice-ticker, .headline-ticker{
  position:sticky;left:0;right:0;overflow:hidden;white-space:nowrap;color:#fff;z-index:900;
}
.notice-ticker{top:var(--header-h);background:#dc2626;padding:6px;height:var(--ticker-h)}
.headline-ticker{top:calc(var(--header-h) + var(--ticker-h));background:#1e40af;padding:6px;height:var(--ticker-h)}
.ticker-text{display:inline-block;padding-right:60px;animation:scroll 18s linear infinite;}
@keyframes scroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

/* ---------- CONTENT GRID ---------- */
.posts-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:12px;padding:12px;
  /* use padding-top so sticky headers don't cut content */
  padding-top: calc(var(--header-h) + 2 * var(--ticker-h) + 12px);
}

/* Card */
.card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 20px rgba(2,6,23,0.06);cursor:pointer;transition:transform .18s}
.card:hover{transform:scale(1.02)}
.card img{width:100%;height:160px;object-fit:cover}
.card-body{padding:10px}
.card-body h3{font-weight:700;margin-bottom:6px}
.card-body p{color:#555;font-size:14px;margin-bottom:8px}
.social-share{display:flex;gap:6px}

/* ---------- MODAL & ZOOM (with transitions) ---------- */
.modal-bg, .zoom-modal{
  display:flex;align-items:center;justify-content:center;
  position:fixed;inset:0;background:rgba(0,0,0,0.85);
  z-index:2000;opacity:0;pointer-events:none;transition:opacity .25s ease;
}
.modal-bg.active, .zoom-modal.active{opacity:1;pointer-events:auto}
.modal{
  background:#fff;border-radius:10px;padding:16px;max-width:940px;width:92%;max-height:90vh;overflow:auto;position:relative;box-shadow:0 10px 40px rgba(0,0,0,0.35);
}
.zoom-modal img{max-width:92vw;max-height:90vh;border-radius:10px;object-fit:contain;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.btn-close{position:absolute;top:12px;right:12px;background:#fff;border:none;border-radius:999px;padding:6px 10px;font-size:18px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.12)}

/* ---------- IMAGE PREVIEWS & EDITOR ---------- */
.editor{display:none;background:#fff;padding:12px;margin:12px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.04)}
.editor input,.editor textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #d1d5db;margin-bottom:8px}
.editor button{padding:8px 12px;border-radius:8px;background:#1e40af;color:#fff;border:none;cursor:pointer;margin-right:8px}
.block-image-preview{width:100%;max-height:240px;object-fit:cover;border-radius:6px;margin-bottom:8px}

/* responsive tweaks */
@media (max-width:640px){
  .card img{height:140px}
  .modal{width:96%}
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="https://i.postimg.cc/vTb8F94w/vasalive-png.jpg" alt="logo">
    <div>
      <div class="text-xl font-bold">Vasai Live News</div>
      <div style="font-size:12px;opacity:.85">Local updates ‚Ä¢ Vasai</div>
    </div>
  </div>
  <div class="header-buttons">
    <button id="loginBtn" class="bg-green-500 text-white">Login</button>
    <button id="logoutBtn" class="bg-red-600 text-white hidden">Logout</button>
  </div>
</header>

<div class="notice-ticker"><span id="noticeText" class="ticker-text"></span></div>
<div class="headline-ticker"><span id="headlineText" class="ticker-text"></span></div>

<!-- Admin Notice Editor -->
<section id="noticeEditor" class="editor">
  <h3>üì∞ Admin Notice</h3>
  <input id="noticeInput" placeholder="Type notice here...">
  <button id="saveNoticeBtn">Save Notice</button>
</section>

<!-- Admin News Editor -->
<section id="editorArea" class="editor">
  <h3>üñãÔ∏è Admin: Create / Edit News</h3>
  <input id="aTitle" placeholder="Title">
  <input id="aCat" placeholder="Category">
  <div id="blocksList"></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button id="addTextBtn">Add Text</button>
    <button id="addImageBtn">Add Image (max 5)</button>
    <button id="publishBtn">Publish / Update</button>
    <button id="clearEditorBtn" style="background:#ef4444">Clear</button>
  </div>
</section>

<!-- Posts -->
<section id="postsArea" class="posts-grid"></section>

<!-- Modal (full news) -->
<div id="modalBg" class="modal-bg" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <button id="modalClose" class="btn-close" aria-label="Close">‚úï</button>
    <div id="modalContent"></div>
  </div>
</div>

<!-- Zoom modal (created on demand, but keep element to reuse) -->
<div id="zoomModal" class="zoom-modal" aria-hidden="true" style="display:flex">
  <img id="zoomImg" src="" alt="zoom">
  <button id="zoomClose" class="btn-close" aria-label="Close zoom">‚úï</button>
</div>

<script type="module">
/* =========================
   Firebase init (provided)
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e33f0c8bdef6d1a7f31e9f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================
   Config / DOM
   ================ */
const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
const IMGBB_API_KEY = "d12c2e4a8650157b2b6b9fe85336ea43"; // consider hiding for production

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const editorArea = document.getElementById("editorArea");
const noticeEditor = document.getElementById("noticeEditor");
const postsArea = document.getElementById("postsArea");
const blocksList = document.getElementById("blocksList");
const modalBg = document.getElementById("modalBg");
const modalClose = document.getElementById("modalClose");
const modalContent = document.getElementById("modalContent");
const noticeText = document.getElementById("noticeText");
const headlineText = document.getElementById("headlineText");
const noticeInput = document.getElementById("noticeInput");
const zoomModal = document.getElementById("zoomModal");
const zoomImg = document.getElementById("zoomImg");
const zoomClose = document.getElementById("zoomClose");

let editingId = null;
const noticeRef = doc(db, "settings", "notice");

/* ================
   Auth handlers
   ================ */
loginBtn.onclick = async () => {
  try {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  } catch (err) {
    alert("Login failed: " + (err.message || err));
  }
};
logoutBtn.onclick = () => signOut(auth);

auth.onAuthStateChanged(user => {
  if (user && user.email === ADMIN_EMAIL) {
    editorArea.style.display = "block";
    noticeEditor.style.display = "block";
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
  } else {
    editorArea.style.display = "none";
    noticeEditor.style.display = "none";
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
  }
});

/* ====================
   IMGBB uploader (safe)
   ==================== */
async function uploadToImgBB(file) {
  try {
    const form = new FormData();
    form.append("image", file);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: form });
    const json = await res.json();
    if (!json || !json.data || !json.data.url) throw new Error("Upload failed");
    return json.data.url;
  } catch (e) {
    console.error("IMGBB upload error:", e);
    alert("Image upload failed. Try again.");
    return null;
  }
}

/* ====================
   Editor: add blocks
   ==================== */
document.getElementById("addTextBtn").onclick = () => {
  const ta = document.createElement("textarea");
  ta.placeholder = "Write paragraph...";
  ta.dataset.type = "text";
  ta.className = "border p-2 w-full mb-2 rounded";
  blocksList.appendChild(ta);
};

document.getElementById("addImageBtn").onclick = () => {
  // limit to 5 image inputs
  const currentImages = blocksList.querySelectorAll('input[type="file"]').length;
  if (currentImages >= 5) { alert("Max 5 images allowed per post"); return; }

  const preview = document.createElement("img");
  preview.className = "block-image-preview";
  preview.style.display = "none";

  const inp = document.createElement("input");
  inp.type = "file"; inp.accept = "image/*";
  inp.dataset.type = "image";
  inp.className = "w-full mb-3";
  inp.onchange = () => {
    if (inp.files && inp.files[0]) {
      preview.src = URL.createObjectURL(inp.files[0]);
      preview.style.display = "block";
    }
  };

  blocksList.appendChild(preview);
  blocksList.appendChild(inp);
};

document.getElementById("clearEditorBtn").onclick = () => {
  editingId = null;
  document.getElementById("aTitle").value = "";
  document.getElementById("aCat").value = "";
  blocksList.innerHTML = "";
};

/* ======================
   Publish / Update News
   ====================== */
document.getElementById("publishBtn").onclick = async () => {
  const title = document.getElementById("aTitle").value.trim();
  const cat = document.getElementById("aCat").value.trim();
  if (!title) { alert("Enter title!"); return; }
  if (!cat) { alert("Enter category!"); return; }

  // build blocks: text & image upload
  const blocks = [];
  for (const el of Array.from(blocksList.children)) {
    // textarea (text blocks)
    if (el.dataset && el.dataset.type === "text" || el.tagName === "TEXTAREA") {
      if (el.value && el.value.trim()) blocks.push({ type: "text", text: el.value.trim() });
    } else if (el.type === "file") {
      if (el.files && el.files.length > 0) {
        const url = await uploadToImgBB(el.files[0]);
        if (url) blocks.push({ type: "image", url });
      }
    } else if (el.tagName === "IMG" && el.src && el.classList.contains("block-image-preview")) {
      // preview-only images without replacing file are handled in edit flow via preview + no new file
      // but normal publish should have file inputs; this case can be ignored here
    }
  }

  if (blocks.length === 0) { alert("Add content! At least one text or image."); return; }

  try {
    if (editingId) {
      await updateDoc(doc(db, "vasai_news", editingId), { title, category: cat, blocks, time: Date.now() });
      editingId = null;
      alert("News updated");
    } else {
      await addDoc(collection(db, "vasai_news"), { title, category: cat, blocks, time: Date.now() });
      alert("News published");
    }
    document.getElementById("aTitle").value = "";
    document.getElementById("aCat").value = "";
    blocksList.innerHTML = "";
  } catch (e) {
    console.error("Save error:", e);
    alert("Error saving news. Try again.");
  }
};

/* ====================
   Save notice
   ==================== */
document.getElementById("saveNoticeBtn").onclick = async () => {
  const t = noticeInput.value.trim();
  try {
    await setDoc(noticeRef, { text: t });
    noticeInput.value = "";
    alert("Notice saved");
  } catch (e) {
    console.error("Notice save error", e);
    alert("Notice save failed");
  }
};

/* =========================
   Live load posts + notice
   ========================= */
onSnapshot(query(collection(db, "vasai_news"), orderBy("time", "desc")), snap => {
  const posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderPosts(posts);
  headlineText.textContent = posts.slice(0, 5).map(p => p.title).join(" ‚Äî ");
});
onSnapshot(noticeRef, snap => {
  noticeText.textContent = snap.exists() && snap.data().text ? snap.data().text : "";
});

/* =========================
   Render posts & enable zoom
   ========================= */
function renderPosts(posts) {
  postsArea.innerHTML = "";
  posts.forEach(d => {
    const img = d.blocks.find(b => b.type === "image")?.url || "https://via.placeholder.com/600x300?text=No+Image";
    const textBlock = d.blocks.find(b => b.type === "text");
    const txt = textBlock ? (textBlock.text.length > 80 ? textBlock.text.substring(0, 80) + "..." : textBlock.text) : "";

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${img}" loading="lazy" class="image-zoom" alt="post image">
      <div class="card-body">
        <h3>${escapeHtml(d.title)}</h3>
        <p>${escapeHtml(txt)}</p>
        <div class="social-share"></div>
      </div>
    `;
    // social buttons
    const shareDiv = card.querySelector(".social-share");
    const url = encodeURIComponent(location.href);
    shareDiv.innerHTML = `
      <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=${url}','_blank');event.stopPropagation();">FB</button>
      <button onclick="window.open('https://api.whatsapp.com/send?text=${url}','_blank');event.stopPropagation();">WA</button>
      <button onclick="window.open('https://twitter.com/intent/tweet?url=${url}','_blank');event.stopPropagation();">TW</button>
    `;

    card.onclick = () => showModal(d);
    postsArea.appendChild(card);
  });

  enableImageZoom();
}

/* escape to avoid minimal html injection in titles/text */
function escapeHtml(s){ if(!s) return ""; return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

/* ======================
   Image zoom (cards)
   ====================== */
function enableImageZoom() {
  document.querySelectorAll(".image-zoom").forEach(img => {
    // ensure remove previous handlers
    img.onclick = (e) => {
      e.stopPropagation();
      // open zoom-modal element (reusing element)
      zoomImg.src = img.src;
      openZoomModal();
    };
  });
}

function openZoomModal() {
  zoomModal.classList.add("active");
  zoomModal.style.display = "flex";
  document.body.style.overflow = "hidden";
}
function closeZoomModal() {
  zoomModal.classList.remove("active");
  setTimeout(() => { zoomModal.style.display = "none"; zoomImg.src = ""; }, 260);
  document.body.style.overflow = "auto";
}

/* zoom close handlers */
zoomClose.onclick = closeZoomModal;
zoomModal.onclick = (e) => { if (e.target === zoomModal) closeZoomModal(); };

/* ======================
   Full news modal logic
   ====================== */
modalClose.onclick = closeModal;
modalBg.onclick = (e) => { if (e.target === modalBg) closeModal(); };

function openModal() {
  modalBg.classList.add("active");
  modalBg.style.display = "flex";
  document.body.style.overflow = "hidden";
}
function closeModal() {
  modalBg.classList.remove("active");
  setTimeout(() => { modalBg.style.display = "none"; modalContent.innerHTML = ""; }, 260);
  document.body.style.overflow = "auto";
}

/* showModal creates content, adds edit/delete for admin */
function showModal(d) {
  // build content
  modalContent.innerHTML = `<h2 style="font-size:18px;font-weight:700;margin-bottom:8px">${escapeHtml(d.title)}</h2>`;
  d.blocks.forEach(b => {
    if (b.type === "text") {
      const p = document.createElement("p"); p.style.marginBottom = "10px"; p.textContent = b.text; modalContent.appendChild(p);
    } else if (b.type === "image") {
      const im = document.createElement("img"); im.src = b.url; im.className = "image-zoom"; im.style.width = "100%"; im.style.marginBottom = "10px";
      im.onclick = (e) => { e.stopPropagation(); zoomImg.src = im.src; openZoomModal(); };
      modalContent.appendChild(im);
    }
  });

  // admin actions
  const user = auth.currentUser;
  if (user && user.email === ADMIN_EMAIL) {
    const controls = document.createElement("div"); controls.style.marginTop = "8px";
    const editBtn = document.createElement("button"); editBtn.textContent = "Edit"; editBtn.className = "editor-btn"; editBtn.style.marginRight = "8px";
    editBtn.onclick = () => {
      // populate editor with post content
      editingId = d.id;
      document.getElementById("aTitle").value = d.title;
      document.getElementById("aCat").value = d.category || "";
      blocksList.innerHTML = "";
      d.blocks.forEach(b => {
        if (b.type === "text") {
          const t = document.createElement("textarea"); t.dataset.type = "text"; t.className = "border p-2 w-full mb-2 rounded"; t.value = b.text;
          blocksList.appendChild(t);
        } else if (b.type === "image") {
          const preview = document.createElement("img"); preview.src = b.url; preview.className = "block-image-preview";
          const inp = document.createElement("input"); inp.type = "file"; inp.dataset.type = "image"; inp.className = "w-full mb-3";
          inp.onchange = () => { if (inp.files[0]) preview.src = URL.createObjectURL(inp.files[0]); }
          blocksList.appendChild(preview);
          blocksList.appendChild(inp);
        }
      });
      closeModal();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    const delBtn = document.createElement("button"); delBtn.textContent = "Delete"; delBtn.style.background = "#ef4444"; delBtn.style.color = "#fff";
    delBtn.onclick = async () => {
      if (!confirm("Delete this post?")) return;
      try { await deleteDoc(doc(db, "vasai_news", d.id)); closeModal(); } catch (e) { alert("Delete failed"); console.error(e); }
    };

    // style small
    [editBtn, delBtn].forEach(bt => { bt.style.padding = "6px 10px"; bt.style.borderRadius = "6px"; bt.style.border = "none"; bt.style.cursor = "pointer"; });

    controls.appendChild(editBtn); controls.appendChild(delBtn);
    modalContent.appendChild(controls);
  }

  openModal();
}

/* ================
   helper: ensure modal/zoom hidden on load
   ================ */
(function initHide() {
  modalBg.style.display = "none";
  modalBg.classList.remove("active");
  zoomModal.style.display = "none";
  zoomModal.classList.remove("active");
})();

/* =================
   small util: prevent long small text stopping animation
   ================= */
function ensureTickerWorks() {
  // if text is short, duplicate it to allow scroll animation
  [noticeText, headlineText].forEach(el => {
    if (!el) return;
    const txt = el.textContent.trim();
    if (!txt) return;
    if (txt.length < 30) el.textContent = txt + " ‚Äî " + txt + " ‚Äî " + txt;
  });
}
setInterval(ensureTickerWorks, 2000); // small guard (updates via snapshot anyway)

</script>
</body>
</html>
