<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vasai Live News</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
<style>
body{background:#f6f7fb;color:#0b2540;font-family:Arial,sans-serif;overflow-x:hidden;}
header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#1e40af;color:white;border-radius:6px;margin-bottom:6px;position:sticky;top:0;z-index:100;}
.header-left{display:flex;align-items:center;}
header img{height:45px;width:45px;border-radius:6px;margin-right:8px;}
header h1{text-shadow:1px 1px 3px #000;font-weight:800;font-size:20px;}
.header-buttons{display:flex;gap:6px;}
.header-buttons button{padding:3px 6px;font-size:12px;border-radius:4px;font-weight:600;text-shadow:1px 1px 2px #000;cursor:pointer;}
.ticker,.notice-ticker{color:white;padding:6px;overflow:hidden;white-space:nowrap;margin-bottom:6px;}
.ticker{background:#1e40af;}
.notice-ticker{background:#dc2626;}
.ticker span,.notice-ticker span{display:inline-block;padding-right:50px;animation:scroll 20s linear infinite;}
@keyframes scroll{0%{transform:translateX(100%);}100%{transform:translateX(-100%);}}
.category-btns{display:flex;gap:6px;overflow-x:auto;margin-bottom:12px;}
.category-btns button{flex-shrink:0;padding:4px 8px;border-radius:6px;border:1px solid #3b82f6;color:#3b82f6;cursor:pointer;}
.category-btns button.active{background:#3b82f6;color:white;}
.posts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;}
.card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 20px rgba(2,6,23,0.06);cursor:pointer;transition:transform 0.2s;}
.card:hover{transform:scale(1.02);}
.card img{width:100%;height:auto;max-height:180px;object-fit:contain;background:#f3f4f6;}
.card-body{padding:8px;}
.card-body h3{font-weight:700;font-size:18px;margin-bottom:4px;}
.card-body p{font-size:14px;color:#555;margin-bottom:6px;}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:200;}
.modal{background:#fff;border-radius:10px;max-width:600px;width:90%;max-height:80%;overflow-y:auto;padding:16px;position:relative;}
.modal-close{position:absolute;top:8px;right:8px;background:#f87171;color:white;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;}
textarea{resize:none;}
</style>
</head>
<body class="p-2">

<header>
  <div class="header-left">
    <img src="https://via.placeholder.com/50x50?text=VL" alt="Logo">
    <h1>Vasai Live News</h1>
  </div>
  <div class="header-buttons">
    <button id="loginBtn" class="bg-blue-700 text-white">Login</button>
    <button id="logoutBtn" class="hidden bg-red-600 text-white">Logout</button>
  </div>
</header>

<div class="ticker"><span id="tickerText">Loading latest headlines...</span></div>
<div class="notice-ticker"><span id="noticeText">Loading notice...</span></div>

<div id="noticeEditor" class="hidden mb-2">
  <input type="text" id="noticeInput" class="border p-1 w-full rounded" placeholder="Write notice">
  <button id="saveNoticeBtn" class="bg-blue-700 text-white px-3 py-1 mt-1 rounded">Save Notice</button>
</div>

<div class="category-btns" id="categoryBtns"></div>

<section id="editorArea" class="hidden p-2 mb-4 bg-white rounded shadow">
  <h2 class="font-semibold mb-2">Create / Edit Post</h2>
  <input id="aTitle" class="border p-2 w-full mb-2 rounded" placeholder="Title">
  <input id="aCat" class="border p-2 w-full mb-2 rounded" placeholder="Category">
  <textarea id="aText" class="border p-2 w-full mb-2 rounded" rows="4" placeholder="Write content with [image:URL]"></textarea>
  <input id="aImg" class="border p-2 w-full mb-2 rounded" placeholder="Image URL (optional)">
  <button id="imgUploadBtn" class="bg-green-600 text-white px-3 py-1 rounded mb-2">Upload Image</button>
  <div class="flex gap-2">
    <button id="publishBtn" class="bg-blue-700 text-white px-4 py-2 rounded">Publish</button>
    <button id="clearBtn" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
  </div>
</section>

<section class="posts-grid" id="postsArea"></section>

<div id="modalBg" class="modal-bg flex">
  <div class="modal">
    <button id="modalClose" class="modal-close">X</button>
    <div id="modalContent"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, onSnapshot, orderBy, query, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:e33f0c8bdef6d1a7f31e9f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const IMGBB_API_KEY = "d12c2e4a8650157b2b6b9fe85336ea43";

const ADMIN_EMAIL = "admin@example.com"; // replace with real admin
let currentCategory = "";
let editingId = null;

// DOM
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const editorArea = document.getElementById("editorArea");
const noticeEditor = document.getElementById("noticeEditor");
const postsArea = document.getElementById("postsArea");
const noticeText = document.getElementById("noticeText");
const tickerText = document.getElementById("tickerText");
const modalBg = document.getElementById("modalBg");
const modalClose = document.getElementById("modalClose");
const modalContent = document.getElementById("modalContent");

// Auth
loginBtn.onclick = async () => { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); };
logoutBtn.onclick = () => signOut(auth);

auth.onAuthStateChanged(user => {
  if(user){
    loginBtn.classList.add("hidden"); logoutBtn.classList.remove("hidden");
    if(user.email===ADMIN_EMAIL){ editorArea.classList.remove("hidden"); noticeEditor.classList.remove("hidden"); }
  } else {
    loginBtn.classList.remove("hidden"); logoutBtn.classList.add("hidden");
    editorArea.classList.add("hidden"); noticeEditor.classList.add("hidden");
  }
});

// Load posts live
const postsRef = collection(db,"vasai_news");
onSnapshot(query(postsRef, orderBy("time","desc")), snap => {
  const posts = snap.docs.map(d=>({id:d.id,...d.data()}));
  renderPosts(posts);
  makeCategories(posts);
});

// Notice live
const noticeRef = doc(db,"settings","notice");
onSnapshot(noticeRef,snap=>{if(snap.exists()) noticeText.textContent=snap.data().text;});
document.getElementById("saveNoticeBtn").onclick = async () => {
  const val = document.getElementById("noticeInput").value.trim();
  if(!val) return alert("Notice cannot be empty");
  await setDoc(noticeRef,{text:val});
  noticeText.textContent=val;
  document.getElementById("noticeInput").value="";
  alert("Notice updated!");
};

// Publish
document.getElementById("publishBtn").onclick = async () => {
  const title = aTitle.value.trim(), cat=aCat.value.trim(), text=aText.value.trim(), img=aImg.value.trim();
  if(!title || !text) return alert("Please fill title and content");
  if(editingId){
    await updateDoc(doc(db,"vasai_news",editingId),{title,category:cat,text,img});
    editingId=null;
  } else {
    await addDoc(postsRef,{title,category:cat,text,img,time:Date.now()});
  }
  clearFields();
};

// Clear
document.getElementById("clearBtn").onclick = clearFields;
function clearFields(){ aTitle.value=aCat.value=aText.value=aImg.value=""; editingId=null; }

// ImgBB Upload
document.getElementById("imgUploadBtn").onclick = async () => {
  const fileInput = document.createElement("input");
  fileInput.type="file"; fileInput.accept="image/*";
  fileInput.onchange = async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const formData = new FormData(); formData.append("image",file);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:formData});
    const data = await res.json();
    if(data.success){ aText.value += `\n[image:${data.data.url}]\n`; alert("Image uploaded!"); } 
    else alert("Upload failed!");
  };
  fileInput.click();
};

// Categories
function makeCategories(posts){
  const cats=[...new Set(posts.map(p=>p.category).filter(Boolean))];
  const btns=document.getElementById("categoryBtns");
  btns.innerHTML = `<button class="${!currentCategory?"active":""}" onclick="filterCat('')">All</button>` +
    cats.map(c=>`<button class="${c===currentCategory?"active":""}" onclick="filterCat('${c}')">${c}</button>`).join("");
}
window.filterCat=(c)=>{ currentCategory=c; getDocs(postsRef).then(snap=>renderPosts(snap.docs.map(d=>({id:d.id,...d.data()})))); }

// Render posts
function formatTextWithImages(text){ return text.replace(/\[image:(https?:\/\/[^\]]+)\]/g,'<img src="$1" class="w-full rounded my-2">'); }
function renderPosts(posts){
  postsArea.innerHTML="";
  const filtered = currentCategory ? posts.filter(p=>p.category===currentCategory):posts;
  filtered.forEach(d=>{
    const img = d.img || "https://via.placeholder.com/300x150?text=No+Image";
    const excerpt = d.text.length>100?d.text.substring(0,100)+"...":d.text;
    const card=document.createElement("div"); card.className="card";
    card.innerHTML=`<img src="${img}"><div class="card-body"><h3>${d.title}</h3><p>${excerpt}</p><button class='bg-blue-600 text-white px-2 py-1 rounded text-sm'>Read More</button></div>`;
    card.onclick=()=>showModal(d);
    postsArea.appendChild(card);
  });
}

// Modal
function showModal(d){
  modalContent.innerHTML=`<h2 class="text-lg font-bold mb-2">${d.title}</h2><p class="text-sm text-gray-500 mb-2">${d.category||""}</p>${formatTextWithImages(d.text)}`;
  const user=auth.currentUser;
  if(user && user.email===ADMIN_EMAIL){
    const editBtn=document.createElement("button"); editBtn.className="bg-gray-200 px-3 py-1 rounded mr-2"; editBtn.textContent="Edit";
    editBtn.onclick=()=>{ editingId=d.id;aTitle.value=d.title;aCat.value=d.category;aText.value=d.text;aImg.value=d.img; modalBg.style.display='none'; };
    const delBtn=document.createElement("button"); delBtn.className="bg-red-500 text-white px-3 py-1 rounded"; delBtn.textContent="Delete";
    delBtn.onclick=async()=>{if(confirm("Delete this post?")) await deleteDoc(doc(db,"vasai_news",d.id)); modalBg.style.display='none'; alert("Deleted!");};
    modalContent.appendChild(editBtn); modalContent.appendChild(delBtn);
  }
  modalBg.style.display="flex";
}
modalClose.onclick=()=>modalBg.style.display="none";
modalBg.onclick=e=>{if(e.target===modalBg) modalBg.style.display="none";}

// Sample ticker
tickerText.textContent="Breaking News: Vasai Live portal launched with live admin notice!";
</script>
</body>
</html>
