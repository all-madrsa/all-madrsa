<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Vasai Live â€” Admin Post Management</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">

<!-- HEADER -->
<header class="bg-blue-800 text-white p-4 flex justify-between items-center">
  <h1 class="text-xl font-semibold">Vasai Live News</h1>
  <div>
    <button id="loginBtn" class="bg-white text-blue-800 px-3 py-1 rounded">Login with Google</button>
    <button id="logoutBtn" class="hidden bg-red-600 px-3 py-1 rounded">Logout</button>
  </div>
</header>

<!-- ADMIN PANEL -->
<section id="editorArea" class="hidden p-4 border-t">
  <h2 class="text-lg font-semibold mb-2">Create / Edit Post (Admin Only)</h2>
  <input id="aTitle" class="border p-2 w-full mb-2 rounded" placeholder="Post Title (Heading)" />
  <input id="aCat" class="border p-2 w-full mb-2 rounded" placeholder="Category" />
  <div id="blocksList" class="mb-3"></div>
  <div class="flex gap-2 mb-2">
    <button id="addTextBtn" class="bg-gray-200 px-3 py-1 rounded">Add Text Block</button>
    <button id="addImageBtn" class="bg-gray-200 px-3 py-1 rounded">Add Image Block</button>
  </div>
  <button id="publishBtn" class="mt-2 bg-blue-700 text-white px-4 py-2 rounded">Publish / Update</button>
</section>

<!-- PUBLIC POSTS LIST -->
<section id="postsArea" class="p-4 grid gap-3"></section>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:312ec03e62fd49d3d92e60"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
const IMGBB_API_KEY = "c4bc97c133edb76e062de6d070df67e4";

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const editorArea = document.getElementById("editorArea");
const postsArea = document.getElementById("postsArea");
const blocksList = document.getElementById("blocksList");

let editingPostId = null; // ðŸ”¹ for edit

// ðŸ”¹ LOGIN / LOGOUT
loginBtn.onclick = () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider); };
logoutBtn.onclick = () => auth.signOut();

// ðŸ”¹ AUTH CHECK
auth.onAuthStateChanged(user => {
  if(user && user.email === ADMIN_EMAIL){
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    editorArea.classList.remove("hidden");
  } else {
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    editorArea.classList.add("hidden");
  }
  loadPosts();
});

// ðŸ”¹ LOAD POSTS
async function loadPosts(){
  postsArea.innerHTML = "";
  const snap = await db.collection("vasai_news").orderBy("ts","desc").get();
  snap.forEach(doc => {
    const d = doc.data();
    const div = document.createElement("div");
    div.className = "p-3 bg-white rounded shadow";
    let blocksHTML = (d.blocks||[]).map(b => b.type==='text'?`<p class="mt-1">${b.text}</p>`:'').join('');
    blocksHTML += (d.blocks||[]).map(b => b.type==='image'?`<img src="${b.url}" class="mt-2 rounded w-full max-w-md">`:'').join('');

    div.innerHTML = `
      <h3 class="font-bold text-lg">${d.title}</h3>
      <p class="text-sm text-gray-600">${d.category} â€¢ ${new Date(d.ts).toLocaleString()}</p>
      ${blocksHTML}
      ${auth.currentUser && auth.currentUser.email === ADMIN_EMAIL ? `
        <div class="mt-2 flex gap-2">
          <button onclick="editPost('${doc.id}')" class="bg-yellow-400 px-2 py-1 rounded text-white">Edit</button>
          <button onclick="deletePost('${doc.id}')" class="bg-red-600 px-2 py-1 rounded text-white">Delete</button>
        </div>
      `:''}
    `;
    postsArea.appendChild(div);
  });
}

// ðŸ”¹ ADD TEXT BLOCK
document.getElementById("addTextBtn").onclick = () => {
  const inp = document.createElement("textarea");
  inp.className = "border w-full p-2 rounded mt-2";
  inp.placeholder = "Write text...";
  blocksList.appendChild(inp);
};

// ðŸ”¹ ADD IMAGE BLOCK
document.getElementById("addImageBtn").onclick = () => {
  const wrapper = document.createElement("div");
  wrapper.className = "mt-2 flex gap-2 items-center";
  const fileInp = document.createElement("input");
  fileInp.type = "file";
  fileInp.accept = "image/*";
  const urlInp = document.createElement("input");
  urlInp.type = "text";
  urlInp.placeholder = "Uploaded image URL";
  urlInp.className = "border p-2 rounded w-full";
  wrapper.appendChild(fileInp);
  wrapper.appendChild(urlInp);
  blocksList.appendChild(wrapper);

  fileInp.onchange = async () => {
    if(!fileInp.files.length) return;
    const file = fileInp.files[0];
    const form = new FormData();
    form.append('image', file);
    try{
      urlInp.value = "Uploading...";
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:'POST', body: form });
      const data = await res.json();
      if(data.success) urlInp.value = data.data.url;
      else urlInp.value = "";
    }catch(e){ urlInp.value = ""; alert("Upload failed"); }
  };
};

// ðŸ”¹ PUBLISH / UPDATE POST
document.getElementById("publishBtn").onclick = async () => {
  const user = auth.currentUser;
  if(!user || user.email !== ADMIN_EMAIL) return alert("Only admin can post!");

  const title = document.getElementById("aTitle").value;
  const category = document.getElementById("aCat").value;
  const blocks = [];
  blocksList.querySelectorAll("textarea").forEach(t => blocks.push({ type:'text', text:t.value }));
  blocksList.querySelectorAll("input[type=text]").forEach(t => { if(t.value) blocks.push({ type:'image', url:t.value }) });

  if(!title) return alert("Title required");

  if(editingPostId){ // ðŸ”¹ update
    await db.collection("vasai_news").doc(editingPostId).set({ title, category, blocks, ts: Date.now(), author: user.email });
    editingPostId = null;
  } else { // ðŸ”¹ new post
    await db.collection("vasai_news").add({ title, category, blocks, ts: Date.now(), author: user.email });
  }

  alert("Post saved!");
  document.getElementById("aTitle").value = "";
  document.getElementById("aCat").value = "";
  blocksList.innerHTML = "";
  loadPosts();
};

// ðŸ”¹ EDIT POST
window.editPost = async (id) => {
  const doc = await db.collection("vasai_news").doc(id).get();
  const data = doc.data();
  if(!data) return;
  editingPostId = id;
  document.getElementById("aTitle").value = data.title;
  document.getElementById("aCat").value = data.category;
  blocksList.innerHTML = "";
  data.blocks.forEach(b => {
    if(b.type==='text'){
      const t = document.createElement("textarea");
      t.className="border w-full p-2 rounded mt-2";
      t.value=b.text;
      blocksList.appendChild(t);
    } else if(b.type==='image'){
      const wrapper = document.createElement("div");
      wrapper.className="mt-2 flex gap-2 items-center";
      const urlInp = document.createElement("input");
      urlInp.type="text";
      urlInp.className="border p-2 rounded w-full";
      urlInp.value=b.url;
      wrapper.appendChild(urlInp);
      blocksList.appendChild(wrapper);
    }
  });
};

// ðŸ”¹ DELETE POST
window.deletePost = async (id) => {
  if(confirm("Are you sure to delete this post?")){
    await db.collection("vasai_news").doc(id).delete();
    loadPosts();
  }
};

loadPosts();
</script>
</body>
</html>
