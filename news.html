<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vasai Live News — Final</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
  body{background:#f6f7fb;color:#0b2540;font-family:Inter,Arial,Helvetica,sans-serif;}
  header{display:flex;align-items:center;justify-between;padding:12px;background:#1e40af;color:#fff;border-radius:8px;margin:10px;}
  header img{height:48px;width:48px;border-radius:8px;margin-right:10px;}
  .ticker,.notice-ticker{position:sticky;left:0;right:0;z-index:90;white-space:nowrap;overflow:hidden;}
  .ticker{background:#1e40af;color:#fff;padding:8px;margin:8px;border-radius:6px;}
  .notice-ticker{background:#dc2626;color:#fff;padding:8px;margin:8px;border-radius:6px;}
  .ticker span,.notice-ticker span{display:inline-block;padding-right:60px;animation:scroll 18s linear infinite;}
  @keyframes scroll{0%{transform:translateX(100%);}100%{transform:translateX(-100%);}}
  .posts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;padding:12px;}
  .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 6px 20px rgba(2,6,23,0.06);cursor:pointer;transition:transform .14s;}
  .card:hover{transform:scale(1.02);}
  .card .thumb{width:100%;height:180px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;}
  .card .thumb img{max-width:100%;max-height:100%;object-fit:contain;}
  .card-body{padding:12px;}
  .card-body h3{font-weight:700;font-size:18px;margin-bottom:6px;}
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:200;}
  .modal{background:#fff;border-radius:10px;max-width:900px;width:95%;max-height:90%;overflow:auto;padding:18px;position:relative;}
  .modal-close{position:absolute;right:12px;top:12px;background:#ef4444;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;}
  textarea{min-height:140px;}
  .small{font-size:.9rem;}
  .input{border:1px solid #e5e7eb;padding:.5rem;border-radius:.5rem;width:100%;}
</style>
</head>
<body>

<header class="mx-4">
  <div class="flex items-center">
    <img src="https://via.placeholder.com/48x48?text=VL" alt="logo">
    <div>
      <div class="font-bold text-xl">Vasai Live News</div>
      <div class="text-sm">Real-time local news portal</div>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <button id="loginBtn" class="bg-blue-600 text-white px-3 py-1 rounded small">Admin Login</button>
    <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded small hidden">Logout</button>
  </div>
</header>

<div class="ticker mx-4"><span id="tickerText">Loading headlines...</span></div>
<div class="notice-ticker mx-4"><span id="noticeText">Loading notice...</span></div>

<div id="noticeEditor" class="mx-4 hidden mb-3">
  <div class="bg-white p-3 rounded shadow">
    <label class="small font-semibold">Admin notice (scrolling)</label>
    <input id="noticeInput" class="input mt-2" placeholder="Write notice to scroll" />
    <div class="mt-2">
      <button id="saveNoticeBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Save Notice</button>
    </div>
  </div>
</div>

<!-- Admin Editor -->
<section id="editorArea" class="mx-4 hidden mb-4">
  <div class="bg-white rounded p-4 shadow">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-lg">Create / Edit Post</h2>
      <div class="text-sm text-gray-600">Logged in as admin.</div>
    </div>

    <div class="grid gap-3">
      <input id="aTitle" class="input" placeholder="Post title" />
      <input id="aCat" class="input" placeholder="Category (optional)" />
      <textarea id="aText" class="input" placeholder="Write content. Use [image:URL] to embed inline images."></textarea>

      <div class="flex gap-2">
        <input id="aImg" class="input" placeholder="Main image URL (optional)" />
        <input id="imgUpload" type="file" accept="image/*" class="hidden" />
        <button id="uploadBtn" class="bg-green-600 text-white px-3 py-2 rounded">Upload Image (imgbb)</button>
      </div>

      <div class="flex gap-2">
        <button id="publishBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Publish</button>
        <button id="clearBtn" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
        <div id="uploadStatus" class="text-sm text-gray-600 self-center"></div>
      </div>
      <div class="text-xs text-gray-500">Tip: after uploading, image URL will be inserted at cursor position inside content and placed into Main Image field.</div>
    </div>
  </div>
</section>

<!-- Category Buttons -->
<div id="categoryBtns" class="mx-4 mb-3 flex gap-2 overflow-auto"></div>

<!-- Posts Grid -->
<section id="postsGrid" class="posts-grid mx-4"></section>

<!-- Modal -->
<div id="modalBg" class="modal-bg flex">
  <div class="modal">
    <button id="modalClose" class="modal-close">Close</button>
    <div id="modalContent"></div>
  </div>
</div>

<!-- Firebase + App logic -->
<script type="module">
/* ------------------ Imports ------------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ------------------ CONFIG ------------------ */
// Firebase config (your all-madrsa)
const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e33f0c8bdef6d1a7f31e9f"
};
const IMGBB_API_KEY = "d12c2e4a8650157b2b6b9fe85336ea43"; // confirmed key
const ADMIN_EMAIL = "zaradigitalseva@gmail.com"; // change if needed

/* ------------------ Init ------------------ */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ------------------ DOM ------------------ */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const editorArea = document.getElementById('editorArea');
const noticeEditor = document.getElementById('noticeEditor');
const postsGrid = document.getElementById('postsGrid');
const modalBg = document.getElementById('modalBg');
const modalContent = document.getElementById('modalContent');
const modalClose = document.getElementById('modalClose');
const tickerText = document.getElementById('tickerText');
const noticeText = document.getElementById('noticeText');

const aTitle = document.getElementById('aTitle');
const aCat = document.getElementById('aCat');
const aText = document.getElementById('aText');
const aImg = document.getElementById('aImg');
const imgUpload = document.getElementById('imgUpload');
const uploadBtn = document.getElementById('uploadBtn');
const uploadStatus = document.getElementById('uploadStatus');
const publishBtn = document.getElementById('publishBtn');
const clearBtn = document.getElementById('clearBtn');
const saveNoticeBtn = document.getElementById('saveNoticeBtn');
const noticeInput = document.getElementById('noticeInput');
const categoryBtns = document.getElementById('categoryBtns');

let editingId = null;
let currentCategory = '';

/* ------------------ Auth ------------------ */
loginBtn.addEventListener('click', async () => {
  try {
    await signInWithPopup(auth, new GoogleAuthProvider());
  } catch (err) {
    alert('Login failed: ' + err.message);
  }
});
logoutBtn.addEventListener('click', () => signOut(auth));

onAuthStateChanged(auth, user => {
  if (user && user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
    loginBtn.classList.add('hidden');
    logoutBtn.classList.remove('hidden');
    editorArea.classList.remove('hidden');
    noticeEditor.classList.remove('hidden');
  } else {
    loginBtn.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    editorArea.classList.add('hidden');
    noticeEditor.classList.add('hidden');
  }
});

/* ------------------ Firestore listeners ------------------ */
const postsRef = collection(db, 'vasai_news');
const q = query(postsRef, orderBy('time','desc'));
onSnapshot(q, snap => {
  const posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderPosts(posts);
  renderCategories(posts);
  updateTicker(posts);
});

/* Notice live */
const noticeRef = doc(db, 'settings', 'notice');
onSnapshot(noticeRef, snap => {
  if (snap.exists()) noticeText.textContent = snap.data().text || '';
  else noticeText.textContent = '';
});

/* ------------------ Publish / Edit / Delete ------------------ */
publishBtn.addEventListener('click', async () => {
  const title = aTitle.value.trim();
  const category = aCat.value.trim();
  const text = aText.value.trim();
  const image = aImg.value.trim();

  if (!title || !text) return alert('Title and content required');

  const payload = { title, category, text, image, time: Date.now() };

  try {
    if (editingId) {
      await updateDoc(doc(db, 'vasai_news', editingId), payload);
      editingId = null;
      alert('Post updated');
    } else {
      await addDoc(postsRef, payload);
      alert('Post published');
    }
    clearEditor();
  } catch (err) {
    alert('Save failed: ' + err.message);
  }
});

clearBtn.addEventListener('click', clearEditor);
function clearEditor(){ aTitle.value=''; aCat.value=''; aText.value=''; aImg.value=''; editingId=null; uploadStatus.textContent=''; }

/* ------------------ Upload to ImgBB and insert URL into textarea ------------------ */
uploadBtn.addEventListener('click', ()=> imgUpload.click());

imgUpload.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  uploadStatus.textContent = 'Uploading...';
  const form = new FormData();
  form.append('image', file);
  try {
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: form });
    const j = await res.json();
    if (j && j.data && j.data.url) {
      const url = j.data.url;
      // insert at cursor position inside aText
      insertAtCursor(aText, `[image:${url}]`);
      // also set main image if empty
      if (!aImg.value) aImg.value = url;
      uploadStatus.textContent = 'Uploaded ✓';
    } else {
      uploadStatus.textContent = 'Upload failed';
      alert('ImgBB upload failed');
    }
  } catch (err) {
    uploadStatus.textContent = '';
    alert('Upload error: ' + err.message);
  } finally {
    imgUpload.value = '';
    setTimeout(()=> uploadStatus.textContent = '', 2500);
  }
});

/* helper: insert text at cursor in textarea */
function insertAtCursor(textarea, text) {
  const start = textarea.selectionStart || 0;
  const end = textarea.selectionEnd || 0;
  const before = textarea.value.substring(0, start);
  const after = textarea.value.substring(end);
  textarea.value = before + text + after;
  // place cursor after inserted text
  const pos = start + text.length;
  textarea.selectionStart = textarea.selectionEnd = pos;
  textarea.focus();
}

/* ------------------ Render posts & categories ------------------ */
function renderCategories(posts){
  const cats = [...new Set(posts.map(p => p.category).filter(Boolean))];
  categoryBtns.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = currentCategory === ''? 'bg-blue-600 text-white px-3 py-1 rounded':'border px-3 py-1 rounded';
  allBtn.textContent = 'All';
  allBtn.addEventListener('click', ()=> { currentCategory=''; renderPosts(posts); renderCategories(posts); });
  categoryBtns.appendChild(allBtn);
  cats.forEach(c=>{
    const b = document.createElement('button');
    b.className = currentCategory === c? 'bg-blue-600 text-white px-3 py-1 rounded':'border px-3 py-1 rounded';
    b.textContent = c;
    b.addEventListener('click', ()=> { currentCategory = c; renderPosts(posts); renderCategories(posts); });
    categoryBtns.appendChild(b);
  });
}

function renderPosts(posts){
  postsGrid.innerHTML = '';
  const filtered = currentCategory ? posts.filter(p => p.category === currentCategory) : posts;
  filtered.forEach(p => {
    const card = document.createElement('div');
    card.className = 'card';
    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    const imgEl = document.createElement('img');
    imgEl.src = p.image || extractFirstInlineImage(p.text) || 'https://via.placeholder.com/600x300?text=No+Image';
    thumb.appendChild(imgEl);

    const body = document.createElement('div');
    body.className = 'card-body';
    const h = document.createElement('h3'); h.textContent = p.title;
    const pEx = document.createElement('p');
    pEx.className = 'small text-gray-700';
    pEx.textContent = stripHtml(p.text).substring(0,140) + (stripHtml(p.text).length>140? '...':'');
    body.appendChild(h); body.appendChild(pEx);

    const readBtn = document.createElement('button');
    readBtn.className = 'bg-blue-600 text-white px-2 py-1 rounded text-sm mt-2';
    readBtn.textContent = 'Read More';
    readBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openModal(p); });

    body.appendChild(readBtn);
    card.appendChild(thumb);
    card.appendChild(body);
    card.addEventListener('click', ()=> openModal(p));
    postsGrid.appendChild(card);
  });
}

/* ------------------ Modal & admin controls ------------------ */
modalClose.addEventListener('click', ()=> modalBg.style.display='none');
modalBg.addEventListener('click', e => { if (e.target === modalBg) modalBg.style.display='none'; });

function openModal(post){
  modalContent.innerHTML = '';
  const title = document.createElement('h2'); title.className='text-2xl font-bold mb-2'; title.textContent = post.title;
  const meta = document.createElement('div'); meta.className='text-sm text-gray-500 mb-2'; meta.textContent = post.category || '';
  modalContent.appendChild(title); modalContent.appendChild(meta);

  // main image
  if (post.image) {
    const mainImg = document.createElement('img'); mainImg.src = post.image; mainImg.className='mb-3';
    modalContent.appendChild(mainImg);
  }

  // render body with [image:URL] replacements
  const bodyDiv = document.createElement('div');
  bodyDiv.innerHTML = formatNews(post.text);
  modalContent.appendChild(bodyDiv);

  // admin btns
  const user = auth.currentUser;
  if (user && user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
    const ctrl = document.createElement('div'); ctrl.className='flex gap-2 mt-4';
    const editBtn = document.createElement('button'); editBtn.className='bg-gray-200 px-3 py-1 rounded'; editBtn.textContent='✏️ Edit';
    editBtn.addEventListener('click', ()=> startEdit(post));
    const delBtn = document.createElement('button'); delBtn.className='bg-red-500 text-white px-3 py-1 rounded'; delBtn.textContent='🗑 Delete';
    delBtn.addEventListener('click', async ()=> {
      if (!confirm('Delete this post?')) return;
      await deleteDoc(doc(db, 'vasai_news', post.id));
      modalBg.style.display='none';
    });
    ctrl.appendChild(editBtn); ctrl.appendChild(delBtn);
    modalContent.appendChild(ctrl);
  }

  modalBg.style.display = 'flex';
}

/* start edit - populate editor with post */
function startEdit(post){
  editingId = post.id;
  aTitle.value = post.title || '';
  aCat.value = post.category || '';
  aText.value = post.text || '';
  aImg.value = post.image || '';
  modalBg.style.display = 'none';
  window.scrollTo({ top: 0, behavior:'smooth' });
}

/* ------------------ Helpers ------------------ */
function stripHtml(str){
  return (str || '').replace(/\[image:.*?\]/g, '').replace(/<\/?[^>]+(>|$)/g, '');
}

/* formatNews: replace [image:URL] tokens and newlines with proper HTML */
function formatNews(text){
  if(!text) return '';
  // escape HTML first to avoid injection
  const esc = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  // split by lines and convert [image:URL]
  const lines = esc.split(/\n+/);
  return lines.map(line => {
    const m = line.match(/\[image:(https?:\/\/[^\]]+)\]/);
    if (m) {
      const url = m[1];
      return `<div><img src="${url}" alt="" style="max-width:100%;border-radius:6px;margin:8px 0;"></div>`;
    } else {
      // convert plain text line to paragraph (preserve simple links if any)
      return `<p style="margin:6px 0;line-height:1.6;">${line.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" class="text-blue-600 underline">$1</a>')}</p>`;
    }
  }).join('');
}

/* extract first inline image token or main image */
function extractFirstInlineImage(text){
  if(!text) return null;
  const m = text.match(/\[image:(https?:\/\/[^\]]+)\]/);
  return m ? m[1] : null;
}

/* update ticker (top headlines) */
function updateTicker(posts){
  if(!posts || posts.length===0){ tickerText.textContent='No headlines yet'; return; }
  const top5 = posts.slice(0,6).map(p => p.title).join('  |  ');
  tickerText.textContent = top5;
}

/* ------------------ Notice save ------------------ */
saveNoticeBtn.addEventListener('click', async ()=>{
  const val = noticeInput.value || '';
  try {
    await setDoc(doc(db, 'settings', 'notice'), { text: val });
    alert('Notice updated');
  } catch (err) {
    alert('Failed to save notice: ' + err.message);
  }
});

/* ------------------ utility: create doc reference helper ------------------ */
import { doc as docRef } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
/* We used doc(db, ...) already above via named import; this line ensures bundlers know doc exists. */

/* ------------------ Initial placeholder texts ------------------ */
tickerText.textContent = 'Loading Vasai Live headlines...';

/* ------------------ End of module ------------------ */
</script>
</body>
</html>
