<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vasai Live News</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --accent:#0ea5a4; --title:#072a4b; --live:#d32f2f;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial; margin:0; background:var(--bg); color:#0b2540; -webkit-font-smoothing:antialiased;}
.container{max-width:1100px;margin:12px auto;padding:0 12px;}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;}
.brand{display:flex;align-items:center;gap:10px}
.logo{background:linear-gradient(90deg,#06b6d4,#0ea5a4);color:white;padding:8px 12px;border-radius:8px;font-weight:700;font-size:18px}
.tagline{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}
.search{padding:8px 12px;border-radius:10px;border:1px solid #e6e9ef;background:white;min-width:160px}
.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;color:var(--title);border:1px solid #e6e9ef}
.live-bar{background:var(--live);color:white;padding:6px 10px;border-radius:8px;font-weight:700;display:flex;gap:10px;align-items:center}
.top-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
.categories{display:flex;gap:8px;flex-wrap:wrap}
.category{background:white;padding:6px 10px;border-radius:999px;border:1px solid #e9eef6;color:var(--muted);cursor:pointer}
.category.active{border-color:var(--accent);color:var(--accent);box-shadow:0 6px 18px rgba(14,165,164,0.08)}

.grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
@media(min-width:900px){ .grid{grid-template-columns:repeat(3,1fr)} }
.card{background:var(--card);border-radius:10px;overflow:hidden;box-shadow:0 6px 20px rgba(2,6,23,0.06);display:flex;flex-direction:column;cursor:pointer;min-height:220px}
.card img{width:100%;height:160px;object-fit:cover}
.card-body{padding:12px;flex:1;display:flex;flex-direction:column}
.kicker{font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700}
.title{font-size:15px;font-weight:700;color:var(--title);margin:0 0 8px}
.excerpt{font-size:13px;color:#344155;flex:1}
.meta{display:flex;gap:8px;align-items:center;margin-top:10px;font-size:12px;color:var(--muted)}

.footer{margin:20px 0;padding:14px;border-radius:10px;background:white;text-align:center;color:var(--muted);box-shadow:0 6px 30px rgba(2,6,23,0.03)}

/* modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.55);z-index:80;padding:12px}
.modal-card{background:white;border-radius:10px;max-width:900px;width:100%;max-height:90vh;overflow:auto;padding:16px;box-shadow:0 30px 90px rgba(2,6,23,0.5)}
.modal-card img{width:100%;height:auto;max-height:420px;object-fit:contain;border-radius:8px;margin-bottom:12px}
.modal-close{position:absolute;right:18px;top:18px;background:#fff;border-radius:8px;border:none;padding:8px 10px;cursor:pointer}

/* admin drawer */
.admin-fab{position:fixed;right:16px;bottom:16px;background:var(--accent);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 20px 50px rgba(2,6,23,0.12);cursor:pointer;z-index:90}
.admin-drawer{position:fixed;right:16px;bottom:80px;width:360px;background:white;border-radius:12px;box-shadow:0 20px 80px rgba(2,6,23,0.12);padding:12px;display:none;z-index:90}
.form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.input,textarea{padding:8px;border-radius:8px;border:1px solid #e6e9ef;width:100%}
textarea{min-height:120px;resize:vertical}
.small{font-size:13px;color:var(--muted)}

/* small screens */
@media(max-width:420px){ .grid{grid-template-columns:1fr} .modal-card{padding:12px} .admin-drawer{width:95%} }
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo">Vasai Live</div>
      <div>
        <div style="font-weight:700">Vasai Live News</div>
        <div class="tagline">Tez • Saaf • Vasai ki Khabar</div>
      </div>
    </div>

    <div class="controls">
      <input id="search" class="search" placeholder="Search headlines or content...">
      <button id="clearBtn" class="btn ghost">Clear</button>
      <button id="loginBtn" class="btn">Admin Login</button>
      <button id="logoutBtn" class="btn" style="display:none">Logout</button>
    </div>
  </header>

  <div class="top-row">
    <div class="live-bar" id="liveBar">● LIVE</div>
    <div class="categories" id="cats"></div>
    <div style="margin-left:auto" class="small"><span id="countBadge">0</span> Articles</div>
  </div>

  <main id="mainGrid">
    <div class="grid" id="grid"></div>
  </main>

  <div class="footer">Vasai Live • © <span id="year"></span></div>
</div>

<!-- Article Modal -->
<div id="modal" class="modal" role="dialog" aria-hidden="true">
  <div class="modal-card" id="modalCard">
    <button class="modal-close" onclick="closeModal()">✕</button>
    <img id="modalImg" src="" alt="">
    <h2 id="modalTitle"></h2>
    <div id="modalKicker" class="kicker"></div>
    <div id="modalMeta" class="small"></div>
    <p id="modalContent" style="white-space:pre-wrap"></p>
  </div>
</div>

<!-- Admin floating -->
<button id="adminFab" class="admin-fab">Admin</button>
<div id="adminDrawer" class="admin-drawer" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <strong>Admin (zaradigitalseva@gmail.com)</strong>
    <button id="closeAdmin" class="btn ghost">Close</button>
  </div>

  <div id="loginArea" class="form-row">
    <button id="googleLogin" class="btn">Sign in with Google</button>
    <div id="loginMsg" class="small"></div>
  </div>

  <div id="editorArea" style="display:none">
    <div class="form-row"><label class="small">Title</label><input id="aTitle" class="input"></div>
    <div class="form-row"><label class="small">Category</label><input id="aCat" class="input" placeholder="Local"></div>
    <div class="form-row">
      <label class="small">Image</label>
      <input id="aImgFile" type="file" accept="image/*">
      <input id="aImg" class="input" placeholder="Image URL will fill after upload" readonly>
      <div class="small">Select file above to upload to IMGBB</div>
    </div>
    <div class="form-row"><label class="small">Short label (kicker)</label><input id="aKicker" class="input" placeholder="Breaking"></div>
    <div class="form-row"><label class="small">Content</label><textarea id="aContent"></textarea></div>

    <div style="display:flex;gap:8px;justify-content:space-between">
      <button id="saveArticle" class="btn">Publish</button>
      <button id="clearEditor" class="btn ghost">Clear</button>
    </div>

    <hr style="margin:12px 0">
    <div>
      <strong>Existing Articles</strong>
      <div id="adminList" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ========== CONFIG: change these ========== */
const firebaseConfig = {
  apiKey:"AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain:"all-madrsa.firebaseapp.com",
  projectId:"all-madrsa",
  storageBucket:"all-madrsa.appspot.com",
  messagingSenderId:"619313835874",
  appId:"1:619313835874:web:e387e1297663f11fc2463b11fc2463b11fc2463b"
};
const IMGBB_API_KEY = "d12c2e4a8650157b2b6b9fe85336ea43"; // replace with your key
const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
/* ========================================== */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

document.getElementById('year').textContent = new Date().getFullYear();

/* --- STATE --- */
let ARTICLES = []; // local cache (populated from Firestore)
const DEFAULT_CATS = ['All','Local','Politics','Technology','Sports','Business','Entertainment'];

/* --- DOM refs --- */
const grid = document.getElementById('grid');
const catsDiv = document.getElementById('cats');
const countBadge = document.getElementById('countBadge');
const searchInput = document.getElementById('search');
const clearBtn = document.getElementById('clearBtn');

const adminFab = document.getElementById('adminFab');
const adminDrawer = document.getElementById('adminDrawer');
const closeAdmin = document.getElementById('closeAdmin');
const loginArea = document.getElementById('loginArea');
const googleLogin = document.getElementById('googleLogin');
const loginMsg = document.getElementById('loginMsg');
const editorArea = document.getElementById('editorArea');
const aTitle = document.getElementById('aTitle');
const aCat = document.getElementById('aCat');
const aImgFile = document.getElementById('aImgFile');
const aImg = document.getElementById('aImg');
const aKicker = document.getElementById('aKicker');
const aContent = document.getElementById('aContent');
const saveArticle = document.getElementById('saveArticle');
const clearEditor = document.getElementById('clearEditor');
const adminList = document.getElementById('adminList');

const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');
const modalTitle = document.getElementById('modalTitle');
const modalKicker = document.getElementById('modalKicker');
const modalMeta = document.getElementById('modalMeta');
const modalContent = document.getElementById('modalContent');

/* --- UX helpers --- */
function showToast(msg){ loginMsg.textContent = msg; setTimeout(()=>{ if(loginMsg.textContent===msg) loginMsg.textContent=''; },2500); }
function uid(prefix='n'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

/* --- Categories render --- */
function renderCategories(){
  catsDiv.innerHTML = '';
  DEFAULT_CATS.forEach(c=>{
    const el = document.createElement('button');
    el.className = 'category' + (c==='All' ? ' active':'');
    el.textContent = c;
    el.onclick = ()=>{ ACTIVE_CAT = c; render(); renderCategories(); }
    catsDiv.appendChild(el);
  });
}
let ACTIVE_CAT = 'All';
let SEARCH = '';

/* --- Render grid --- */
function render(){
  const filtered = ARTICLES.filter(a=>{
    if(ACTIVE_CAT!=='All' && a.category!==ACTIVE_CAT) return false;
    if(SEARCH){
      const s = SEARCH.toLowerCase();
      return (a.title+a.content+(a.kicker||'')+a.category).toLowerCase().includes(s);
    }
    return true;
  }).sort((a,b)=>b.ts - a.ts);

  grid.innerHTML = '';
  countBadge.textContent = filtered.length;
  if(filtered.length===0){ grid.innerHTML = '<div style="padding:18px;background:white;border-radius:8px;text-align:center;">Koi article nahi mila</div>'; return; }
  filtered.forEach(a=>{
    const el = document.createElement('article');
    el.className = 'card';
    el.innerHTML = `
      <img src="${a.image||'https://via.placeholder.com/1200x800?text=No+Image'}" alt="">
      <div class="card-body">
        <div class="kicker">${a.kicker || a.category}</div>
        <h3 class="title">${a.title}</h3>
        <div class="excerpt">${(a.content||'').slice(0,120)}...</div>
        <div class="meta"><div>${a.category}</div><div style="margin-left:auto">${new Date(a.ts).toLocaleString()}</div></div>
      </div>
    `;
    el.addEventListener('click', ()=> openModal(a.id));
    grid.appendChild(el);
  });
}

/* --- Modal --- */
function openModal(id){
  const a = ARTICLES.find(x=>x.id===id); if(!a) return;
  modalImg.src = a.image||'https://via.placeholder.com/1200x800?text=No+Image';
  modalTitle.textContent = a.title;
  modalKicker.textContent = a.kicker || a.category;
  modalMeta.textContent = `${a.category} • ${new Date(a.ts).toLocaleString()}`;
  modalContent.textContent = a.content || '';
  modal.style.display = 'flex';
}
function closeModal(){ modal.style.display = 'none'; }

/* --- Search --- */
searchInput.addEventListener('input', e=>{ SEARCH = e.target.value.trim(); render(); });
clearBtn.addEventListener('click', ()=>{ searchInput.value=''; SEARCH=''; ACTIVE_CAT='All'; render(); renderCategories(); });

/* --- Admin drawer --- */
adminFab.addEventListener('click', ()=>{ adminDrawer.style.display = 'block'; adminDrawer.setAttribute('aria-hidden','false'); });
closeAdmin.addEventListener('click', ()=>{ adminDrawer.style.display='none'; adminDrawer.setAttribute('aria-hidden','true'); });

/* --- Auth: Google Sign-in, restrict to ADMIN_EMAIL --- */
googleLogin.addEventListener('click', async ()=>{
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    const res = await auth.signInWithPopup(provider);
    if(res.user && res.user.email===ADMIN_EMAIL){
      showToast('Logged in as admin');
      editorArea.style.display = 'block';
      loadAdminList(); // show admin list
    } else {
      showToast('Not authorized'); await auth.signOut();
    }
  }catch(e){ console.error(e); showToast('Login failed'); }
});
document.getElementById('loginBtn').addEventListener('click', ()=> adminDrawer.style.display='block');
document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await auth.signOut(); showToast('Logged out'); editorArea.style.display='none';
});

/* Keep login/logout button handling in header */
auth.onAuthStateChanged(user=>{
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  if(user && user.email===ADMIN_EMAIL){
    loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; editorArea.style.display='block';
    loadAdminList();
  } else {
    loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; editorArea.style.display='none';
  }
});

/* --- IMGBB upload --- */
aImgFile.addEventListener('change', async ()=>{
  if(!aImgFile.files.length) return;
  const file = aImgFile.files[0];
  const form = new FormData();
  form.append('image', file);
  showToast('Uploading image...');
  try{
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:'POST', body:form });
    const data = await res.json();
    if(data && data.success){
      aImg.value = data.data.url;
      showToast('Image uploaded');
    } else {
      console.error(data);
      showToast('Upload failed');
    }
  }catch(e){ console.error(e); showToast('Upload error'); }
});

/* --- Publish / Edit / Delete (Firestore) --- */
/* We'll store articles in Firestore collection 'vasai_news' for live updates */
async function publishArticle(){
  const title = aTitle.value.trim();
  const cat = aCat.value.trim() || 'Local';
  const kicker = aKicker.value.trim();
  const content = aContent.value.trim();
  const image = aImg.value.trim();
  if(!title || !content){ alert('Title and Content required'); return; }
  // if editing
  if(editingId){
    await db.collection('vasai_news').doc(editingId).update({ title, category:cat, kicker, content, image, ts: Date.now() });
    editingId = null;
    showToast('Updated');
  } else {
    await db.collection('vasai_news').add({ title, category:cat, kicker, content, image, ts: Date.now() });
    showToast('Published');
  }
  // clear editor
  aTitle.value=''; aCat.value=''; aKicker.value=''; aContent.value=''; aImg.value=''; aImgFile.value='';
}

/* hook up save button only for admin */
saveArticle.addEventListener('click', publishArticle);
clearEditor.addEventListener('click', ()=>{ aTitle.value=''; aCat.value=''; aKicker.value=''; aContent.value=''; aImg.value=''; aImgFile.value=''; editingId=null; });

/* admin list + edit/delete locally in drawer (reads from Firestore) */
let editingId = null;
function loadAdminList(){
  // populate admin list from Firestore
  db.collection('vasai_news').orderBy('ts','desc').get().then(snapshot=>{
    adminList.innerHTML = '';
    snapshot.forEach(doc=>{
      const d = doc.data();
      const row = document.createElement('div');
      row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 0';
      row.innerHTML = `<div style="flex:1"><strong style="display:block">${d.title}</strong><div class="small">${d.category} • ${new Date(d.ts).toLocaleString()}</div></div>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" data-id="${doc.id}">Edit</button>
          <button class="btn" data-id="${doc.id}">Delete</button>
        </div>`;
      const editBtn = row.querySelector('.btn.ghost');
      const delBtn = row.querySelector('.btn:not(.ghost)');
      editBtn.onclick = async ()=>{
        editingId = doc.id;
        aTitle.value = d.title; aCat.value = d.category; aImg.value = d.image || ''; aKicker.value = d.kicker || ''; aContent.value = d.content || '';
        showToast('Editing'); window.scrollTo({top:0,behavior:'smooth'});
      };
      delBtn.onclick = async ()=>{
        if(!confirm('Delete this article?')) return;
        await db.collection('vasai_news').doc(doc.id).delete();
        showToast('Deleted');
      };
      adminList.appendChild(row);
    });
  });
}

/* --- Live subscription: onSnapshot to keep ARTICLES up to date in realtime --- */
db.collection('vasai_news').orderBy('ts','desc').onSnapshot(snapshot=>{
  const arr = [];
  snapshot.forEach(doc=>{
    const d = doc.data(); d.id = doc.id;
    arr.push(d);
  });
  ARTICLES = arr;
  render();
  // highlight latest as breaking: show its title briefly in live bar
  if(ARTICLES.length>0){
    const latest = ARTICLES[0];
    document.getElementById('liveBar').textContent = '● LIVE • ' + latest.title;
    // small timeout to revert to just LIVE after a while
    clearTimeout(window._liveBarTimer);
    window._liveBarTimer = setTimeout(()=> document.getElementById('liveBar').textContent = '● LIVE', 8000);
  } else document.getElementById('liveBar').textContent = '● LIVE';
});

/* --- Initial UI --- */
renderCategories();
render();
</script>
</body>
</html>
