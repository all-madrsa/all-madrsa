<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Vasai Live â€” Admin Only Posting (imgbb)</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">

<header class="bg-blue-800 text-white p-4 flex justify-between items-center">
  <h1 class="text-xl font-semibold">Vasai Live News</h1>
  <div>
    <button id="loginBtn" class="bg-white text-blue-800 px-3 py-1 rounded">Login with Google</button>
    <button id="logoutBtn" class="hidden bg-red-600 px-3 py-1 rounded">Logout</button>
  </div>
</header>

<section id="editorArea" class="hidden p-4 border-t">
  <h2 class="text-lg font-semibold mb-2">Create / Edit Post</h2>
  <input id="aTitle" class="border p-2 w-full mb-2 rounded" placeholder="Post Title" />
  <input id="aCat" class="border p-2 w-full mb-2 rounded" placeholder="Category" />
  <div id="blocksList" class="mb-3"></div>
  <div class="flex gap-2">
    <button id="addTextBtn" class="bg-gray-200 px-3 py-1 rounded">Add Text</button>
    <button id="addImageBtn" class="bg-gray-200 px-3 py-1 rounded">Add Image</button>
  </div>
  <button id="publishBtn" class="mt-3 bg-blue-700 text-white px-4 py-2 rounded">Publish</button>
</section>

<section id="postsArea" class="p-4 grid gap-3"></section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:312ec03e62fd49d3d92e60"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

const ADMIN_EMAIL = "zaradigitalseva@gmail.com";

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const editorArea = document.getElementById("editorArea");
const postsArea = document.getElementById("postsArea");
const blocksList = document.getElementById("blocksList");

// Login / Logout
loginBtn.onclick = async () => {
  const provider = new GoogleAuthProvider();
  try { await signInWithPopup(auth, provider); } catch(e){ alert(e.message); }
};
logoutBtn.onclick = () => signOut(auth);

// Auth check
onAuthStateChanged(auth, (user) => {
  if(user && user.email === ADMIN_EMAIL){
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    editorArea.classList.remove("hidden");
  } else {
    editorArea.classList.add("hidden");
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
  }
  loadPosts();
});

// Load posts
async function loadPosts(){
  postsArea.innerHTML = "";
  const q = query(collection(db, "vasai_news"), orderBy("ts","desc"));
  const snap = await getDocs(q);
  snap.forEach(doc => {
    const d = doc.data();
    const div = document.createElement("div");
    div.className = "p-3 bg-white rounded shadow";
    let blocksHtml = "";
    (d.blocks||[]).forEach(b=>{
      if(b.type==="text") blocksHtml+=`<p>${b.text}</p>`;
      if(b.type==="image") blocksHtml+=`<img src="${b.url}" class="w-full rounded mt-2 shadow"/>`;
    });
    div.innerHTML = `
      <h3 class="font-semibold text-lg">${d.title}</h3>
      <p class="text-sm text-gray-600">${d.category} â€¢ ${new Date(d.ts).toLocaleString()}</p>
      ${blocksHtml}
    `;
    postsArea.appendChild(div);
  });
}

// Add text block
document.getElementById("addTextBtn").onclick = ()=>{
  const inp = document.createElement("textarea");
  inp.className="border w-full p-2 rounded mt-2";
  inp.placeholder="Write text...";
  blocksList.appendChild(inp);
};

// Add image block (imgbb)
document.getElementById("addImageBtn").onclick = ()=>{
  const input = document.createElement("input");
  input.type="file"; input.accept="image/*"; input.click();

  input.onchange = async (e)=>{
    const file = e.target.files[0];
    if(!file) return;

    const uploading = document.createElement("p");
    uploading.textContent="Uploading image...";
    uploading.className="text-sm text-gray-500 mt-2";
    blocksList.appendChild(uploading);

    try{
      const form = new FormData();
      form.append("image", file);
      const API_KEY = "YOUR_IMGBB_API_KEY_HERE"; // ðŸ”‘ Replace with your imgbb key
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`,{
        method:"POST",
        body: form
      });
      const data = await res.json();
      if(data.success){
        const url = data.data.url;
        uploading.remove();
        const img = document.createElement("img");
        img.src=url;
        img.className="w-full rounded mt-2 shadow";
        blocksList.appendChild(img);

        const hidden = document.createElement("input");
        hidden.type="hidden"; hidden.dataset.type="image"; hidden.value=url;
        blocksList.appendChild(hidden);

        alert("âœ… Image uploaded successfully!");
      } else throw new Error("Upload failed");
    } catch(err){
      uploading.remove();
      alert("âŒ Upload failed: "+err.message);
      console.error(err);
    }
  }
};

// Publish post
document.getElementById("publishBtn").onclick=async ()=>{
  const user = auth.currentUser;
  if(!user || user.email!==ADMIN_EMAIL){ alert("Only admin can post!"); return; }

  const title = document.getElementById("aTitle").value;
  const category = document.getElementById("aCat").value;
  if(!title) return alert("Title is required");

  const blocks = [];
  blocksList.querySelectorAll("textarea,input[type=hidden]").forEach(el=>{
    if(el.tagName==="TEXTAREA") blocks.push({type:"text",text:el.value});
    if(el.dataset.type==="image") blocks.push({type:"image",url:el.value});
  });

  await addDoc(collection(db,"vasai_news"),{
    title, category, blocks, ts:Date.now(), author:user.email
  });

  alert("Post published!");
  document.getElementById("aTitle").value="";
  document.getElementById("aCat").value="";
  blocksList.innerHTML="";
  loadPosts();
};

loadPosts();
</script>
</body>
</html>
