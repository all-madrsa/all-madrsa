<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vasai Live News</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#f6f7fb;color:#0b2540;font-family:Arial,sans-serif;margin:0;padding:0;overflow-x:hidden;}
header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#1e40af;color:white;border-radius:6px;margin-bottom:6px;}
.header-left{display:flex;align-items:center;}
header img{height:50px;width:50px;border-radius:6px;margin-right:8px;}
header h1{text-shadow:2px 2px 4px #000;font-weight:800;font-size:22px;}
.header-buttons{display:flex;gap:6px;}
.header-buttons button{padding:3px 6px;font-size:12px;border-radius:4px;font-weight:600;text-shadow:1px 1px 2px #000;cursor:pointer;}
.card{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 20px rgba(2,6,23,0.06);padding:12px;margin-bottom:12px;cursor:pointer;}
.card img{width:100%;border-radius:6px;margin-bottom:6px;}
.card h3{font-weight:700;margin-bottom:4px;font-size:18px;}
.card .meta{font-size:12px;color:#6b7280;margin-bottom:6px;}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:50;}
.modal{background:#fff;border-radius:10px;max-width:500px;width:90%;max-height:80%;overflow-y:auto;padding:16px;position:relative;}
.modal-close{position:absolute;top:8px;right:8px;background:#f87171;color:white;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;}
textarea{resize:none;}
.ticker{background:#1e40af;color:white;padding:6px;overflow:hidden;white-space:nowrap;margin-bottom:6px;}
.ticker span{display:inline-block;padding-right:50px;animation:scroll 15s linear infinite;}
@keyframes scroll{0%{transform:translateX(100%);}100%{transform:translateX(-100%);}}
.category-btns{display:flex;gap:6px;overflow-x:auto;margin-bottom:12px;}
.category-btns button{flex-shrink:0;padding:4px 8px;border-radius:6px;border:1px solid #3b82f6;color:#3b82f6;cursor:pointer;}
.category-btns button.active{background:#3b82f6;color:white;}
.social-share{display:flex;gap:6px;margin-top:8px;}
.social-share button{flex:1;padding:4px;border-radius:6px;border:1px solid #3b82f6;color:#3b82f6;font-size:12px;}
.notice-ticker{background:#f59e0b;color:white;padding:6px;overflow:hidden;white-space:nowrap;margin-bottom:6px;font-weight:bold;}
.notice-ticker span{display:inline-block;padding-right:50px;animation:scroll 20s linear infinite;}
</style>
</head>
<body class="p-2">

<header>
  <div class="header-left">
    <img src="https://i.postimg.cc/vTb8F94w/vasalive-png.jpg" alt="Logo">
    <h1>Vasai Live News</h1>
  </div>
  <div class="header-buttons">
    <button id="loginBtn" class="bg-blue-700 text-white">Login</button>
    <button id="logoutBtn" class="hidden bg-red-600 text-white">Logout</button>
    <button class="bg-yellow-500 text-white">About</button>
    <button class="bg-green-500 text-white">Contact</button>
  </div>
</header>

<!-- NEWS TICKER -->
<div class="ticker"><span id="tickerText">Loading latest news...</span></div>

<!-- NOTICE TICKER -->
<div class="notice-ticker"><span id="noticeText">Admin notice will appear here...</span></div>

<!-- CATEGORY FILTER -->
<div class="category-btns" id="categoryBtns"></div>

<!-- ADMIN POST PANEL -->
<section id="editorArea" class="hidden p-2 mb-4 bg-white rounded shadow">
  <h2 class="font-semibold mb-2">Create / Edit Post</h2>
  <input id="aTitle" class="border p-2 w-full mb-2 rounded" placeholder="Title">
  <input id="aCat" class="border p-2 w-full mb-2 rounded" placeholder="Category">
  <div class="flex gap-2 mb-2">
    <button id="addTextBtn" class="bg-gray-200 px-3 py-1 rounded">Add Text</button>
    <button id="addImageBtn" class="bg-gray-200 px-3 py-1 rounded">Add Image</button>
  </div>
  <div id="blocksList" class="mb-3"></div>
  <div class="flex gap-2">
    <button id="publishBtn" class="bg-blue-700 text-white px-4 py-2 rounded">Publish</button>
    <button id="clearBtn" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
  </div>
  <div class="mt-2">
    <input id="noticeInput" class="border p-2 w-full rounded" placeholder="Set scrolling notice text (Admin only)">
    <button id="noticeBtn" class="bg-orange-500 text-white px-3 py-1 rounded mt-1">Update Notice</button>
  </div>
</section>

<!-- POSTS LIST -->
<section id="postsArea"></section>

<!-- MODAL -->
<div id="modalBg" class="modal-bg flex">
  <div class="modal">
    <button id="modalClose" class="modal-close">X</button>
    <div id="modalContent"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:312ec03e62fd49d3d92e60"
};
const IMGBB_API_KEY = "c4bc97c133edb76e062de6d070df67e4";
const ADMIN_EMAIL = "zaradigitalseva@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const editorArea = document.getElementById("editorArea");
const blocksList = document.getElementById("blocksList");
const postsArea = document.getElementById("postsArea");
const aTitle = document.getElementById("aTitle");
const aCat = document.getElementById("aCat");
const publishBtn = document.getElementById("publishBtn");
const clearBtn = document.getElementById("clearBtn");
const modalBg = document.getElementById("modalBg");
const modalContent = document.getElementById("modalContent");
const modalClose = document.getElementById("modalClose");
const categoryBtns = document.getElementById("categoryBtns");
const tickerText = document.getElementById("tickerText");
const noticeText = document.getElementById("noticeText");
const noticeInput = document.getElementById("noticeInput");
const noticeBtn = document.getElementById("noticeBtn");

let editingId = null;
let currentCategory = null;

// LOGIN / LOGOUT
loginBtn.onclick = async () => {
  const provider = new GoogleAuthProvider();
  try { await signInWithPopup(auth, provider); } catch(e){ alert("Login failed"); console.error(e);}
};
logoutBtn.onclick = async ()=>await signOut(auth);

// AUTH STATE
onAuthStateChanged(auth,user=>{
  if(user && user.email===ADMIN_EMAIL){
    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    editorArea.classList.remove("hidden");
  } else {
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    editorArea.classList.add("hidden");
  }
  loadPosts();
});

// ADD BLOCKS
document.getElementById("addTextBtn").onclick = ()=>{
  const t=document.createElement("textarea"); t.className="border w-full p-2 rounded mt-2"; t.placeholder="Text..."; blocksList.appendChild(t);
};
document.getElementById("addImageBtn").onclick = ()=>{
  const div=document.createElement("div"); div.className="mt-2";
  const inputFile=document.createElement("input"); inputFile.type="file"; inputFile.accept="image/*"; inputFile.className="border p-1 rounded w-full";
  const urlInput=document.createElement("input"); urlInput.type="text"; urlInput.placeholder="Uploaded URL"; urlInput.className="border p-1 rounded w-full mt-1";
  div.appendChild(inputFile); div.appendChild(urlInput); blocksList.appendChild(div);
  inputFile.addEventListener("change",async()=>{
    if(!inputFile.files.length) return;
    const file=inputFile.files[0];
    const form=new FormData(); form.append("image",file);
    try{
      const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:form});
      const data=await res.json();
      if(data.success){ urlInput.value=data.data.url; alert("Image uploaded"); }
      else throw new Error("Upload failed");
    }catch(e){ alert("Upload failed"); console.error(e);}
  });
};

// PUBLISH
publishBtn.onclick=async()=>{
  const user=auth.currentUser; if(!user || user.email!==ADMIN_EMAIL) return alert("Only admin can post!");
  const title=aTitle.value.trim(); const category=aCat.value.trim() || "Uncategorized";
  if(!title) return alert("Title required");
  const blocks=[]; for(const el of blocksList.children){
    if(el.tagName==="TEXTAREA") blocks.push({type:"text",text:el.value});
    else if(el.querySelector("input[type=text]")) blocks.push({type:"image",url:el.querySelector("input[type=text]").value});
  }
  if(blocks.length===0) return alert("Add text or image block");
  try{
    if(editingId){
      await updateDoc(doc(db,"vasai_news",editingId),{title,category,blocks});
      editingId=null; alert("Post updated!");
    } else {
      await addDoc(collection(db,"vasai_news"),{title,category,blocks,ts:Date.now(),author:user.email});
      alert("Post published!");
    }
    aTitle.value=""; aCat.value=""; blocksList.innerHTML=""; loadPosts();
  }catch(e){ alert("Publish failed"); console.error(e);}
};

// CLEAR
clearBtn.onclick=()=>{aTitle.value="";aCat.value="";blocksList.innerHTML=""; editingId=null;};

// UPDATE NOTICE
noticeBtn.onclick=()=>{
  const text = noticeInput.value.trim();
  if(text) noticeText.innerText = text;
  else alert("Enter notice text!");
};

// LOAD POSTS
async function loadPosts(){
  postsArea.innerHTML=""; categoryBtns.innerHTML="";
  const snap=await getDocs(query(collection(db,"vasai_news"),orderBy("ts","desc")));
  const categories=new Set(); const posts=[];
  snap.forEach(docSnap=>{ const d=docSnap.data(); d.id=docSnap.id; posts.push(d); if(d.category) categories.add(d.category); });
  tickerText.innerHTML = posts.slice(0,5).map(p=>p.title).join(" • ");

  // CATEGORY BUTTONS
  const allBtn=document.createElement("button"); allBtn.textContent="All"; allBtn.className="active";
  allBtn.onclick=()=>{ currentCategory=null; Array.from(categoryBtns.children).forEach(b=>b.classList.remove("active")); allBtn.classList.add("active"); renderPosts(posts);}
  categoryBtns.appendChild(allBtn);
  categories.forEach(cat=>{ const btn=document.createElement("button"); btn.textContent=cat;
    btn.onclick=()=>{ currentCategory=cat; Array.from(categoryBtns.children).forEach(b=>b.classList.remove("active")); btn.classList.add("active"); renderPosts(posts);}
    categoryBtns.appendChild(btn);
  });

  renderPosts(posts);
}

// RENDER POSTS
function renderPosts(posts){
  postsArea.innerHTML="";
  const filtered=currentCategory?posts.filter(p=>p.category===currentCategory):posts;
  filtered.forEach(d=>{
    const card=document.createElement("div"); card.className="card";
    const firstImg=d.blocks.find(b=>b.type==="image")?.url||"";
    card.innerHTML=`${firstImg?`<img src="${firstImg}">`:''}<h3>${d.title}</h3><div class="meta">${d.category} • ${new Date(d.ts).toLocaleString()}</div>`;
    card.onclick=()=>{
      modalContent.innerHTML=`<h2 class="text-lg font-bold mb-2">${d.title}</h2><div class="meta mb-2">${d.category}</div>`;
      d.blocks.forEach(b=>{ if(b.type==="text") modalContent.innerHTML+=`<p class="mb-2">${b.text}</p>`; else if(b.type==="image") modalContent.innerHTML+=`<img src="${b.url}" class="w-full mb-2 rounded">`; });
      modalContent.innerHTML+='<div class="social-share"><button onclick="navigator.share({title:`'+d.title+'`,url:window.location.href})">Share</button></div>';
      const user=auth.currentUser;
      if(user && user.email===ADMIN_EMAIL){
        const editBtn=document.createElement("button"); editBtn.className="bg-gray-200 px-3 py-1 rounded mr-2"; editBtn.textContent="Edit";
        const delBtn=document.createElement("button"); delBtn.className="bg-red-500 text-white px-3 py-1 rounded"; delBtn.textContent="Delete";
        editBtn.onclick=(e)=>{ e.stopPropagation(); editingId=d.id; aTitle.value=d.title; aCat.value=d.category; blocksList.innerHTML=""; d.blocks.forEach(b=>{if(b.type==="text"){const t=document.createElement("textarea");t.className="border w-full p-2 rounded mt-2";t.value=b.text;blocksList.appendChild(t);}else if(b.type==="image"){const div=document.createElement("div"); const urlInput=document.createElement("input"); urlInput.type="text"; urlInput.className="border w-full p-1 rounded mt-1"; urlInput.value=b.url; div.appendChild(urlInput); blocksList.appendChild(div);} }); modalBg.style.display="none"; };
        delBtn.onclick=async(e)=>{ e.stopPropagation(); if(confirm("Delete this post?")) await deleteDoc(doc(db,"vasai_news",d.id)).then(()=>loadPosts()); modalBg.style.display="none"; };
        modalContent.appendChild(editBtn); modalContent.appendChild(delBtn);
      }
      modalBg.style.display="flex";
    };
    postsArea.appendChild(card);
  });
}

// MODAL CLOSE
modalClose.onclick=()=>{modalBg.style.display="none";}
modalBg.onclick=e=>{if(e.target===modalBg) modalBg.style.display="none";}
</script>
</body>
</html>
