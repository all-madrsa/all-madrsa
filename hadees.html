<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hadees | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background: url('madina.png') no-repeat center center fixed;
  background-size: cover;
}
.btn-3d {
  color: #fff;
  font-weight: 700;
  border-radius: 10px;
  box-shadow: 0 6px 0 rgba(0,0,0,.25), 0 8px 14px rgba(0,0,0,.25);
  transition: transform .12s ease, box-shadow .12s ease;
  padding: 0.5rem 1rem;
  margin: 0.2rem;
  cursor: pointer;
}
.btn-3d:active {
  transform: translateY(3px);
  box-shadow: 0 3px 0 rgba(0,0,0,.25);
}
.post-box {
  background-color: rgba(255,255,255,0.85);
  border-radius: 0.5rem;
  padding: 1rem;
  margin: 0.5rem 0;
}
.post-author {
  font-weight: 700;
  margin-bottom: 0.3rem;
}
#hadeesPopup {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 50;
}
#hadeesPopupContent {
  background: #fff;
  border-radius: 0.5rem;
  max-width: 90%;
  max-height: 80%;
  overflow-y: auto;
  padding: 1rem;
  text-align: center;
}
.popup-btn {
  margin: 0.5rem;
  padding: 0.5rem 1rem;
  background: #0077cc;
  color: #fff;
  border-radius: 0.5rem;
  cursor: pointer;
}
</style>
</head>
<body class="min-h-screen">

<div class="max-w-3xl mx-auto p-4">

  <h1 class="text-2xl font-bold text-center text-white mb-4">üìú Hadees</h1>

  <!-- Add Hadees Button -->
  <div class="text-center mb-4">
    <button id="addHadeesBtn" class="btn-3d">‚ûï Add Hadees</button>
  </div>

  <!-- Hadees List -->
  <div id="hadeesList"></div>

</div>

<!-- Popup -->
<div id="hadeesPopup" class="flex">
  <div id="hadeesPopupContent">
    <div id="popupText" class="mb-4"></div>
    <div>
      <button id="nextBtn" class="popup-btn">Next</button>
      <button id="closeBtn" class="popup-btn">Close</button>
    </div>
  </div>
</div>

<!-- Firebase Scripts -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:e387e1297663f11fc2463b"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const addHadeesBtn = document.getElementById("addHadeesBtn");
const hadeesList = document.getElementById("hadeesList");
const hadeesPopup = document.getElementById("hadeesPopup");
const popupText = document.getElementById("popupText");
const nextBtn = document.getElementById("nextBtn");
const closeBtn = document.getElementById("closeBtn");

const ADMIN_EMAIL = "zaradigitalseva@gmail.com";

let currentUser = null;
let allHadees = [];
let popupIndex = 0;

function loginRedirect() {
  window.location.href = "login.html";
}

// Handle Add Hadees Button
onAuthStateChanged(auth, (user)=>{
  currentUser = user;
  if(!user){
    addHadeesBtn.onclick = ()=>loginRedirect();
  } else {
    addHadeesBtn.onclick = async ()=>{
      const text = prompt("‡§Ö‡§™‡§®‡•Ä Hadees ‡§≤‡§ø‡§ñ‡•á‡§Ç:");
      if(!text) return;
      await addDoc(collection(db,"hadees"),{
        hadees:text,
        uid:user.uid,
        userName:user.displayName||user.email,
        approved:false,
        createdAt: serverTimestamp()
      });
      alert("‚úÖ Hadees submitted for admin approval!");
    };
  }
});

// Load Hadees
const q = query(collection(db,"hadees"), orderBy("createdAt","desc"));
onSnapshot(q, qSnap=>{
  allHadees=[];
  hadeesList.innerHTML="";
  qSnap.forEach(docSnap=>{
    const d = docSnap.data();
    d.id = docSnap.id;
    allHadees.push(d);
    const box = document.createElement("div");
    box.className="post-box";

    // Colorful border
    box.style.borderLeft = `5px solid hsl(${Math.random()*360}, 70%, 50%)`;

    box.innerHTML=`
      <div class="post-author">${d.userName} ${d.approved?"‚úÖ":"‚è≥"}</div>
      <div class="post-text text-sm">${d.hadees.substring(0,50)}${d.hadees.length>50?"...":""}</div>
      <div class="mt-2 flex flex-wrap gap-2">
        <button class="btn-3d viewBtn">View</button>
        ${currentUser && (currentUser.uid===d.uid || currentUser.email===ADMIN_EMAIL)?`<button class="btn-3d deleteBtn">Delete</button>`:""}
        ${currentUser && currentUser.email===ADMIN_EMAIL && !d.approved?`<button class="btn-3d approveBtn">Approve</button>`:""}
      </div>
    `;
    hadeesList.appendChild(box);

    // View Button
    box.querySelector(".viewBtn").onclick=()=>{
      popupIndex = allHadees.findIndex(h=>h.id===d.id);
      showPopup();
    };

    // Delete Button
    if(box.querySelector(".deleteBtn")){
      box.querySelector(".deleteBtn").onclick=async()=>{
        if(confirm("Are you sure to delete?")){
          await deleteDoc(doc(db,"hadees",d.id));
        }
      };
    }

    // Approve Button
    if(box.querySelector(".approveBtn")){
      box.querySelector(".approveBtn").onclick=async()=>{
        await updateDoc(doc(db,"hadees",d.id),{approved:true});
      };
    }
  });
});

// Popup Functions
function showPopup(){
  if(popupIndex<0 || popupIndex>=allHadees.length) return;
  let d = allHadees[popupIndex];
  popupText.textContent = d.hadees;
  hadeesPopup.style.display="flex";
}
nextBtn.onclick=()=>{
  popupIndex++;
  if(popupIndex>=allHadees.length) popupIndex=0;
  showPopup();
};
closeBtn.onclick=()=>{ hadeesPopup.style.display="none"; };
</script>
</body>
</html>
