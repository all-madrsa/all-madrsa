<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìú Hadees Page</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: url('madina.png') no-repeat center center fixed;
      background-size: cover;
    }
    .popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .popup-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      position: relative;
    }
  </style>
</head>
<body class="text-white">

  <!-- Header -->
  <header class="bg-black bg-opacity-60 p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">üìú Hadees</h1>
    <div>
      <button id="loginBtn" class="bg-green-600 px-3 py-1 rounded">Login</button>
      <button id="logoutBtn" class="bg-red-600 px-3 py-1 rounded hidden">Logout</button>
      <button id="postBtn" class="bg-blue-600 px-3 py-1 rounded hidden">‚ûï Post</button>
    </div>
  </header>

  <!-- Post Form -->
  <section id="postSection" class="hidden p-4">
    <textarea id="hadeesInput" class="w-full p-2 text-black rounded" rows="3" placeholder="‚úçÔ∏è Write Hadees..."></textarea>
    <button id="submitPost" class="bg-purple-600 px-4 py-2 rounded mt-2">Post Hadees</button>
  </section>

  <!-- Posts List -->
  <main id="postsList" class="p-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></main>

  <!-- Popup -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <p id="popupText"></p>
      <div class="mt-4 flex justify-between">
        <button id="closePopup" class="bg-red-500 px-3 py-1 rounded">‚ùå Close</button>
        <button id="nextPopup" class="bg-green-500 px-3 py-1 rounded">‚û°Ô∏è Next</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, updateDoc, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // üîπ Firebase Config (‡§Ö‡§™‡§®‡§æ config ‡§Ø‡§π‡§æ‡§Ç ‡§≠‡§∞‡•ã)
const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:e387e1297663f11fc2463b"
};
  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const postBtn = document.getElementById("postBtn");
  const postSection = document.getElementById("postSection");
  const submitPost = document.getElementById("submitPost");
  const hadeesInput = document.getElementById("hadeesInput");
  const postsList = document.getElementById("postsList");

  let currentUser = null;

  // Login
  loginBtn.addEventListener("click", async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  });

  // Logout
  logoutBtn.addEventListener("click", () => signOut(auth));

  // User State Change
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      postBtn.classList.remove("hidden");
    } else {
      loginBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
      postBtn.classList.add("hidden");
      postSection.classList.add("hidden");
    }
  });

  // Show Post Form
  postBtn.addEventListener("click", () => {
    if (currentUser) {
      postSection.classList.toggle("hidden");
    } else {
      alert("‚ö†Ô∏è Please login to post!");
    }
  });

  // Submit Post
  submitPost.addEventListener("click", async () => {
    if (hadeesInput.value.trim() === "") return alert("‚ùå Write something");
    await addDoc(collection(db, "hadees"), {
      text: hadeesInput.value,
      uid: currentUser.uid,
      email: currentUser.email,
      approved: false,
      created: new Date()
    });
    hadeesInput.value = "";
    alert("‚úÖ Submitted for approval!");
  });

  // Load Posts
  const q = query(collection(db, "hadees"), orderBy("created", "desc"));
  onSnapshot(q, (snapshot) => {
    postsList.innerHTML = "";
    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const postId = docSnap.id;

      // Reject posts public ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡•á‡§Ç‡§ó‡•á
      if (data.approved === false && data.email !== "zaradigitalseva@gmail.com") return;

      const card = document.createElement("div");
      card.className = "p-4 rounded shadow text-black";
      card.style.background = `hsl(${Math.random()*360},70%,80%)`;

      card.innerHTML = `
        <p class="font-bold">${data.text}</p>
        <p class="text-xs mt-2">‚úçÔ∏è ${data.email}</p>
      `;

      // Poster & Admin delete button
      if (currentUser && (currentUser.email === data.email || currentUser.email === "zaradigitalseva@gmail.com")) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è Delete";
        delBtn.className = "bg-red-500 text-white px-2 py-1 rounded mt-2";
        delBtn.onclick = async () => {
          await deleteDoc(doc(db, "hadees", postId));
        };
        card.appendChild(delBtn);
      }

      // Admin controls
      if (currentUser && currentUser.email === "zaradigitalseva@gmail.com") {
        if (!data.approved) {
          const approveBtn = document.createElement("button");
          approveBtn.textContent = "‚úÖ Approve";
          approveBtn.className = "bg-green-500 text-white px-2 py-1 rounded ml-2";
          approveBtn.onclick = async () => {
            await updateDoc(doc(db, "hadees", postId), { approved: true });
          };

          const rejectBtn = document.createElement("button");
          rejectBtn.textContent = "‚ùå Reject";
          rejectBtn.className = "bg-gray-500 text-white px-2 py-1 rounded ml-2";
          rejectBtn.onclick = async () => {
            await deleteDoc(doc(db, "hadees", postId));
          };

          card.appendChild(approveBtn);
          card.appendChild(rejectBtn);
        }
      }

      postsList.appendChild(card);
    });
  });

  // üîπ Popup Logic (Approved posts only)
  const popup = document.getElementById("popup");
  const popupText = document.getElementById("popupText");
  const closePopup = document.getElementById("closePopup");
  const nextPopup = document.getElementById("nextPopup");

  let approvedPosts = [];
  let currentIndex = 0;

  onSnapshot(q, (snapshot) => {
    approvedPosts = [];
    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      if (data.approved) {
        approvedPosts.push(data.text);
      }
    });
    if (approvedPosts.length > 0) {
      currentIndex = 0;
      showPopup();
    }
  });

  function showPopup() {
    popupText.textContent = approvedPosts[currentIndex];
    popup.classList.remove("hidden");
  }

  closePopup.addEventListener("click", () => popup.classList.add("hidden"));
  nextPopup.addEventListener("click", () => {
    currentIndex = (currentIndex + 1) % approvedPosts.length;
    showPopup();
  });
</script>
</body>
</html>
