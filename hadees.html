<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hadees | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background: url('madina-bg.jpg') no-repeat center center fixed; background-size: cover; }
  .card { background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); border-radius: 0.5rem; padding:1rem; }
  .btn-3d { font-weight:700; border-radius:0.5rem; box-shadow:0 4px 0 rgba(0,0,0,.25),0 6px 12px rgba(0,0,0,.2); transition: transform .12s ease; }
  .btn-3d:active { transform:translateY(2px); box-shadow:0 2px 0 rgba(0,0,0,.25); }
  #popup { position: fixed; inset:0; background: rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:50; }
  #popupContent { background: #fff; max-width: 90%; max-height: 80%; overflow-y:auto; border-radius:0.5rem; padding:1rem; position: relative; }
  #popupClose, #popupPrev, #popupNext { position: absolute; top: 10px; font-size:1.2rem; cursor:pointer; padding:0.5rem; background:#fff; border-radius:50%; }
  #popupClose { right:10px; }
  #popupPrev { left:10px; }
  #popupNext { right:50px; }
</style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

<!-- Login / Add Post -->
<div class="flex flex-col items-center gap-2 mb-4">
  <button id="loginBtn" class="btn-3d px-4 py-2">Login with Google</button>
  <button id="addBtn" class="btn-3d px-4 py-2 hidden">Add Hadees</button>
</div>

<!-- Hadees List -->
<div id="postsList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 w-full"></div>

<!-- Popup -->
<div id="popup" class="flex">
  <div id="popupContent">
    <span id="popupClose">✖</span>
    <span id="popupPrev">◀</span>
    <span id="popupNext">▶</span>
    <div id="popupText" class="mt-4"></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:e387e1297663f11fc2463b"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginBtn = document.getElementById("loginBtn");
const addBtn = document.getElementById("addBtn");
const postsList = document.getElementById("postsList");
let currentUser=null;
const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
let allPosts=[];

// Popup logic
let popupIndex=0;
const popup=document.getElementById("popup");
const popupText=document.getElementById("popupText");
const popupClose=document.getElementById("popupClose");
const popupPrev=document.getElementById("popupPrev");
const popupNext=document.getElementById("popupNext");

popupClose.onclick=()=>popup.style.display="none";
popupPrev.onclick=()=>{
  if(popupIndex>0){ popupIndex--; showPopup(popupIndex); }
};
popupNext.onclick=()=>{
  if(popupIndex<allPosts.length-1){ popupIndex++; showPopup(popupIndex); }
};

function showPopup(index){
  const post = allPosts[index];
  popupText.innerHTML=`<h2 class="font-bold text-lg">${post.userName}</h2>
                       <p class="mt-2">${post.hadees}</p>`;
  popup.style.display="flex";
}

// Auth
loginBtn.onclick=async ()=>{
  if(!auth.currentUser) await signInWithPopup(auth, provider);
  else await signOut(auth);
};

onAuthStateChanged(auth, user=>{
  currentUser=user;
  if(user){
    loginBtn.textContent="Logout";
    addBtn.classList.remove("hidden");
  } else{
    loginBtn.textContent="Login with Google";
    addBtn.classList.add("hidden");
  }
});

// Add Hadees
addBtn.onclick=async ()=>{
  const hadees=prompt("Enter Hadees text:");
  if(!hadees) return;
  await addDoc(collection(db,"hadees"),{
    hadees,
    uid: currentUser.uid,
    userName: currentUser.displayName||currentUser.email,
    approved:false,
    createdAt:serverTimestamp()
  });
  alert("Submitted for admin approval!");
};

// Load posts
onSnapshot(collection(db,"hadees"),snap=>{
  allPosts=[];
  snap.forEach(docSnap=>{
    const d=docSnap.data();
    d.id=docSnap.id;
    allPosts.push(d);
  });
  renderPosts();
});

function renderPosts(){
  postsList.innerHTML="";
  const visiblePosts = allPosts.filter(p=>p.approved || (currentUser && (currentUser.uid===p.uid || currentUser.email===ADMIN_EMAIL)));
  visiblePosts.forEach((post,index)=>{
    const div=document.createElement("div");
    div.className="card cursor-pointer";
    div.innerHTML=`<p class="truncate">${post.hadees}</p>`;
    div.onclick=()=>{ popupIndex=index; showPopup(index); };
    
    if(currentUser){
      if(currentUser.uid===post.uid || currentUser.email===ADMIN_EMAIL){
        const del=document.createElement("button");
        del.textContent="Delete";
        del.className="btn-3d mt-2 px-2 py-1";
        del.onclick=async (e)=>{ 
          e.stopPropagation(); 
          if(confirm("Delete post?")) await deleteDoc(doc(db,"hadees",post.id));
        };
        div.appendChild(del);
      }
      if(currentUser.email===ADMIN_EMAIL && !post.approved){
        const approve=document.createElement("button");
        approve.textContent="Approve";
        approve.className="btn-3d mt-2 px-2 py-1";
        approve.onclick=async (e)=>{
          e.stopPropagation();
          await updateDoc(doc(db,"hadees",post.id),{approved:true});
        };
        div.appendChild(approve);

        const reject=document.createElement("button");
        reject.textContent="Reject";
        reject.className="btn-3d mt-2 px-2 py-1";
        reject.onclick=async (e)=>{
          e.stopPropagation();
          await deleteDoc(doc(db,"hadees",post.id));
        };
        div.appendChild(reject);
      }
    }
    postsList.appendChild(div);
  });
}
</script>
</body>
</html>
