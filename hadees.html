<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hadees Board | Talimi Ittehad</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background-image: url('madina-bg.jpg');
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
}
.card {
  position: relative;
  padding: 1rem;
  border-radius: 0.75rem;
  color: white;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.card::before {
  content:"";
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.4);
  border-radius:0.75rem;
}
.card-content, .card-actions { position:relative; z-index:10; }
.card-actions button { margin-right: 0.5rem; margin-top:0.5rem; }

.popup-bg {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:50;
  overflow:auto;
}
.popup-content {
  background:white;
  max-width:600px;
  width:90%;
  max-height:80%;
  overflow:auto;
  border-radius:0.5rem;
  padding:1rem;
  position:relative;
}
.popup-content h2 { font-size:1.25rem; font-weight:700; margin-bottom:0.5rem; }
.popup-content p { margin-bottom:0.5rem; }
.popup-close, .popup-next {
  position:absolute;
  top:10px;
  padding:0.25rem 0.5rem;
  font-weight:700;
  border:none;
  border-radius:0.25rem;
  cursor:pointer;
}
.popup-close { right:10px; background:red; color:white; }
.popup-next { right:70px; background:green; color:white; }
</style>
</head>
<body class="min-h-screen flex flex-col">

<header class="bg-blue-600 text-white py-4 px-4 text-center font-bold text-2xl">Talimi Ittehad Hadees Board</header>

<!-- Post button -->
<div class="max-w-6xl mx-auto my-4 flex justify-end px-4">
  <button id="postBtn" class="bg-purple-600 text-white px-4 py-2 rounded shadow">üìù Post Hadees</button>
</div>

<!-- Hadees list -->
<main class="max-w-6xl mx-auto px-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8" id="hadeesList">
  <!-- posts inserted via JS -->
</main>

<!-- Post Modal -->
<div id="postModal" class="fixed inset-0 bg-black/50 hidden flex justify-center items-center z-50 p-4 overflow-auto">
  <div class="bg-white rounded-lg p-4 w-full max-w-md relative">
    <h2 class="text-lg font-bold mb-2">Post Hadees</h2>
    <textarea id="postText" class="w-full border p-2 rounded mb-2" rows="5" placeholder="Write your Hadees here..." required></textarea>
    <div class="flex justify-end gap-2">
      <button onclick="closePostModal()" class="px-3 py-1 border rounded">Cancel</button>
      <button id="submitHadees" class="px-3 py-1 bg-blue-600 text-white rounded">Submit</button>
    </div>
  </div>
</div>

<!-- Popup -->
<div class="popup-bg" id="popup">
  <div class="popup-content" id="popupContent">
    <button class="popup-close" onclick="closePopup()">Close</button>
    <button class="popup-next" onclick="nextPopup()">Next</button>
    <div id="popupText"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:e387e1297663f11fc2463b"
};
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const ADMIN_EMAIL = "zaradigitalseva@gmail.com";

let currentUser = null;
let posts = [];
let popupIndex = 0;

auth.onAuthStateChanged(user => {
  currentUser = user;
});

function showPostModal(){
  if(!currentUser) {
    alert("Login required to post");
    return;
  }
  document.getElementById("postModal").classList.remove("hidden");
}
function closePostModal(){ document.getElementById("postModal").classList.add("hidden"); }

document.getElementById("postBtn").addEventListener("click", showPostModal);
document.getElementById("submitHadees").addEventListener("click", async()=>{
  const text = document.getElementById("postText").value.trim();
  if(!text) return;
  await db.collection("hadees").add({
    text,
    uid: currentUser.uid,
    email: currentUser.email,
    approved: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("postText").value="";
  closePostModal();
  alert("‚úÖ Submitted for approval");
});

function renderPosts(){
  const list = document.getElementById("hadeesList");
  list.innerHTML="";
  posts.forEach((p,i)=>{
    if(!p.approved && (!currentUser || (currentUser.email!==ADMIN_EMAIL && currentUser.uid!==p.uid))) return;
    const card = document.createElement("div");
    card.className="card p-4 rounded shadow";
    card.style.backgroundColor = `hsl(${i*50%360},70%,40%)`;
    card.innerHTML = `<div class="card-content">${p.text.slice(0,100)}${p.text.length>100?'...':''}</div>
      <div class="card-actions">`;
    if(currentUser){
      if(currentUser.uid===p.uid || currentUser.email===ADMIN_EMAIL){
        card.innerHTML += `<button onclick="deletePost('${p.id}')">Delete</button>`;
      }
      if(currentUser.email===ADMIN_EMAIL && !p.approved){
        card.innerHTML += `<button onclick="approvePost('${p.id}')">Approve</button>`;
      }
    }
    card.innerHTML += `<button onclick="openPopup(${i})">View</button></div>`;
    list.appendChild(card);
  });
}

async function approvePost(id){ await db.collection("hadees").doc(id).update({approved:true}); }
async function deletePost(id){ await db.collection("hadees").doc(id).delete(); }

db.collection("hadees").orderBy("createdAt","desc").onSnapshot(snap=>{
  posts = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderPosts();
});

// Popup
function openPopup(i){
  popupIndex = i;
  const p = posts[i];
  document.getElementById("popupText").innerText = p.text;
  document.getElementById("popup").style.display="flex";
}
function closePopup(){ document.getElementById("popup").style.display="none"; }
function nextPopup(){
  popupIndex = (popupIndex+1)%posts.length;
  const p = posts[popupIndex];
  document.getElementById("popupText").innerText = p.text;
}
</script>

</body>
</html>
