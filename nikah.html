<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nikah Profiles</title>
<style>
  :root{
    --green:#116530;
    --accent:#008069;
    --card-h:280px;
    --card-radius:12px;
    --muted:#777;
  }
  body { font-family: "Segoe UI", sans-serif; margin:0; background:#f5f7f5; color:#222; }
  header {
    background:linear-gradient(145deg,var(--green),#095122);
    color:white; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
    box-shadow:0 3px 8px rgba(0,0,0,0.18); position:sticky; top:0; z-index:50;
  }
  .header-left { display:flex; align-items:center; gap:12px; }
  .home-3d {
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; background:#fff; color:var(--green);
    border-radius:10px; font-weight:600; text-decoration:none;
    box-shadow:0 6px 0 rgba(0,0,0,0.12), 0 12px 18px rgba(0,0,0,0.08);
    transform:translateY(0);
  }
  .home-3d:active { transform:translateY(2px); box-shadow:none; }
  .rules-btn {
    background:rgba(255,255,255,0.12); color:white; padding:8px 10px; border-radius:8px; text-decoration:none;
    border:1px solid rgba(255,255,255,0.08);
  }
  .header-right { display:flex; align-items:center; gap:10px; }

  main { max-width:1100px; margin:18px auto; padding:0 16px 60px; }

  .top-join { display:flex; justify-content:center; margin:6px 0 18px; }
  .whatsapp-btn {
    background:#25d366; color:white; text-decoration:none; padding:10px 18px; border-radius:8px; font-weight:700;
    box-shadow:0 6px 18px rgba(37,211,102,0.14);
  }

  /* Grid */
  .grid { display:grid; gap:14px; grid-template-columns:repeat(2,1fr); }
  @media(min-width:1024px){ .grid { grid-template-columns:repeat(4,1fr); } }

  /* Card compact */
  .card { background:white; border-radius:var(--card-radius); overflow:hidden; height:var(--card-h); display:flex; flex-direction:column; box-shadow:0 6px 18px rgba(0,0,0,0.08); cursor:pointer; transition:transform .15s; }
  .card:hover { transform:translateY(-4px); }
  .card .thumb { width:100%; height:150px; object-fit:cover; background:#eee; }
  .card-body { padding:10px; display:flex; flex-direction:column; gap:6px; flex:1; align-items:flex-start; width:100%; }
  .card-body h3 { margin:0; font-size:16px; color:var(--green); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; }
  .card-body .meta { color:var(--muted); font-size:13px; }
  .card-footer { padding:10px; display:flex; gap:8px; width:100%; justify-content:flex-start; align-items:center; flex-wrap:wrap; }
  .btn-wa { background:#25d366; color:white; padding:8px 10px; border-radius:8px; text-decoration:none; font-weight:600; border:none; }
  .btn-connect { background:var(--accent); color:white; padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
  .admin-small { background:#ffc107; color:#333; padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }
  .admin-del { background:#dc3545; color:#fff; padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }

  /* Forms / panels */
  #memberForm { display:none; background:white; padding:16px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin:14px 0; }
  #memberForm .row { display:flex; gap:10px; }
  #memberForm input, #memberForm textarea, #memberForm select { width:100%; padding:10px; margin:6px 0; border-radius:8px; border:1px solid #ddd; box-sizing:border-box; font-size:14px; }

  /* profile detail popup */
  #profilePopup { position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.5); z-index:60; }
  .profile-card { background:white; width:95%; max-width:920px; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.25); overflow:auto; max-height:90vh; }
  .profile-grid { display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:18px; }
  .profile-photo { width:100%; height:420px; object-fit:cover; border-radius:8px; background:#eee; }
  .profile-info { padding:8px 4px; }
  .profile-info h2 { margin:0 0 8px 0; color:var(--green); }
  .profile-info .line { margin:6px 0; color:#333; }
  .close-btn { position:absolute; right:18px; top:18px; background:#eee; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }

  /* connect popup */
  #connectPopup { position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.45); z-index:70; }
  .connect-box { background:white; padding:16px; border-radius:10px; width:95%; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,0.2); }
  .connect-box input { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ddd; }

  /* admin logs panel */
  #adminLogs { display:none; margin-top:16px; background:white; padding:12px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
  #logsTable { width:100%; border-collapse:collapse; }
  #logsTable th, #logsTable td { border-bottom:1px solid #eee; padding:8px 6px; text-align:left; font-size:14px; }
  #logsTable th { color:var(--green); font-weight:700; }

  /* small helpers */
  .muted { color:var(--muted); font-size:13px; }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <a class="home-3d" href="index.html" title="Home">üè† Home</a>
    <a class="rules-btn" href="nikah-Conditions.html" title="‡§π‡§Æ‡§æ‡§∞‡•á ‡§®‡§ø‡§Ø‡§Æ">üìú ‡§π‡§Æ‡§æ‡§∞‡•á ‡§®‡§ø‡§Ø‡§Æ</a>
  </div>

  <div class="header-right">
    <button id="loginBtn" onclick="googleLogin()" style="background:white;color:var(--green);padding:8px 10px;border-radius:8px;border:none;cursor:pointer;">Admin Login</button>
    <button id="logoutBtn" onclick="logout()" style="display:none;background:#fff;color:var(--green);padding:8px 10px;border-radius:8px;border:none;cursor:pointer;">Logout</button>
  </div>
</header>

<main>
  <div class="top-join">
    <a class="whatsapp-btn" id="joinBtn" href="https://wa.me/919112170192?text=Main%20Nikah%20Profile%20mein%20shamil%20hona%20chahta/chahti%20hoon" target="_blank">üì± WhatsApp se Join Karein</a>
  </div>

  <!-- Admin add/edit form -->
  <section id="memberForm">
    <h3>‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç / ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç (Admin)</h3>

    <!-- fields needed for marriage profile -->
    <div style="display:grid; grid-template-columns: repeat(2,1fr); gap:10px;">
      <input id="f_name" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ">
      <input id="f_dob" placeholder="Date of Birth (YYYY-MM-DD)">
      <input id="f_gender" placeholder="‡§≤‡§ø‡§Ç‡§ó (Male/Female/Other)">
      <input id="f_age" placeholder="‡§â‡§Æ‡•ç‡§∞">
      <input id="f_height" placeholder="‡§ï‡§¶ (e.g., 5'6&quot; or cm)">
      <input id="f_religion" placeholder="‡§ß‡§∞‡•ç‡§Æ / ‡§´‡§ø‡§∞‡§ï‡§æ">
      <input id="f_city" placeholder="‡§∂‡§π‡§∞">
      <input id="f_state" placeholder="‡§∞‡§æ‡§ú‡•ç‡§Ø">
      <input id="f_education" placeholder="‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ">
      <input id="f_profession" placeholder="‡§™‡•á‡§∂‡§æ">
      <input id="f_income" placeholder="‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§Ü‡§Ø (Optional)">
      <input id="f_whatsapp" placeholder="WhatsApp ‡§®‡§Ç‡§¨‡§∞ (91...)">
    </div>

    <textarea id="f_bio" rows="3" placeholder="‡§Ö‡§™‡§®‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç (Bio)"></textarea>
    <textarea id="f_family" rows="2" placeholder="‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä / ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§∏‡•á ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§æ‡§è‡§Å"></textarea>

    <div style="display:flex;gap:10px;align-items:center;">
      <input type="file" id="f_photo" accept="image/*">
      <button onclick="saveProfile()" style="background:var(--green);color:#fff;padding:10px 12px;border:none;border-radius:8px;cursor:pointer;">Save Profile</button>
      <button onclick="cancelEdit()" style="background:#999;color:#fff;padding:10px 12px;border:none;border-radius:8px;cursor:pointer;">Cancel</button>
    </div>
    <div class="muted">Note: ‡§´‡•ã‡§ü‡•ã imgbb ‡§™‡§∞ upload ‡§π‡•ã‡§ó‡•Ä‡•§</div>
  </section>

  <!-- Grid of member cards -->
  <div class="grid" id="members"></div>

  <!-- Admin logs panel -->
  <section id="adminLogs">
    <h3>üìã Contact Requests (Admin)</h3>
    <table id="logsTable">
      <thead><tr><th>Profile</th><th>Visitor</th><th>Address</th><th>WhatsApp</th><th>Time</th><th></th></tr></thead>
      <tbody id="logsBody"></tbody>
    </table>
  </section>
</main>

<!-- profile detail popup -->
<div id="profilePopup">
  <div class="profile-card" role="dialog" aria-modal="true">
    <button class="close-btn" onclick="closeProfile()">‚úñ</button>
    <div class="profile-grid">
      <div style="padding:8px;">
        <img id="p_photo" class="profile-photo" src="" alt="Profile photo">
      </div>
      <div class="profile-info">
        <h2 id="p_name">Name</h2>
        <div class="line"><strong>‡§â‡§Æ‡•ç‡§∞ / ‡§ú‡§®‡•ç‡§Æ‡§§‡§ø‡§•‡§ø:</strong> <span id="p_age"></span></div>
        <div class="line"><strong>‡§≤‡§ø‡§Ç‡§ó:</strong> <span id="p_gender"></span></div>
        <div class="line"><strong>‡§ï‡§¶:</strong> <span id="p_height"></span></div>
        <div class="line"><strong>‡§ß‡§∞‡•ç‡§Æ / ‡§´‡§ø‡§∞‡§ï‡§æ:</strong> <span id="p_religion"></span></div>
        <div class="line"><strong>‡§∂‡§π‡§∞ / ‡§∞‡§æ‡§ú‡•ç‡§Ø:</strong> <span id="p_city_state"></span></div>
        <div class="line"><strong>‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ:</strong> <span id="p_education"></span></div>
        <div class="line"><strong>‡§™‡•á‡§∂‡§æ:</strong> <span id="p_profession"></span></div>
        <div class="line"><strong>‡§Ü‡§Ø:</strong> <span id="p_income"></span></div>
        <div class="line"><strong>WhatsApp:</strong> <span id="p_whatsapp"></span></div>
        <hr>
        <div class="line"><strong>Bio:</strong> <div id="p_bio"></div></div>
        <div class="line"><strong>Family:</strong> <div id="p_family"></div></div>
        <div style="margin-top:12px;">
          <a id="p_contact_btn" class="btn-wa" href="#" target="_blank">üìû Contact</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- connect popup -->
<div id="connectPopup">
  <div class="connect-box">
    <h3>Contact / Connect</h3>
    <div><input id="c_name" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ"></div>
    <div><input id="c_address" placeholder="‡§™‡§§‡§æ / ‡§∂‡§π‡§∞"></div>
    <div><input id="c_whatsapp" placeholder="WhatsApp (91...)"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="submitConnectBtn" style="background:var(--green);color:#fff;padding:10px;border:none;border-radius:8px;cursor:pointer;">Submit & Open WhatsApp</button>
      <button onclick="closeConnect()" style="background:#999;color:#fff;padding:10px;border:none;border-radius:8px;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ---------------- CONFIG you've provided ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
  authDomain: "all-madrsa.firebaseapp.com",
  projectId: "all-madrsa",
  storageBucket: "all-madrsa.appspot.com",
  messagingSenderId: "619313835874",
  appId: "1:619313835874:web:e387e1297663f11fc2463b"
};
const imgbbKey = "d12c2e4a8650157b2b6b9fe85336ea43";
const adminEmails = ["zaradigitalseva@gmail.com"];
const defaultWhatsApp = "9112170192";
/* ------------------------------------------------------- */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let editingId = null;       // if editing existing profile
let currentProfileViewId = null; // for profile detail popup
let connectProfileId = null; // profile being contacted

/* DOM refs */
const membersEl = document.getElementById('members');
const memberForm = document.getElementById('memberForm');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const adminLogs = document.getElementById('adminLogs');
const logsBody = document.getElementById('logsBody');

/* profile popup refs */
const profilePopup = document.getElementById('profilePopup');
const p_photo = document.getElementById('p_photo');
const p_name = document.getElementById('p_name');
const p_age = document.getElementById('p_age');
const p_gender = document.getElementById('p_gender');
const p_height = document.getElementById('p_height');
const p_religion = document.getElementById('p_religion');
const p_city_state = document.getElementById('p_city_state');
const p_education = document.getElementById('p_education');
const p_profession = document.getElementById('p_profession');
const p_income = document.getElementById('p_income');
const p_bio = document.getElementById('p_bio');
const p_family = document.getElementById('p_family');
const p_whatsapp = document.getElementById('p_whatsapp');
const p_contact_btn = document.getElementById('p_contact_btn');

/* connect popup refs */
const connectPopup = document.getElementById('connectPopup');
const submitConnectBtn = document.getElementById('submitConnectBtn');

/* Safe esc */
function esc(s){ return s? String(s) : ""; }

/* ----------------- Auth listener (single place) ----------------- */
auth.onAuthStateChanged(user=>{
  currentUser = user;
  if(user && adminEmails.includes(user.email)){
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    memberForm.style.display = 'block';
    adminLogs.style.display = 'block';
  } else if(user){
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    memberForm.style.display = 'none';
    adminLogs.style.display = 'none';
  } else {
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
    memberForm.style.display = 'none';
    adminLogs.style.display = 'none';
  }
  // reload members so admin-only sections mount/unmount
  loadMembers();
  loadContactLogs(); // update admin logs if admin
});

/* ----------------- Login/Logout ----------------- */
function googleLogin(){ const p=new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(p); }
function logout(){ auth.signOut(); }

/* ----------------- Image upload helper (imgbb) ----------------- */
async function uploadImageToImgbb(file){
  const fd = new FormData();
  fd.append("image", file);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, { method: "POST", body: fd });
  const data = await res.json();
  if(!data || !data.success) throw new Error("Image upload failed");
  return data.data.url;
}

/* ----------------- Render members ----------------- */
function loadMembers(){
  // unsubscribe? for simplicity rely on onSnapshot handle
  db.collection("members").orderBy("name").onSnapshot(snapshot=>{
    membersEl.innerHTML = "";
    snapshot.forEach(doc=>{
      const d=doc.data();
      const card = document.createElement('div');
      card.className = 'card';

      // clicking card opens full profile
      card.addEventListener('click', (e)=>{
        // avoid triggering when clicking inner buttons (connect/contact/edit/delete)
        if(e.target.tagName.toLowerCase() === 'button' || e.target.tagName.toLowerCase() === 'a') return;
        openProfileDetail(doc.id,d);
      });

      const img = document.createElement('img');
      img.className = 'thumb';
      img.src = esc(d.photo) || '';

      const body = document.createElement('div');
      body.className = 'card-body';
      body.innerHTML = `<h3>${esc(d.name)}</h3><div class="meta">‡§â‡§Æ‡•ç‡§∞: ${esc(d.age) || "-"}</div>`;

      const footer = document.createElement('div');
      footer.className = 'card-footer';

      // Contact (whatsapp) button - opens connect popup for visitor and logs
      const contactBtn = document.createElement('button');
      contactBtn.className = 'btn-wa';
      contactBtn.textContent = 'üìû Contact';
      contactBtn.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        openConnectPopup(doc.id,d.name);
      });

      // Direct WhatsApp quick contact (if you want quick open without logging) - optional; here we do logging flow
      // const waQuick = document.createElement('a');
      // waQuick.href = `https://wa.me/${defaultWhatsApp}?text=${encodeURIComponent("Mujhe " + d.name + " ki profile mein interest hai")}`; waQuick.target="_blank";

      // Connect (another button) - keep both if desired
      const connectBtn = document.createElement('button');
      connectBtn.className = 'btn-connect';
      connectBtn.textContent = 'Connect';
      connectBtn.addEventListener('click',(ev)=>{ ev.stopPropagation(); openConnectPopup(doc.id,d.name); });

      footer.appendChild(contactBtn);
      footer.appendChild(connectBtn);

      // Admin buttons (edit / delete)
      if(currentUser && adminEmails.includes(currentUser.email)){
        const edit = document.createElement('button');
        edit.className = 'admin-small';
        edit.textContent = 'Edit';
        edit.addEventListener('click', (ev)=>{ ev.stopPropagation(); startEditProfile(doc.id,d); });
        const del = document.createElement('button');
        del.className = 'admin-del';
        del.textContent = 'Delete';
        del.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(confirm("Are you sure delete this profile?")) db.collection("members").doc(doc.id).delete(); });
        footer.appendChild(edit);
        footer.appendChild(del);
      }

      card.appendChild(img);
      card.appendChild(body);
      card.appendChild(footer);

      // If admin: append small real-time connects list under the card
      if(currentUser && adminEmails.includes(currentUser.email)){
        const connectsDiv = document.createElement('div');
        connectsDiv.className = 'connects-list';
        connectsDiv.innerHTML = '<strong style="display:block;margin-bottom:6px;color:var(--green)">Interested People:</strong>';
        card.appendChild(connectsDiv);

        // realtime listener per doc (safe because admin only)
        db.collection("members").doc(doc.id).collection("connections").orderBy("created","desc")
          .onSnapshot(csnap=>{
            // clear old connect items
            connectsDiv.querySelectorAll('.connect-item').forEach(n=>n.remove());
            csnap.forEach(cdoc=>{
              const c = cdoc.data();
              const item = document.createElement('div');
              item.className = 'connect-item';
              const left = document.createElement('div');
              left.textContent = `${esc(c.name)} ‚Äî ${esc(c.city)}`;
              const a = document.createElement('a');
              a.href = `https://wa.me/${encodeURIComponent(c.whatsapp)}?text=${encodeURIComponent("Hello " + c.name)}`;
              a.textContent = 'WhatsApp';
              a.target = '_blank';
              item.appendChild(left);
              item.appendChild(a);
              connectsDiv.appendChild(item);
            });
          }, err=>{ console.error("connects listen err", err); });
      }

      membersEl.appendChild(card);
    });
  }, err=>{ console.error("members listen err", err); });
}

/* ----------------- Profile detail popup (read-only) ----------------- */
function openProfileDetail(id, data){
  currentProfileViewId = id;
  p_photo.src = esc(data.photo) || '';
  p_name.textContent = esc(data.name);
  p_age.textContent = esc(data.age) + (data.dob ? ' / ' + esc(data.dob) : '');
  p_gender.textContent = esc(data.gender || '-');
  p_height.textContent = esc(data.height || '-');
  p_religion.textContent = esc(data.religion || '-');
  p_city_state.textContent = (esc(data.city) || '-') + (data.state ? ' / ' + esc(data.state) : '');
  p_education.textContent = esc(data.education || '-');
  p_profession.textContent = esc(data.profession || '-');
  p_income.textContent = esc(data.income || '-');
  p_bio.textContent = esc(data.bio || '-');
  p_family.textContent = esc(data.family || '-');
  p_whatsapp.textContent = esc(data.whatsapp || ('+'+defaultWhatsApp));
  // contact button opens connect popup prefilled
  p_contact_btn.href = `https://wa.me/${defaultWhatsApp}?text=${encodeURIComponent("Mujhe " + (data.name||'') + " ki profile mein interest hai")}`;
  p_contact_btn.onclick = (ev)=>{ ev.preventDefault(); openConnectPopup(id, data.name); };
  profilePopup.style.display = 'flex';
}
function closeProfile(){ profilePopup.style.display = 'none'; currentProfileViewId = null; }

/* ----------------- Connect popup flow (visitor) ----------------- */
function openConnectPopup(profileId, profileName){
  connectProfileId = profileId;
  connectPopup.style.display = 'flex';
  // optional: prefill with nothing
  document.getElementById('c_name').value = '';
  document.getElementById('c_address').value = '';
  document.getElementById('c_whatsapp').value = '';
}
function closeConnect(){ connectPopup.style.display = 'none'; connectProfileId = null; }

submitConnectBtn.addEventListener('click', async ()=>{
  const vname = document.getElementById('c_name').value.trim();
  const vaddr = document.getElementById('c_address').value.trim();
  const vwh = document.getElementById('c_whatsapp').value.trim();
  if(!vname || !vaddr || !vwh) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç');
  if(!connectProfileId) return alert('Invalid profile');

  try {
    // 1) save under member subcollection
    await db.collection('members').doc(connectProfileId).collection('connections').add({
      name: vname, city: vaddr, whatsapp: vwh, created: firebase.firestore.FieldValue.serverTimestamp()
    });
    // 2) also save in root contactLogs for admin table view
    const profileSnap = await db.collection('members').doc(connectProfileId).get();
    const prof = profileSnap.exists ? profileSnap.data().name : '';
    await db.collection('contactLogs').add({
      profileId: connectProfileId,
      profileName: prof || '',
      visitorName: vname,
      visitorAddress: vaddr,
      visitorWhats: vwh,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    // 3) open WhatsApp to admin number with message
    const text = encodeURIComponent(`Assalamu Alaikum,\nMujhe ${prof || ''} ki profile mein dilchaspi hai.\nName: ${vname}\nCity: ${vaddr}\nPlease contact: ${vwh}`);
    window.open(`https://wa.me/${defaultWhatsApp}?text=${text}`, '_blank');
    alert('‡§Ü‡§™‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡•á‡§ú ‡§¶‡•Ä ‡§ó‡§à ‚úÖ');
    closeConnect();
  } catch (e) {
    console.error(e);
    alert('Error: ' + (e.message || e));
  }
});

/* ----------------- Admin: Load contact logs (table) ----------------- */
function loadContactLogs(){
  if(!(currentUser && adminEmails.includes(currentUser.email))){
    logsBody.innerHTML = '';
    return;
  }
  db.collection('contactLogs').orderBy('ts','desc').onSnapshot(snapshot=>{
    logsBody.innerHTML = '';
    snapshot.forEach(doc=>{
      const d = doc.data();
      const tr = document.createElement('tr');
      const t_time = d.ts && d.ts.toDate ? d.ts.toDate().toLocaleString() : '';
      tr.innerHTML = `<td>${esc(d.profileName)}</td>
                      <td>${esc(d.visitorName)}</td>
                      <td>${esc(d.visitorAddress)}</td>
                      <td>${esc(d.visitorWhats)}</td>
                      <td>${t_time}</td>
                      <td><a href="https://wa.me/${encodeURIComponent(d.visitorWhats)}?text=${encodeURIComponent('Hello '+d.visitorName)}" target="_blank" style="background:#25d366;padding:6px 8px;border-radius:6px;color:#fff;text-decoration:none;">Message</a></td>`;
      logsBody.appendChild(tr);
    });
  }, err => {
    console.error("contactLogs listen error", err);
  });
}

/* ----------------- Admin: Add/Edit Profile ----------------- */
/* SaveProfile handles both add and edit (editingId non-null) */
async function saveProfile(){
  if(!(currentUser && adminEmails.includes(currentUser.email))) return alert('Admin access required');
  const name = document.getElementById('f_name').value.trim();
  const dob = document.getElementById('f_dob').value.trim();
  const gender = document.getElementById('f_gender').value.trim();
  const age = document.getElementById('f_age').value.trim();
  const height = document.getElementById('f_height').value.trim();
  const religion = document.getElementById('f_religion').value.trim();
  const city = document.getElementById('f_city').value.trim();
  const state = document.getElementById('f_state').value.trim();
  const education = document.getElementById('f_education').value.trim();
  const profession = document.getElementById('f_profession').value.trim();
  const income = document.getElementById('f_income').value.trim();
  const whatsapp = document.getElementById('f_whatsapp').value.trim();
  const bio = document.getElementById('f_bio').value.trim();
  const family = document.getElementById('f_family').value.trim();
  const file = document.getElementById('f_photo').files[0];

  if(!name || !age || !city) return alert('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§®‡§æ‡§Æ, ‡§â‡§Æ‡•ç‡§∞ ‡§î‡§∞ ‡§∂‡§π‡§∞ ‡§≠‡§∞‡•á‡§Ç');

  try {
    let photoUrl = null;
    if(file){ photoUrl = await uploadImageToImgbb(file); }
    const payload = {
      name, dob, gender, age, height, religion, city, state, education, profession, income, whatsapp, bio, family,
      photo: photoUrl || null
    };

    if(editingId){
      // update: don't overwrite photo if null
      if(photoUrl) payload.photo = photoUrl;
      // remove null fields? ok
      await db.collection('members').doc(editingId).update(payload);
      alert('Profile updated ‚úÖ');
    } else {
      // new
      // if photo missing, it's allowed but better to enforce - here we allow null
      await db.collection('members').add(payload);
      alert('Profile added ‚úÖ');
    }
    cancelEdit();
  } catch (e) {
    console.error(e);
    alert('Error saving: ' + (e.message || e));
  }
}

/* start editing existing profile */
function startEditProfile(id, data){
  editingId = id;
  // fill fields
  document.getElementById('f_name').value = data.name || '';
  document.getElementById('f_dob').value = data.dob || '';
  document.getElementById('f_gender').value = data.gender || '';
  document.getElementById('f_age').value = data.age || '';
  document.getElementById('f_height').value = data.height || '';
  document.getElementById('f_religion').value = data.religion || '';
  document.getElementById('f_city').value = data.city || '';
  document.getElementById('f_state').value = data.state || '';
  document.getElementById('f_education').value = data.education || '';
  document.getElementById('f_profession').value = data.profession || '';
  document.getElementById('f_income').value = data.income || '';
  document.getElementById('f_whatsapp').value = data.whatsapp || '';
  document.getElementById('f_bio').value = data.bio || '';
  document.getElementById('f_family').value = data.family || '';
  // show form
  memberForm.scrollIntoView({behavior:'smooth'});
  memberForm.style.display = 'block';
}

/* cancel edit/add */
function cancelEdit(){
  editingId = null;
  memberForm.style.display = 'none';
  // reset fields
  ['f_name','f_dob','f_gender','f_age','f_height','f_religion','f_city','f_state','f_education','f_profession','f_income','f_whatsapp','f_bio','f_family'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f_photo').value = '';
}

/* ----------------- initial load ----------------- */
loadMembers();
loadContactLogs();

</script>
</body>
</html>
