<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nikah Portal тАФ Admin Posts</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- HEADER -->
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="https://via.placeholder.com/48x48?text=NP" alt="logo" class="rounded-full" />
        <div>
          <h1 class="font-bold text-lg">Nikah Portal</h1>
          <p class="text-sm text-gray-600">рд╕рднреА рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдпрд╣рд╛рдБ рджрд┐рдЦрд╛рдИ рджреЗрдВрдЧреА тАФ рдкреЛрд╕реНрдЯ рдХреЗрд╡рд▓ рдПрдбрдорд┐рди рдХрд░ рд╕рдХреЗрдЧрд╛</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="statusText" class="text-sm text-gray-600">Not signed in</span>
        <button id="loginBtn" class="px-3 py-2 border rounded">Sign in (Google)</button>
        <button id="logoutBtn" class="px-3 py-2 border rounded hidden">Logout</button>
        <a href="https://wa.me/9112170192?text=рдирдорд╕реНрддреЗ,%20рд░рд┐рд╢реНрддреЗ%20рдЬреЛрдбрд╝рдиреЗ%20рдХреЗ%20рд▓рд┐рдП%20рд╕рдВрдкрд░реНрдХ%20рдХрд░рдирд╛%20рд╣реИ" target="_blank" class="ml-3 bg-green-600 text-white px-4 py-2 rounded">рд░рд┐рд╢реНрддреЗ рдЬреЛрдбрд╝реЗ</a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-4">
    <!-- Admin Form -->
    <section id="adminFormWrap" class="hidden bg-white rounded shadow p-4 mb-6">
      <h2 class="font-bold text-lg mb-2">рдирдпрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдкреЛрд╕реНрдЯ рдХрд░реЗрдВ (рдХреЗрд╡рд▓ рдПрдбрдорд┐рди)</h2>
      <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
        <input id="name" class="border p-2 rounded" placeholder="рдкреВрд░рд╛ рдирд╛рдо" required />
        <input id="age" type="number" class="border p-2 rounded" placeholder="рдЙрдореНрд░" />
        <select id="gender" class="border p-2 rounded">
          <option value="">рд▓рд┐рдВрдЧ рдЪреБрдиреЗрдВ</option>
          <option value="Male">рдкреБрд░реБрд╖</option>
          <option value="Female">рдорд╣рд┐рд▓рд╛</option>
          <option value="Other">рдЕрдиреНрдп</option>
        </select>
        <input id="religion" class="border p-2 rounded" placeholder="рдзрд░реНрдо" />
        <input id="motherTongue" class="border p-2 rounded" placeholder="рдорд╛рддреГрднрд╛рд╖рд╛" />
        <input id="city" class="border p-2 rounded" placeholder="рд╢рд╣рд░" />
        <input id="education" class="border p-2 rounded" placeholder="рд╢рд┐рдХреНрд╖рд╛" />
        <input id="occupation" class="border p-2 rounded" placeholder="рдкреЗрд╢рд╛" />
        <textarea id="about" class="border p-2 rounded md:col-span-2" placeholder="рдЖрддреНрдо-рдкрд░рд┐рдЪрдп / рдмрд╛рдпреЛ"></textarea>
        <input id="images" type="file" accept="image/*" multiple class="md:col-span-2" />
        <button id="submitBtn" class="bg-blue-600 text-white px-4 py-2 rounded md:col-span-2">Post Profile</button>
      </form>
    </section>

    <!-- Profiles -->
    <section>
      <h2 class="font-bold text-lg mb-3">рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓реНрд╕</h2>
      <div id="profilesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>
  </main>

  <!-- MODAL -->
  <div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-3xl w-full p-4 relative">
      <button id="closeModal" class="absolute right-3 top-3 text-gray-600 text-lg">тЬЦ</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- FIREBASE + JS -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
      authDomain: "all-madrsa.firebaseapp.com",
      projectId: "all-madrsa",
      storageBucket: "all-madrsa.appspot.com",
      messagingSenderId: "619313835874",
      appId: "1:619313835874:web:e387e1297663f11fc2463b"
    };
    const IMG_API_KEY = "d12c2e4a8650157b2b6b9fe85336ea43";
    const ADMIN_EMAIL = "zaradigitalseva@gmail.com";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminFormWrap = document.getElementById('adminFormWrap');
    const profileForm = document.getElementById('profileForm');
    const profilesContainer = document.getElementById('profilesContainer');
    const statusText = document.getElementById('statusText');

    // ЁЯФ╣ LOGIN / LOGOUT
    loginBtn.onclick = async () => {
      try { await signInWithPopup(auth, provider); } 
      catch (e) { alert("Login failed: " + e.message); }
    };
    logoutBtn.onclick = async () => { await signOut(auth); };

    onAuthStateChanged(auth, user => {
      if (user) {
        statusText.textContent = `Signed in: ${user.email}`;
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        adminFormWrap.classList.toggle('hidden', user.email !== ADMIN_EMAIL);
      } else {
        statusText.textContent = 'Not signed in';
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        adminFormWrap.classList.add('hidden');
      }
    });

    // ЁЯФ╣ Image upload helper (imgbb)
    async function uploadImageToImgbb(file) {
      const form = new FormData();
      form.append('image', file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_API_KEY}`, { method: 'POST', body: form });
      const data = await res.json();
      if (!data.success) throw new Error('Image upload failed');
      return data.data.url;
    }

    // ЁЯФ╣ Submit Profile
    profileForm.onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = "Posting...";

      try {
        const name = nameInput('name'), age = val('age'), gender = val('gender'),
              religion = val('religion'), motherTongue = val('motherTongue'),
              city = val('city'), education = val('education'),
              occupation = val('occupation'), about = val('about');
        const files = document.getElementById('images').files;
        const imageUrls = [];
        for (let f of files) imageUrls.push(await uploadImageToImgbb(f));

        await addDoc(collection(db, 'profiles'), {
          name, age, gender, religion, motherTongue, city, education, occupation, about,
          images: imageUrls, createdAt: serverTimestamp()
        });

        alert("тЬЕ Profile Posted Successfully!");
        profileForm.reset();
      } catch (err) {
        alert("Error: " + err.message);
      } finally {
        btn.disabled = false; btn.textContent = "Post Profile";
      }
    };

    const val = id => document.getElementById(id).value.trim();
    const nameInput = id => document.getElementById(id).value.trim();

    // ЁЯФ╣ Load Profiles Realtime
    const q = query(collection(db, 'profiles'), orderBy('createdAt', 'desc'));
    onSnapshot(q, snap => {
      profilesContainer.innerHTML = '';
      snap.forEach(doc => profilesContainer.appendChild(makeCard(doc.data())));
    });

    function makeCard(d) {
      const div = document.createElement('div');
      div.className = "bg-white rounded-lg shadow p-4 hover:shadow-md";
      const img = d.images?.[0] || 'https://via.placeholder.com/300x200?text=No+Image';
      div.innerHTML = `
        <img src="${img}" class="w-full h-48 object-cover rounded" />
        <h3 class="mt-3 text-lg font-semibold">${d.name || ''} (${d.age || '-'})</h3>
        <p class="text-sm text-gray-600">${d.religion || ''} тАв ${d.motherTongue || ''} тАв ${d.city || ''}</p>
        <div class="mt-3 flex gap-2">
          <button class="px-3 py-1 border rounded" onclick='openProfile(${JSON.stringify(JSON.stringify(d))})'>рдкреВрд░рд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓</button>
          <a href="https://wa.me/9112170192?text=рдирдорд╕реНрддреЗ,%20${encodeURIComponent(d.name)}%20рдХреЗ%20рд░рд┐рд╢реНрддреЗ%20рдХреЗ%20рд▓рд┐рдП%20рдЬрд╛рдирдХрд╛рд░реА%20рдЪрд╛рд╣рд┐рдП" target="_blank" class="px-3 py-1 bg-green-600 text-white rounded">рд░рд┐рд╢реНрддреЗ рдЬреЛрдбрд╝реЗ</a>
        </div>`;
      return div;
    }

    // ЁЯФ╣ Modal logic
    window.openProfile = (dataStr) => {
      const data = JSON.parse(dataStr);
      const modal = document.getElementById('profileModal');
      const modalContent = document.getElementById('modalContent');
      modal.classList.remove('hidden');
      modalContent.innerHTML = `
        <h2 class="text-xl font-bold mb-2">${data.name} тАФ ${data.age}</h2>
        <p><b>рд▓рд┐рдВрдЧ:</b> ${data.gender || '-'}</p>
        <p><b>рдзрд░реНрдо:</b> ${data.religion || '-'}</p>
        <p><b>рдорд╛рддреГрднрд╛рд╖рд╛:</b> ${data.motherTongue || '-'}</p>
        <p><b>рд╢рд╣рд░:</b> ${data.city || '-'}</p>
        <p><b>рд╢рд┐рдХреНрд╖рд╛:</b> ${data.education || '-'}</p>
        <p><b>рдкреЗрд╢рд╛:</b> ${data.occupation || '-'}</p>
        <p><b>рдмрд╛рдпреЛ:</b> ${data.about || '-'}</p>
        <div class="grid grid-cols-2 gap-2 mt-3">
          ${data.images?.map(u => `<img src="${u}" class="w-full h-32 object-cover rounded" />`).join('') || ''}
        </div>`;
    };
    document.getElementById('closeModal').onclick = () => document.getElementById('profileModal').classList.add('hidden');
    document.getElementById('profileModal').onclick = (e) => { if (e.target.id === 'profileModal') e.target.classList.add('hidden'); };
  </script>
</body>
</html>
