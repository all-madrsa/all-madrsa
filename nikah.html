<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Post Profile</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">Post Your Profile</h1>

  <form id="profileForm" class="bg-white p-4 rounded shadow max-w-md mx-auto space-y-3">
    <input type="text" id="name" placeholder="Name" class="border p-2 w-full rounded" required>
    <input type="number" id="age" placeholder="Age" class="border p-2 w-full rounded" required>
    <input type="text" id="city" placeholder="City" class="border p-2 w-full rounded" required>
    <input type="text" id="whatsapp" placeholder="WhatsApp Number" class="border p-2 w-full rounded" required>
    <input type="file" id="imageInput" class="border p-2 w-full rounded" accept="image/*" required>
    <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded w-full">Submit</button>
  </form>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
      authDomain: "all-madrsa.firebaseapp.com",
      projectId: "all-madrsa",
      storageBucket: "all-madrsa.appspot.com",
      messagingSenderId: "619313835874",
      appId: "1:619313835874:web:e387e1297663f11fc2463b"
    };
    const IMG_API_KEY = "d12c2e4a8650157b2b6b9fe85336ea43";

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let editId = null;

    // Edit mode check
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('edit')) {
      editId = urlParams.get('edit');
      loadProfileForEdit(editId);
    }

    async function loadProfileForEdit(id) {
      const doc = await db.collection('profiles').doc(id).get();
      if (doc.exists) {
        const data = doc.data();
        document.getElementById('name').value = data.name || '';
        document.getElementById('age').value = data.age || '';
        document.getElementById('city').value = data.city || '';
        document.getElementById('whatsapp').value = data.whatsapp || '';
      }
    }

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const age = document.getElementById('age').value;
      const city = document.getElementById('city').value;
      const whatsapp = document.getElementById('whatsapp').value;
      const file = document.getElementById('imageInput').files[0];

      let imageURL = '';
      if (file) {
        const formData = new FormData();
        formData.append('image', file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_API_KEY}`, {
          method: 'POST',
          body: formData
        });
        const json = await res.json();
        imageURL = json.data?.url || '';
      }

      const data = { name, age, city, whatsapp, imageURL, approved: false, createdAt: new Date() };

      if (editId) {
        await db.collection('profiles').doc(editId).update(data);
        alert('Profile updated!');
      } else {
        await db.collection('profiles').add(data);
        alert('Profile submitted for approval');
      }
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>
