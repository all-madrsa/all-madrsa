<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nikah Portal — Final</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

<style>
body { background:#f8fafc; font-family: sans-serif; }
.card { background:white; border-radius:1rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; cursor:pointer; }
.card img { width:100%; height:200px; object-fit:cover; }
.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; }
.modal { background:white; border-radius:0.75rem; padding:1rem; max-width:400px; width:90%; }
</style>
</head>

<body class="p-4">
<header class="text-center mb-4">
  <h1 class="text-3xl font-bold text-gray-700">Nikah Portal</h1>
  <p class="text-gray-500">Halal Marriage Profiles</p>
</header>

<!-- Filter Section -->
<div class="flex flex-wrap justify-center gap-2 mb-4">
  <input id="filterName" placeholder="नाम / शहर" class="border p-2 rounded w-40 text-sm">
  <select id="filterGender" class="border p-2 rounded text-sm">
    <option value="">लिंग</option>
    <option value="Male">Male</option>
    <option value="Female">Female</option>
  </select>
  <button id="filterBtn" class="bg-blue-600 text-white px-3 py-2 rounded text-sm">Filter</button>
</div>

<!-- Profiles Grid -->
<div id="profilesGrid" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></div>

<!-- Post Form -->
<section class="max-w-md mx-auto mt-8 bg-white p-4 rounded-lg shadow">
  <h2 class="font-semibold text-lg mb-2">अपना प्रोफ़ाइल जोड़ें</h2>
  <form id="postForm" class="space-y-2">
    <input id="name" placeholder="नाम" class="border p-2 w-full rounded" required>
    <input id="age" type="number" placeholder="उम्र" class="border p-2 w-full rounded" required>
    <input id="city" placeholder="शहर" class="border p-2 w-full rounded" required>
    <select id="gender" class="border p-2 w-full rounded" required>
      <option value="">लिंग चुनें</option>
      <option>Male</option><option>Female</option>
    </select>
    <textarea id="about" placeholder="अपने बारे में" class="border p-2 w-full rounded"></textarea>
    <input id="photo" type="file" accept="image/*" class="border p-2 w-full rounded" required>
    <button class="bg-green-600 text-white px-4 py-2 rounded w-full">Post</button>
  </form>
  <p id="postStatus" class="text-center text-sm mt-2"></p>
</section>

<!-- Admin Panel -->
<section id="adminPanel" class="hidden max-w-3xl mx-auto mt-8 bg-white p-4 rounded-lg shadow">
  <h2 class="font-semibold text-lg mb-2">Admin Panel</h2>
  <ul id="pendingList" class="space-y-2"></ul>
</section>

<!-- Profile Modal -->
<div id="modalBg" class="modal-bg flex">
  <div class="modal">
    <img id="modalImg" class="rounded mb-2">
    <h3 id="modalName" class="font-semibold text-lg"></h3>
    <p id="modalCity" class="text-sm text-gray-600"></p>
    <p id="modalAbout" class="mt-2 text-gray-700 text-sm"></p>
    <button id="modalClose" class="mt-4 bg-gray-700 text-white w-full py-2 rounded">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_KEY",
  authDomain: "YOUR_DOMAIN.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const IMGBB_API_KEY = "YOUR_IMGBB_API_KEY";
const adminEmail = "admin@example.com";
const adminPassword = "admin123";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const profilesGrid = document.getElementById("profilesGrid");
const adminPanel = document.getElementById("adminPanel");
const pendingList = document.getElementById("pendingList");

const modalBg = document.getElementById("modalBg");
const modalImg = document.getElementById("modalImg");
const modalName = document.getElementById("modalName");
const modalCity = document.getElementById("modalCity");
const modalAbout = document.getElementById("modalAbout");
document.getElementById("modalClose").onclick = ()=> modalBg.style.display="none";

function showModal(p){
  modalImg.src = p.imageUrl;
  modalName.textContent = `${p.name}, ${p.age}`;
  modalCity.textContent = `${p.city} · ${p.gender}`;
  modalAbout.textContent = p.about || "";
  modalBg.style.display = "flex";
}

async function loadProfiles(){
  const q = query(collection(db,'profiles'), where('approved','==',true));
  const snap = await getDocs(q);
  profilesGrid.innerHTML = "";
  if(snap.empty){ profilesGrid.innerHTML="<p class='text-center text-gray-500'>कोई प्रोफाइल नहीं मिली।</p>"; return; }
  snap.forEach(s=>{
    const p = s.data();
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<img src="${p.imageUrl}"><div class='p-3'><h3 class='font-semibold'>${p.name}, ${p.age}</h3><p class='text-sm text-gray-500'>${p.city} · ${p.gender}</p></div>`;
    card.onclick = ()=> showModal(p);
    profilesGrid.appendChild(card);
  });
}

async function loadPending(){
  const q = query(collection(db,'profiles'), where('approved','==',false));
  const snap = await getDocs(q);
  pendingList.innerHTML="";
  snap.forEach(s=>{
    const p=s.data();
    const li=document.createElement("li");
    li.className="flex justify-between items-center border p-2 rounded";
    li.innerHTML=`<div>${p.name}, ${p.age}, ${p.city}</div>
      <div class='space-x-2'>
        <button class='approve bg-green-500 text-white px-2 py-1 rounded text-sm'>Approve</button>
        <button class='delete bg-red-500 text-white px-2 py-1 rounded text-sm'>Delete</button>
      </div>`;
    li.querySelector(".approve").onclick= async()=>{
      await updateDoc(doc(db,'profiles',s.id), {approved:true});
      loadPending(); loadProfiles();
    };
    li.querySelector(".delete").onclick= async()=>{
      await deleteDoc(doc(db,'profiles',s.id));
      loadPending();
    };
    pendingList.appendChild(li);
  });
}

document.getElementById("filterBtn").onclick = async ()=>{
  const name = document.getElementById("filterName").value.trim().toLowerCase();
  const gender = document.getElementById("filterGender").value;
  const q = query(collection(db,'profiles'), where('approved','==',true));
  const snap = await getDocs(q);
  profilesGrid.innerHTML="";
  let arr=[];
  snap.forEach(s=>arr.push(s.data()));
  const filtered = arr.filter(p=>{
    return (!name || p.name.toLowerCase().includes(name) || p.city.toLowerCase().includes(name)) &&
           (!gender || p.gender===gender);
  });
  if(filtered.length==0){ profilesGrid.innerHTML="<p class='text-center text-gray-500'>कोई प्रोफाइल नहीं मिली।</p>"; return;}
  filtered.forEach(p=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<img src="${p.imageUrl}"><div class='p-3'><h3 class='font-semibold'>${p.name}, ${p.age}</h3><p class='text-sm text-gray-500'>${p.city} · ${p.gender}</p></div>`;
    card.onclick=()=>showModal(p);
    profilesGrid.appendChild(card);
  });
};

document.getElementById("postForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const postStatus=document.getElementById("postStatus");
  postStatus.textContent="Uploading...";
  const name=nameEl.value, age=ageEl.value, city=cityEl.value, gender=genderEl.value, about=aboutEl.value;
  const file=document.getElementById("photo").files[0];
  if(file.size>2*1024*1024){ postStatus.textContent="Image must be <2MB."; return;}
  const formData=new FormData();
  formData.append("image", file);
  const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:formData});
  const data=await res.json();
  if(!data.success){ postStatus.textContent="Image upload failed."; return; }
  await addDoc(collection(db,'profiles'),{name,age,city,gender,about,imageUrl:data.data.url,approved:false});
  postStatus.textContent="Profile submitted for approval.";
  e.target.reset();
});

let adminLoaded=false;
onAuthStateChanged(auth, async (user)=>{
  if(!adminLoaded){
    try{
      await signInWithEmailAndPassword(auth,adminEmail,adminPassword);
      adminPanel.classList.remove("hidden");
      loadPending();
    }catch{}
    adminLoaded=true;
  }
  loadProfiles();
});
</script>
</body>
</html>
