<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>💝 Donate | Talimi Ittehad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .title-3d{font-weight:700;font-size:1.5rem;color:#fff;text-shadow:0 0 6px rgba(0,0,0,.8);}
    .btn-3d{background:linear-gradient(135deg,#4f46e5,#9333ea);color:#fff;padding:.5rem 1rem;border-radius:.5rem;box-shadow:0 3px 6px rgba(0,0,0,.3);transition:.2s;}
    .btn-3d:hover{transform:translateY(-2px);box-shadow:0 5px 10px rgba(0,0,0,.4);}
    .card-3d{background:#fff;border-radius:.8rem;padding:1rem;box-shadow:0 6px 14px rgba(0,0,0,.15);}
    .popup{position:fixed;top:20px;right:20px;z-index:50;max-width:300px;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:1rem;border-radius:.6rem;box-shadow:0 5px 12px rgba(0,0,0,.3);}
    .hidden{display:none;}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

<!-- Header -->
<header class="bg-gradient-to-r from-purple-700 via-pink-600 to-yellow-500 shadow sticky top-0 z-40">
  <div class="max-w-5xl mx-auto px-3 py-3 flex items-center justify-between">
    <a href="index.html" class="title-3d">Talimi Ittehad</a>
    <nav class="flex gap-2 text-sm text-white">
      <a href="index.html">🏠 Home</a>
      <a href="donate.html" class="font-bold underline">💝 Donate</a>
    </nav>
  </div>
</header>

<!-- Main -->
<main class="max-w-2xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">💝 Support with Donation</h1>

  <!-- Popup -->
  <div id="thankPopup" class="popup hidden">
    ✅ आपका payment मिल गया है, शुक्रिया!
    <button id="closePopup" class="ml-2 bg-white text-green-700 px-2 py-0.5 rounded">❌</button>
  </div>

  <!-- Donation Form -->
  <div class="card-3d mb-6">
    <h2 class="font-semibold mb-2">Fill your details</h2>
    <form id="donationForm" class="flex flex-col gap-3">
      <input type="text" id="name" placeholder="👤 Your Name" class="border p-2 rounded" required />
      <input type="text" id="address" placeholder="🏠 Your Address" class="border p-2 rounded" required />
      <input type="number" id="amount" placeholder="💰 Amount (₹)" class="border p-2 rounded" required />

      <!-- QR + UPI -->
      <div class="text-center">
        <p class="mb-2">📲 Pay on UPI (Scan QR or Copy ID)</p>
        <img id="qrImg" src="" class="mx-auto w-48 h-48 border rounded shadow mb-2" alt="QR Code" />
        <p id="upiText" class="font-bold text-lg text-indigo-700"></p>
        <button type="button" id="copyUpiBtn" class="btn-3d mt-2">📋 Copy UPI ID</button>
      </div>

      <!-- Screenshot Upload -->
      <div>
        <label class="block font-medium mb-1">📸 Upload Payment Screenshot</label>
        <input type="file" id="screenshot" accept="image/*" class="border p-2 rounded w-full" required />
      </div>

      <button id="submitBtn" type="submit" class="btn-3d">🚀 Submit Donation</button>
    </form>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="card-3d hidden">
    <h2 class="font-bold text-lg mb-3">👑 Admin - Donations List</h2>
    <div id="donationsList" class="space-y-3 mb-6"></div>

    <!-- QR + UPI Management -->
    <h2 class="font-bold text-lg mb-2">🔑 Manage QR & UPI</h2>
    <input type="file" id="qrUpload" accept="image/*" class="border p-2 rounded w-full mb-2" />
    <input type="text" id="upiInput" placeholder="Enter UPI ID" class="border p-2 rounded w-full mb-2" />
    <div class="flex gap-2">
      <button id="uploadQRBtn" class="btn-3d">⬆ Update</button>
      <button id="deleteQRBtn" class="btn-3d bg-red-600">🗑 Delete</button>
    </div>
  </div>
</main>

<footer class="bg-gray-100 text-center py-4 mt-10">
  <p class="text-xs text-gray-500">© 2025 Talimi Ittehad</p>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
    authDomain: "all-madrsa.firebaseapp.com",
    databaseURL: "https://all-madrsa-default-rtdb.firebaseio.com",
    projectId: "all-madrsa",
    storageBucket: "all-madrsa.appspot.com",
    messagingSenderId: "619313835874",
    appId: "1:619313835874:web:e387e1297663f11fc2463b"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // --- Config ---
  const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
  const IMGBB_KEY = "d12c2e4a8650157b2b6b9fe85336ea43"; 

  // Elements
  const qrImg=document.getElementById("qrImg");
  const upiText=document.getElementById("upiText");
  const copyUpiBtn=document.getElementById("copyUpiBtn");
  const qrUpload=document.getElementById("qrUpload");
  const upiInput=document.getElementById("upiInput");
  const uploadQRBtn=document.getElementById("uploadQRBtn");
  const deleteQRBtn=document.getElementById("deleteQRBtn");
  const donationForm=document.getElementById("donationForm");
  const submitBtn=document.getElementById("submitBtn");
  const adminPanel=document.getElementById("adminPanel");
  const donationsList=document.getElementById("donationsList");
  const thankPopup=document.getElementById("thankPopup");
  const closePopup=document.getElementById("closePopup");

  let currentUser=null;

  // --- Auth ---
  onAuthStateChanged(auth,async user=>{
    if(user){
      currentUser=user;
      liveQR();
      watchUserDonation();
      if(user.email===ADMIN_EMAIL) adminPanel.classList.remove("hidden"), watchDonations();
    }else{
      await signInWithPopup(auth,provider);
    }
  });

  // --- Popup Show ---
  function showPopupOnce(msg,id){
    if(localStorage.getItem("lastPopupId")===id) return; 
    thankPopup.classList.remove("hidden");
    thankPopup.querySelector("div")?.remove; 
    thankPopup.firstChild.textContent=msg;
    localStorage.setItem("lastPopupId",id);
    setTimeout(()=>thankPopup.classList.add("hidden"),10000);
  }
  closePopup.onclick=()=>thankPopup.classList.add("hidden");

  // --- Watch User Donation ---
  function watchUserDonation(){
    const q=query(collection(db,"donations"), where("uid","==",currentUser.uid));
    onSnapshot(q,(snap)=>{
      let hasPending=false;
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        if(d.verified){
          showPopupOnce("✅ आपका payment मिल गया है, शुक्रिया!",docSnap.id);
          submitBtn.classList.remove("hidden");
          submitBtn.disabled=false;
          submitBtn.textContent="🚀 Submit Donation";
        }else{
          hasPending=true;
          submitBtn.disabled=true;
          submitBtn.textContent="⏳ Awaiting Verification...";
          submitBtn.classList.add("hidden");
        }
      });
      if(!hasPending){
        submitBtn.classList.remove("hidden");
        submitBtn.disabled=false;
        submitBtn.textContent="🚀 Submit Donation";
      }
    });
  }

  // --- File to Base64 ---
  function toBase64(file){
    return new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=()=>resolve(reader.result.split(",")[1]);
      reader.onerror=reject;
      reader.readAsDataURL(file);
    });
  }

  // --- ImgBB Upload ---
  async function uploadToImgBB(file){
    const base64=await toBase64(file);
    const fd=new FormData();
    fd.append("image",base64);
    const res=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`,{method:"POST",body:fd});
    const data=await res.json();
    if(data.success) return data.data.url;
    else throw new Error("ImgBB upload failed: "+JSON.stringify(data));
  }

  // --- Submit Donation ---
  donationForm.onsubmit=async e=>{
    e.preventDefault();
    if(!currentUser) return alert("Please login first!");
    const name=document.getElementById("name").value;
    const address=document.getElementById("address").value;
    const amount=document.getElementById("amount").value;
    const file=document.getElementById("screenshot").files[0];
    if(!file) return alert("Upload screenshot!");

    try{
      const screenshotUrl=await uploadToImgBB(file);
      await addDoc(collection(db,"donations"),{
        uid:currentUser.uid,
        name,address,amount,
        screenshot:screenshotUrl,
        verified:false,
        created:Date.now()
      });
      alert("✅ Donation submitted! Admin verification pending.");
      donationForm.reset();
      submitBtn.disabled=true;
      submitBtn.textContent="⏳ Awaiting Verification...";
      submitBtn.classList.add("hidden");
    }catch(err){
      alert("❌ Error: "+err.message);
    }
  };

  // --- Load Donations (Admin) ---
  function watchDonations(){
    onSnapshot(collection(db,"donations"),(snap)=>{
      donationsList.innerHTML="";
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const div=document.createElement("div");
        div.className="border p-3 rounded shadow bg-white";
        div.innerHTML=`
          <p><b>👤 ${d.name}</b> (${d.address})</p>
          <p>💰 Amount: ₹${d.amount}</p>
          <img src="${d.screenshot}" class="w-40 my-2 border rounded shadow" />
          <p>Status: ${d.verified?"✅ Verified":"⏳ Pending"}</p>
          <div class="flex gap-2 mt-2">
            <button class="btn-3d verify">✅ Verify</button>
            <button class="btn-3d delete">🗑 Delete</button>
          </div>
        `;
        div.querySelector(".verify").onclick=async()=>await updateDoc(doc(db,"donations",docSnap.id),{verified:true});
        div.querySelector(".delete").onclick=async()=>{if(confirm("Delete donation?")) await deleteDoc(doc(db,"donations",docSnap.id));};
        donationsList.appendChild(div);
      });
    });
  }

  // --- Live QR + UPI ---
  function liveQR(){
    onSnapshot(doc(db,"config","qr"),snap=>{
      if(snap.exists()){
        const data=snap.data();
        qrImg.src=data.url||"https://via.placeholder.com/200?text=No+QR";
        upiText.textContent=data.upi||"";
      }else{
        qrImg.src="https://via.placeholder.com/200?text=No+QR";
        upiText.textContent="";
      }
    });
  }

  // --- Copy UPI ---
  copyUpiBtn.onclick=()=>{
    if(upiText.textContent){
      navigator.clipboard.writeText(upiText.textContent);
      alert("📋 Copied: "+upiText.textContent);
    }
  };

  // --- Upload QR + UPI (Admin) ---
  uploadQRBtn.onclick=async()=>{
    let url=null;
    if(qrUpload.files[0]) url=await uploadToImgBB(qrUpload.files[0]);
    const upi=upiInput.value;
    await setDoc(doc(db,"config","qr"),{url,upi});
    alert("✅ QR / UPI updated!");
    qrUpload.value=""; upiInput.value="";
  };

  // --- Delete QR (Admin) ---
  deleteQRBtn.onclick=async()=>{if(confirm("Delete QR & UPI?")) await deleteDoc(doc(db,"config","qr"));}
</script>
</body>
</html>
