<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üôè Donation | Talimi Ittehad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .title-3d{font-weight:700;font-size:2rem;color:#fff;text-shadow:2px 2px 8px rgba(0,0,0,.9)}
    .nav-link{padding:.35rem .6rem;border-radius:.5rem}
    .nav-active{background:#ffffff22}
    .card-3d{transition:transform .2s, box-shadow .2s}
    .card-3d:hover{transform:translateY(-4px); box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .btn-3d{
      background:linear-gradient(90deg,#ff4d4d,#4dffb8,#4d94ff,#d24dff);
      box-shadow:0 4px 0 rgba(0,0,0,.25), 0 6px 12px rgba(0,0,0,.2);
      transition:transform .12s ease, box-shadow .12s ease;
      font-size:.9rem; padding:.5rem .9rem; color:#fff; font-weight:600; border-radius:.65rem; white-space:nowrap;
    }
    .btn-3d:active{transform:translateY(1px); box-shadow:0 2px 0 rgba(0,0,0,.25)}
    .chip{border:1px solid #e5e7eb; padding:.4rem .7rem; border-radius:9999px; cursor:pointer}
    .chip.active{background:#111827; color:#fff; border-color:#111827}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

<!-- ‚úÖ Login protection (‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç ‡§§‡•ã ‡§á‡§∏ ‡§≤‡§æ‡§á‡§® ‡§ï‡•ã ‡§π‡§ü‡§æ ‡§¶‡•á‡§Ç) -->
<script src="auth-protect.js" type="module"></script>

<!-- Header -->
<header class="bg-gradient-to-r from-purple-700 via-pink-600 to-yellow-500 shadow sticky top-0 z-40">
  <div class="max-w-6xl mx-auto px-3 py-3 flex items-center justify-between">
    <a href="index.html" class="title-3d">Talimi Ittehad</a>
    <nav class="flex flex-wrap gap-2 text-sm text-white">
      <a href="index.html" class="nav-link">üè† Home</a>
      <a href="about.html" class="nav-link">About</a>
      <a href="mission.html" class="nav-link">Mission</a>
      <a href="contact.html" class="nav-link">Contact</a>
      <a href="gallery.html" class="nav-link">Gallery</a>
      <a href="islamic-calendar.html" class="nav-link">Calendar</a>
      <a href="donation.html" class="nav-link nav-active">Donation</a>
      <a href="privacy.html" class="nav-link">Privacy</a>
      <a href="terms.html" class="nav-link">Terms</a>
    </nav>
  </div>
</header>

<!-- Main -->
<main class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-2">üôè Donation</h1>
  <p class="text-sm text-gray-600 mb-4 bg-emerald-50 border border-emerald-200 px-3 py-2 rounded">
    ‡§Ü‡§™‡§ï‡§æ ‡§¶‡§æ‡§® Talimi Ittehad ‡§ï‡•á ‡§∂‡•à‡§ï‡•ç‡§∑‡§ø‡§ï ‡§î‡§∞ ‡§∏‡§Æ‡§æ‡§ú‡§∏‡•á‡§µ‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó ‡§π‡•ã‡§ó‡§æ‡•§ ‡§Ö‡§≤‡•ç‡§≤‡§æ‡§π ‡§ï‡§º‡•Å‡§¨‡•Ç‡§≤ ‡§´‡§∞‡§Æ‡§æ‡§è‡•§
  </p>

  <!-- Donation Card -->
  <div class="grid md:grid-cols-2 gap-4">
    <!-- Left: UPI + Amount -->
    <div class="card-3d bg-white p-4 rounded shadow">
      <h2 class="font-semibold text-lg mb-2">üì≤ UPI ‡§∏‡•á Donate ‡§ï‡§∞‡•á‡§Ç</h2>

      <div class="flex items-center gap-2 mb-2">
        <span class="text-sm text-gray-600">UPI ID:</span>
        <code id="upiId" class="text-sm bg-gray-100 px-2 py-1 rounded">loading@upi</code>
        <button id="copyUpi" class="btn-3d text-xs">Copy</button>
      </div>
      <div class="text-sm text-gray-600 mb-3">
        ‡§®‡§æ‡§Æ (UPI): <span id="upiName" class="font-semibold">Loading...</span>
      </div>

      <div class="mb-3">
        <div class="flex flex-wrap gap-2">
          <button class="chip" data-am="100">‚Çπ100</button>
          <button class="chip" data-am="200">‚Çπ200</button>
          <button class="chip" data-am="500">‚Çπ500</button>
          <button class="chip" data-am="1000">‚Çπ1000</button>
          <button class="chip" data-am="2500">‚Çπ2500</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="text-sm text-gray-600">Custom Amount (INR)</label>
        <input id="amount" type="number" min="1" placeholder="e.g. 351" class="w-full border p-2 rounded mt-1" />
      </div>

      <div class="mb-3">
        <label class="text-sm text-gray-600">Note (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï)</label>
        <input id="note" type="text" maxlength="40" placeholder="Sadaqah / Zakat etc." class="w-full border p-2 rounded mt-1" />
      </div>

      <a id="payNow" class="btn-3d inline-block">üì• Pay Now (UPI App)</a>
      <p class="text-xs text-gray-500 mt-2">Pay Now ‡§¶‡§¨‡§æ‡§§‡•á ‡§π‡•Ä ‡§Ü‡§™‡§ï‡§æ UPI ‡§ê‡§™ ‡§ñ‡•Å‡§≤‡•á‡§ó‡§æ‡•§</p>
    </div>

    <!-- Right: QR + Bank -->
    <div class="card-3d bg-white p-4 rounded shadow">
      <h2 class="font-semibold text-lg mb-2">üßæ QR ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç</h2>
      <div class="flex items-center justify-center">
        <img id="qrImg" src="" alt="UPI QR" class="w-52 h-52 object-contain border rounded" />
      </div>
      <p class="text-xs text-center text-gray-500 mt-2">UPI ‡§ê‡§™ ‡§∏‡•á QR ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§ï‡•á ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§</p>

      <hr class="my-4">

      <h3 class="font-semibold mb-2">üè¶ ‡§¨‡•à‡§Ç‡§ï ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏</h3>
      <div id="bankBox" class="text-sm text-gray-700 space-y-1">
        <div>Bank: <span id="bankName">‚Äî</span></div>
        <div>Account No: <span id="accNo">‚Äî</span></div>
        <div>IFSC: <span id="ifsc">‚Äî</span></div>
        <div>Branch: <span id="branch">‚Äî</span></div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden card-3d bg-white p-4 rounded shadow mt-6">
    <h2 class="font-semibold text-lg mb-3">üë®‚Äçüíª Admin: Donation Settings</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="text-sm">UPI ID</label>
        <input id="ad_upiId" class="w-full border p-2 rounded mt-1" placeholder="example@upi">
      </div>
      <div>
        <label class="text-sm">UPI Name (pn)</label>
        <input id="ad_upiName" class="w-full border p-2 rounded mt-1" placeholder="Talimi Ittehad">
      </div>
      <div>
        <label class="text-sm">Bank Name</label>
        <input id="ad_bankName" class="w-full border p-2 rounded mt-1">
      </div>
      <div>
        <label class="text-sm">Account No</label>
        <input id="ad_accNo" class="w-full border p-2 rounded mt-1">
      </div>
      <div>
        <label class="text-sm">IFSC</label>
        <input id="ad_ifsc" class="w-full border p-2 rounded mt-1">
      </div>
      <div>
        <label class="text-sm">Branch</label>
        <input id="ad_branch" class="w-full border p-2 rounded mt-1">
      </div>
      <div class="md:col-span-2">
        <label class="text-sm">UPI QR Image (upload to ImgBB)</label>
        <input id="ad_qrFile" type="file" accept="image/*" class="mt-1">
        <p class="text-xs text-gray-500">‡§®‡§Ø‡§æ QR ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§§‡•ã Save ‡§∏‡•á ‡§™‡§π‡§≤‡•á Upload ‡§¶‡§¨‡§æ‡§è‡§Å‡•§</p>
        <div class="flex gap-2 mt-2">
          <button id="uploadQR" class="btn-3d">‚¨Ü Upload QR</button>
          <input id="ad_qrUrl" class="flex-1 border p-2 rounded" placeholder="https://i.ibb.co/... (optional paste)">
        </div>
      </div>
    </div>

    <div class="flex justify-end mt-4">
      <button id="saveDonation" class="btn-3d">üíæ Save Settings</button>
    </div>
  </div>
</main>

<footer class="bg-gray-100 text-center py-4 mt-10">
  <p class="text-xs text-gray-500">¬© 2025 Talimi Ittehad</p>
</footer>

<!-- Firebase + Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // ====== CONFIG ======
  const firebaseConfig = {
    apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
    authDomain: "all-madrsa.firebaseapp.com",
    databaseURL: "https://all-madrsa-default-rtdb.firebaseio.com",
    projectId: "all-madrsa",
    storageBucket: "all-madrsa.appspot.com",
    messagingSenderId: "619313835874",
    appId: "1:619313835874:web:e387e1297663f11fc2463b"
  };
  const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
  const IMGBB_API_KEY = "396fbc779807e34e4131a8a8e48ad03c";

  // ====== INIT ======
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // ====== UI Refs ======
  const upiIdEl   = document.getElementById("upiId");
  const upiNameEl = document.getElementById("upiName");
  const qrImg     = document.getElementById("qrImg");

  const bankNameEl = document.getElementById("bankName");
  const accNoEl    = document.getElementById("accNo");
  const ifscEl     = document.getElementById("ifsc");
  const branchEl   = document.getElementById("branch");

  const amountInput = document.getElementById("amount");
  const noteInput   = document.getElementById("note");
  const payNowBtn   = document.getElementById("payNow");

  const copyUpiBtn  = document.getElementById("copyUpi");

  // Admin refs
  const adminPanel = document.getElementById("adminPanel");
  const ad_upiId   = document.getElementById("ad_upiId");
  const ad_upiName = document.getElementById("ad_upiName");
  const ad_bankName= document.getElementById("ad_bankName");
  const ad_accNo   = document.getElementById("ad_accNo");
  const ad_ifsc    = document.getElementById("ad_ifsc");
  const ad_branch  = document.getElementById("ad_branch");
  const ad_qrFile  = document.getElementById("ad_qrFile");
  const ad_qrUrl   = document.getElementById("ad_qrUrl");
  const uploadQRBtn= document.getElementById("uploadQR");
  const saveBtn    = document.getElementById("saveDonation");

  let currentUser = null;
  let donationCfg = {
    upiId: "loading@upi",
    upiName: "Talimi Ittehad",
    qrUrl: "",
    bankName: "",
    accNo: "",
    ifsc: "",
    branch: ""
  };

  // ====== Helpers ======
  function toBase64(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result.split(",")[1]);
      r.onerror = e => reject(e);
      r.readAsDataURL(file);
    });
  }
  async function uploadToImgBB(file){
    const base64 = await toBase64(file);
    const fd = new FormData();
    fd.append("image", base64);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:"POST", body: fd });
    const data = await res.json();
    if(data.success) return data.data.url;
    throw new Error("ImgBB upload failed");
  }
  function buildUpiLink(upiId, upiName, amount, note){
    const params = new URLSearchParams({
      pa: upiId,
      pn: upiName || "Talimi Ittehad",
      cu: "INR"
    });
    if(amount && Number(amount) > 0) params.set("am", String(amount));
    if(note) params.set("tn", note.substring(0, 40));
    return `upi://pay?${params.toString()}`;
  }
  function renderUI(){
    // public UI
    upiIdEl.textContent = donationCfg.upiId || "‚Äî";
    upiNameEl.textContent = donationCfg.upiName || "‚Äî";
    qrImg.src = donationCfg.qrUrl || "";
    bankNameEl.textContent = donationCfg.bankName || "‚Äî";
    accNoEl.textContent = donationCfg.accNo || "‚Äî";
    ifscEl.textContent = donationCfg.ifsc || "‚Äî";
    branchEl.textContent = donationCfg.branch || "‚Äî";

    // admin form
    ad_upiId.value   = donationCfg.upiId || "";
    ad_upiName.value = donationCfg.upiName || "";
    ad_bankName.value= donationCfg.bankName || "";
    ad_accNo.value   = donationCfg.accNo || "";
    ad_ifsc.value    = donationCfg.ifsc || "";
    ad_branch.value  = donationCfg.branch || "";
    ad_qrUrl.value   = donationCfg.qrUrl || "";
  }

  // ====== Load Config ======
  async function loadDonationCfg(){
    const ref = doc(db, "config", "donation");
    const snap = await getDoc(ref);
    if(snap.exists()) donationCfg = { ...donationCfg, ...snap.data() };
    renderUI();
  }

  // ====== Auth State ======
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    if(!donationCfg.upiId || donationCfg.upiId === "loading@upi"){
      await loadDonationCfg();
    }
    // show admin panel
    if(currentUser?.email === ADMIN_EMAIL){
      adminPanel.classList.remove("hidden");
    } else {
      adminPanel.classList.add("hidden");
    }
  });

  // ====== Chips (amount presets) ======
  const chips = Array.from(document.querySelectorAll(".chip"));
  chips.forEach(chip=>{
    chip.addEventListener("click", ()=>{
      chips.forEach(c=>c.classList.remove("active"));
      chip.classList.add("active");
      amountInput.value = chip.dataset.am;
    });
  });

  // ====== Copy UPI ======
  copyUpiBtn.onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(donationCfg.upiId || "");
      copyUpiBtn.textContent = "Copied!";
      setTimeout(()=> copyUpiBtn.textContent = "Copy", 1200);
    }catch(e){}
  };

  // ====== Pay Now ======
  function updatePayLink(){
    const am = amountInput.value.trim();
    const nt = noteInput.value.trim();
    const link = buildUpiLink(donationCfg.upiId, donationCfg.upiName, am, nt);
    payNowBtn.setAttribute("href", link);
  }
  amountInput.addEventListener("input", updatePayLink);
  noteInput.addEventListener("input", updatePayLink);
  updatePayLink();

  // ====== Admin: Upload QR to ImgBB ======
  uploadQRBtn.onclick = async ()=>{
    if(!(currentUser?.email === ADMIN_EMAIL)) return alert("Not allowed");
    const f = ad_qrFile.files?.[0];
    if(!f) return alert("Select a file first");
    uploadQRBtn.textContent = "Uploading...";
    uploadQRBtn.disabled = true;
    try{
      const url = await uploadToImgBB(f);
      ad_qrUrl.value = url;
      alert("‚úÖ QR uploaded");
    }catch(err){
      alert("‚ùå " + err.message);
    }finally{
      uploadQRBtn.textContent = "‚¨Ü Upload QR";
      uploadQRBtn.disabled = false;
    }
  };

  // ====== Admin: Save Settings ======
  saveBtn.onclick = async ()=>{
    if(!(currentUser?.email === ADMIN_EMAIL)) return alert("Not allowed");
    const ref = doc(db, "config", "donation");
    const payload = {
      upiId: ad_upiId.value.trim(),
      upiName: ad_upiName.value.trim(),
      bankName: ad_bankName.value.trim(),
      accNo: ad_accNo.value.trim(),
      ifsc: ad_ifsc.value.trim(),
      branch: ad_branch.value.trim(),
      qrUrl: ad_qrUrl.value.trim()
    };
    await setDoc(ref, payload, { merge: true });
    donationCfg = { ...donationCfg, ...payload };
    renderUI();
    updatePayLink();
    alert("‚úÖ Donation settings updated");
  };

  // ====== Fallback: If user opens without being logged in but page is protected ======
  // (auth-protect.js ‡§Ü‡§Æ‡§§‡•å‡§∞ ‡§™‡§∞ redirect ‡§ï‡§∞ ‡§¶‡•á‡§ó‡§æ; ‡§´‡§ø‡§∞ ‡§≠‡•Ä ‡§Ø‡§π‡§æ‡§Å ‡§è‡§ï fallback login button ‡§ü‡•ç‡§∞‡§ø‡§ó‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç)
  // Example (Optional): auto-prompt sign-in on click of Pay Now if no user:
  payNowBtn.addEventListener("click", async (e)=>{
    if(!currentUser){
      e.preventDefault();
      try{ await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch(err){ /* ignore */ }
    }
  });

  // Initial load
  loadDonationCfg();
</script>
</body>
</html>
