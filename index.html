<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Talimi Ittehad</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .title-3d {
      font-weight: bold;
      font-size: 1.8rem;
      color: white;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.9);
    }
    .dropdown:hover .dropdown-menu { display:block; }
    .dropdown-menu {
      display:none;
      position:absolute;
      background:white;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      border-radius:0.5rem;
      min-width:160px;
      z-index:50;
    }
    .dropdown-menu a {
      display:block;
      padding:6px 12px;
      font-size:14px;
      color:#333;
    }
    .dropdown-menu a:hover { background:#f3f4f6; }
    .btn-3d {
      background: linear-gradient(90deg,#ff4d4d,#4dffb8,#4d94ff,#d24dff);
      box-shadow: 0 4px 0 rgba(0,0,0,0.25), 0 6px 12px rgba(0,0,0,0.2);
      transition: transform .12s ease, box-shadow .12s ease;
      font-size: 0.85rem;
      padding: 0.35rem 0.7rem;
      color: white;
      font-weight: 600;
      border-radius: 6px;
      white-space: nowrap;
    }
    .btn-3d:active { transform: translateY(1px); box-shadow: 0 2px 0 rgba(0,0,0,0.25); }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

<!-- Header -->
<header class="bg-gradient-to-r from-purple-700 via-pink-600 to-yellow-500 shadow sticky top-0 z-40">
  <div class="max-w-6xl mx-auto flex flex-col">
    <!-- Top bar -->
    <div class="flex items-center justify-between px-4 py-2">
      <div class="title-3d">Talimi Ittehad</div>
      <div class="flex items-center gap-2">
        <button id="addBtn" class="btn-3d hidden">+ Add Madarsa</button>
        <button id="authBtn" class="btn-3d">Login</button>
      </div>
    </div>
    <!-- Menu row -->
    <div class="flex items-center gap-4 px-4 pb-2 text-sm overflow-x-auto">
      <div class="dropdown relative">
        <button class="btn-3d">About ‚¨á</button>
        <div class="dropdown-menu">
          <a href="#">About</a>
          <a href="#">Contact</a>
          <a href="#">Privacy</a>
          <a href="#">Terms & Conditions</a>
        </div>
      </div>
      <div class="dropdown relative">
        <button class="btn-3d">More ‚¨á</button>
        <div class="dropdown-menu">
          <a href="#">Notice</a>
          <a href="#">Talim</a>
          <a href="#">Requirement</a>
          <a href="#">Program</a>
        </div>
      </div>
      <button class="btn-3d">üôè Donate</button>
      <button id="scrollBtn" class="btn-3d hidden">‚úç Add Scrolling Text</button>
    </div>
  </div>
</header>

<!-- Scrolling text -->
<div id="scrollBox" class="bg-gradient-to-r from-green-400 via-blue-500 to-purple-600 py-1">
  <marquee id="scrollText" class="text-white font-semibold">
    üì¢ Welcome to Talimi Ittehad ‚Äì ‡§ó‡§∞‡•Ä‡§¨ ‡§¨‡§ö‡•ç‡§ö‡•ã‡§Ç ‡§ï‡•Ä ‡§§‡§æ‡§≤‡•Ä‡§Æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à!
  </marquee>
</div>

<!-- Main content -->
<main class="max-w-6xl mx-auto p-4">
  <div id="list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</main>

<!-- Register Madarsa Modal -->
<div id="regModal" class="fixed inset-0 z-[60] bg-black/40 hidden items-start justify-center overflow-y-auto">
  <div class="bg-white rounded-lg shadow max-w-xl w-full p-4 my-10">
    <div class="flex justify-between items-center">
      <h3 class="text-lg font-semibold text-emerald-600">Register Madarsa</h3>
      <button onclick="closeModal()" class="text-gray-600">X</button>
    </div>
    <form id="regForm" class="mt-3 space-y-3">
      <input id="mname" placeholder="Madarsa ka naam" class="w-full border p-2 rounded" required />
      <input id="maddress" placeholder="Address (City, State)" class="w-full border p-2 rounded" required />
      <input id="mcontact" placeholder="Contact number" class="w-full border p-2 rounded" required />
      <input id="mwhatsapp" placeholder="WhatsApp number" class="w-full border p-2 rounded" />
      <input id="mcourses" placeholder="Courses (comma separated)" class="w-full border p-2 rounded" />
      <div>
        <label class="block text-sm text-indigo-600">Upload Image (optional)</label>
        <input id="mimage" type="file" accept="image/*" class="mt-1" />
      </div>
      <div>
        <label class="block text-sm text-indigo-600">Upload UPI QR (optional)</label>
        <input id="mupi" type="file" accept="image/*" class="mt-1" />
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeModal()" class="px-4 py-2 border rounded">Cancel</button>
        <button type="submit" class="btn-3d">Submit</button>
      </div>
      <p id="regHint" class="text-xs text-gray-500"></p>
    </form>
  </div>
</div>

<!-- Scroll Text Modal -->
<div id="scrollModal" class="fixed inset-0 z-[60] bg-black/40 hidden items-start justify-center overflow-y-auto">
  <div class="bg-white rounded-lg shadow max-w-md w-full p-4 my-10">
    <h3 class="text-lg font-semibold text-indigo-600 mb-2">Add Scrolling Text</h3>
    <textarea id="scrollInput" rows="3" class="w-full border p-2 rounded" placeholder="Type scrolling text here..."></textarea>
    <div class="flex justify-end gap-2 mt-2">
      <button onclick="closeScrollModal()" class="px-4 py-2 border rounded">Cancel</button>
      <button onclick="saveScrollText()" class="btn-3d">Save</button>
    </div>
  </div>
</div>

<!-- Poster Add Modal -->
<div id="posterModal" class="fixed inset-0 z-[60] bg-black/40 hidden items-start justify-center overflow-y-auto">
  <div class="bg-white rounded-lg shadow max-w-xl w-full p-4 my-10">
    <div class="flex justify-between items-center">
      <h3 class="text-lg font-semibold text-fuchsia-600">Add Poster</h3>
      <button onclick="closePosterModal()" class="text-gray-600">X</button>
    </div>
    <form id="posterForm" class="mt-3 space-y-3">
      <textarea id="pAbout" rows="3" class="w-full border p-2 rounded" placeholder="About poster..."></textarea>
      <div>
        <label class="block text-sm text-indigo-600">Upload Images (max 5)</label>
        <input id="pImages" type="file" accept="image/*" class="mt-1" multiple />
        <p class="text-xs text-gray-500">‡§Ü‡§™ ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 5 images ‡§ö‡•Å‡§® ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closePosterModal()" class="px-4 py-2 border rounded">Cancel</button>
        <button type="submit" class="btn-3d">Post</button>
      </div>
      <p id="posterHint" class="text-xs text-gray-500"></p>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, updateDoc, doc,
    query, orderBy, onSnapshot, setDoc, where, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDMvkPqFKDjrMaLlBkercBYoLxEs1GEbng",
    authDomain: "all-madrsa.firebaseapp.com",
    projectId: "all-madrsa",
    storageBucket: "all-madrsa.appspot.com",
    messagingSenderId: "619313835874",
    appId: "1:619313835874:web:e387e1297663f11fc2463b"
  };

  // --- Initialize ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  const provider = new GoogleAuthProvider();

  // --- DOM ---
  const authBtn = document.getElementById('authBtn');
  const addBtn = document.getElementById('addBtn');
  const scrollBtn = document.getElementById('scrollBtn');
  const scrollModal = document.getElementById('scrollModal');
  const scrollInput = document.getElementById('scrollInput');
  const scrollText = document.getElementById('scrollText');
  const regModal = document.getElementById('regModal');
  const listDiv = document.getElementById('list');
  const regForm = document.getElementById('regForm');
  const regHint = document.getElementById('regHint');

  const posterModal = document.getElementById('posterModal');
  const posterForm = document.getElementById('posterForm');
  const pAbout = document.getElementById('pAbout');
  const pImages = document.getElementById('pImages');
  const posterHint = document.getElementById('posterHint');

  // --- State ---
  let currentUser = null;
  const ADMIN_EMAIL = "zaradigitalseva@gmail.com";
  let currentPosterMadarsaId = null; // ‡§ï‡§ø‡§∏ ‡§Æ‡§¶‡§∞‡§∏‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ã‡§∏‡•ç‡§ü‡§∞ ‡§¨‡§® ‡§∞‡§π‡§æ ‡§π‡•à
  const posterUnsubs = new Map(); // madarsaId -> unsubscribe fn

  // --- Helpers: Modals ---
  window.closeModal = () => {
    regModal.classList.add('hidden');
    regModal.classList.remove('flex');
    regForm.reset();
    regHint.textContent = "";
  };
  function openRegModal(){
    regModal.classList.remove('hidden');
    regModal.classList.add('flex');
  }

  function openScrollModal(){ scrollModal.classList.remove('hidden'); scrollModal.classList.add('flex'); }
  function closeScrollModal(){ scrollModal.classList.add('hidden'); scrollModal.classList.remove('flex'); }

  function openPosterModal(madarsaId){
    currentPosterMadarsaId = madarsaId;
    posterModal.classList.remove('hidden');
    posterModal.classList.add('flex');
  }
  function closePosterModal(){
    currentPosterMadarsaId = null;
    posterModal.classList.add('hidden');
    posterModal.classList.remove('flex');
    posterForm.reset();
    posterHint.textContent = "";
  }

  // --- Auth ---
  authBtn.onclick = async () => {
    if (!auth.currentUser) await signInWithPopup(auth, provider);
    else await signOut(auth);
  };

  onAuthStateChanged(auth, user => {
    currentUser = user;
    if (user) {
      authBtn.textContent = "Logout";
      addBtn.classList.remove('hidden');
      if (user.email === ADMIN_EMAIL) scrollBtn.classList.remove('hidden');
    } else {
      authBtn.textContent = "Login";
      addBtn.classList.add('hidden');
      scrollBtn.classList.add('hidden');
    }
    loadList(); // refresh listing on auth change
  });

  addBtn.onclick = openRegModal;

  // --- Scroll text save + live ---
  window.saveScrollText = async () => {
    const txt = scrollInput.value.trim();
    if (!txt) return;
    await setDoc(doc(db, "config", "scroll"), { text: txt });
    closeScrollModal();
  };
  scrollBtn.onclick = () => openScrollModal();

  onSnapshot(doc(db,"config","scroll"), (snap)=>{
    if(snap.exists()) scrollText.textContent = snap.data().text;
  });

  // --- Upload helper ---
  async function uploadToStorage(path, file){
    const r = ref(storage, `${path}/${Date.now()}-${file.name}`);
    await uploadBytes(r, file);
    return await getDownloadURL(r);
  }

  // --- Register Madarsa Submit ---
  regForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!currentUser) { regHint.textContent = "Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à."; return; }

    const name = document.getElementById('mname').value.trim();
    const address = document.getElementById('maddress').value.trim();
    const contact = document.getElementById('mcontact').value.trim();
    const whatsapp = document.getElementById('mwhatsapp').value.trim();
    const courses = document.getElementById('mcourses').value.trim();
    const mimage = document.getElementById('mimage').files[0];
    const mupi = document.getElementById('mupi').files[0];

    regHint.textContent = "Uploading...";
    let imageURL = "";
    let upiURL = "";

    try {
      if (mimage) imageURL = await uploadToStorage(`madarse/images/${currentUser.uid}`, mimage);
      if (mupi) upiURL = await uploadToStorage(`madarse/upi/${currentUser.uid}`, mupi);

      await addDoc(collection(db, "madarse"), {
        name, address, contact, whatsapp,
        courses,
        image: imageURL || "",
        upi: upiURL || "",
        status: "pending",
        showExtra: false,
        ownerUid: currentUser.uid,
        createdAt: serverTimestamp()
      });

      regHint.textContent = "Submitted! Admin approval ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç.";
      setTimeout(()=> closeModal(), 800);
    } catch (err) {
      regHint.textContent = "Error: " + err.message;
    }
  });

  // --- Posters: add submit ---
  posterForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!currentUser) { posterHint.textContent = "Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à."; return; }
    if (!currentPosterMadarsaId) { posterHint.textContent = "Madarsa select ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à."; return; }

    const about = pAbout.value.trim();
    const files = Array.from(pImages.files || []);
    if (files.length > 5) {
      posterHint.textContent = "Max 5 images allowed.";
      return;
    }
    posterHint.textContent = "Uploading...";

    try {
      const urls = [];
      for (let i=0; i<files.length; i++){
        const url = await uploadToStorage(`posters/${currentPosterMadarsaId}/${currentUser.uid}`, files[i]);
        urls.push(url);
      }
      await addDoc(collection(db, "posters"), {
        madarsaId: currentPosterMadarsaId,
        ownerUid: currentUser.uid,
        about: about || "",
        images: urls,
        status: "pending", // admin approve ‡§ï‡§∞‡•á‡§ó‡§æ ‡§§‡§¨ public ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ
        createdAt: serverTimestamp()
      });
      posterHint.textContent = "Poster submitted! Admin approval ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç.";
      setTimeout(()=> closePosterModal(), 800);
    } catch (err) {
      posterHint.textContent = "Error: " + err.message;
    }
  });

  // --- Load Madarsa list + per-card Posters ---
  function loadList() {
    // unsubscribe ‡§™‡•Å‡§∞‡§æ‡§®‡•á poster listeners
    posterUnsubs.forEach(unsub => { try{unsub();}catch{} });
    posterUnsubs.clear();

    const qMad = query(collection(db, "madarse"), orderBy("createdAt", "desc"));
    onSnapshot(qMad, (qSnap) => {
      listDiv.innerHTML = '';
      qSnap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;

        // visibility logic
        if (d.status === "pending" && (!currentUser || currentUser.email !== ADMIN_EMAIL)) return;
        if (d.status === "rejected" && (!currentUser || (currentUser.email !== ADMIN_EMAIL && currentUser.uid !== d.ownerUid))) return;

        const card = document.createElement('div');
        card.className = `border rounded-lg shadow bg-white p-3`;

        const adminControls = (currentUser && currentUser.email === ADMIN_EMAIL) ? `
          <div class="flex flex-wrap gap-2 mt-2">
            ${d.status === "approved"
              ? `<button disabled class="btn-3d">‚úÖ Approved</button>`
              : `<button class="approve btn-3d">Approve</button>`}
            <button class="reject btn-3d">Reject</button>
            <button class="toggleExtra btn-3d">
              ${d.showExtra ? '‚ùå Disable Extra Info' : 'Enable Extra Info'}
            </button>
          </div>` : ``;

        card.innerHTML = `
          ${d.image ? `<img src="${d.image}" class="w-full h-40 object-contain mb-2 cursor-pointer"/>` : ""}
          <h2 class="font-bold text-lg">${d.name || ''}</h2>
          <p class="text-sm text-gray-600">${d.address || ''}</p>
          ${d.status === "rejected" ? `<p class="text-red-600 font-semibold">‚ùå Rejected</p>` : ""}
          <div class="extra hidden mt-2">
            ${d.showExtra && d.contact ? `<p class="text-sm">üìû ${d.contact}</p>` : ""}
            ${d.showExtra && d.whatsapp ? `<a href="https://wa.me/${d.whatsapp}" target="_blank" class="btn-3d mt-1 inline-block">üì≤ WhatsApp</a>` : ""}
            ${d.showExtra && d.upi ? `
              <div class="mt-2">
                <img src="${d.upi}" class="w-24 mx-auto rounded border"/>
                <p class="text-center text-xs text-pink-600">üôè Please donate for poor children's education</p>
              </div>` : ""}
          </div>

          <div class="flex flex-wrap gap-2 mt-3">
            <button class="btn-3d viewPosters">üìå View Posters</button>
            ${currentUser ? `<button class="btn-3d addPoster">‚ûï Add Poster</button>` : ``}
          </div>

          ${adminControls}

          <!-- Posters Section -->
          <div class="posters hidden mt-3 border-t pt-3">
            <div class="flex items-center justify-between">
              <h4 class="font-semibold text-fuchsia-600">Posters</h4>
              <span class="text-xs text-gray-500">Approved posters ‡§∏‡§≠‡•Ä ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§§‡•á ‡§π‡•à‡§Ç</span>
            </div>
            <div class="posterGrid grid grid-cols-2 gap-3 mt-2"></div>
            <p class="posterMsg text-xs text-gray-500 mt-2"></p>
          </div>
        `;

        // expand madarsa extra
        card.querySelector("img")?.addEventListener("click", () => {
          card.querySelector(".extra").classList.toggle("hidden");
        });

        // Admin actions for madarsa
        if (currentUser && currentUser.email === ADMIN_EMAIL) {
          card.querySelector(".approve")?.addEventListener("click", async () => {
            await updateDoc(doc(db, "madarse", id), { status: "approved" });
          });
          card.querySelector(".reject")?.addEventListener("click", async () => {
            await updateDoc(doc(db, "madarse", id), { status: "rejected" });
          });
          card.querySelector(".toggleExtra")?.addEventListener("click", async () => {
            await updateDoc(doc(db, "madarse", id), { showExtra: !d.showExtra });
          });
        }

        // Posters: view + add
        const postersBox = card.querySelector(".posters");
        const posterGrid = card.querySelector(".posterGrid");
        const posterMsg  = card.querySelector(".posterMsg");

        function attachPosterListener(){
          // ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§ï‡•ã‡§à listener ‡§π‡•à ‡§§‡•ã ‡§π‡§ü‡§æ‡§ì
          if (posterUnsubs.has(id)) {
            try { posterUnsubs.get(id)(); } catch {}
            posterUnsubs.delete(id);
          }

          // ‡§ï‡•å‡§® ‡§∏‡•á posters ‡§¶‡§ø‡§ñ‡•á‡§Ç‡§ó‡•á:
          // - ‡§∏‡§≠‡•Ä users ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§ø‡§∞‡•ç‡§´ approved
          // - admin ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§≠‡•Ä (approved/pending/rejected)
          // - owner ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§∏‡§ï‡•á posters ‡§≠‡•Ä ‡§¶‡§ø‡§ñ‡•á‡§Ç‡§ó‡•á (pending/rejected ‡§∏‡§π‡§ø‡§§)
          let constraints = [ where("madarsaId","==",id), orderBy("createdAt","desc") ];
          const qBase = query(collection(db,"posters"), ...constraints);

          const unsub = onSnapshot(qBase, (snap)=>{
            posterGrid.innerHTML = '';
            let any = false;

            snap.forEach(pdoc=>{
              const pd = pdoc.data();
              const pid = pdoc.id;

              const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
              const isOwner = currentUser && pd.ownerUid === currentUser.uid;

              // visibility
              if (pd.status !== "approved" && !(isAdmin || isOwner)) return;

              any = true;

              const posterCard = document.createElement('div');
              posterCard.className = "border rounded-md p-2";

              const imgs = (pd.images || []).slice(0,5).map(u=>`<img src="${u}" class="w-full h-24 object-cover rounded mb-1" />`).join("");
              const statusBadge = pd.status === "approved" ? "‚úÖ Approved"
                                   : pd.status === "rejected" ? "‚ùå Rejected"
                                   : "‚è≥ Pending";

              posterCard.innerHTML = `
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs text-gray-500">${statusBadge}</span>
                  ${(isAdmin) ? `
                    <div class="flex gap-1">
                      ${pd.status !== "approved" ? `<button class="btn-3d btn-approve text-xs px-2 py-1">Approve</button>` : ``}
                      <button class="btn-3d btn-reject text-xs px-2 py-1">Reject</button>
                    </div>` : ``}
                </div>
                <div>${imgs || '<div class="text-xs text-gray-400">No images</div>'}</div>
                ${pd.about ? `<p class="text-xs mt-1">${pd.about}</p>` : ``}
              `;

              if (isAdmin){
                posterCard.querySelector(".btn-approve")?.addEventListener("click", async ()=>{
                  await updateDoc(doc(db,"posters",pid), { status:"approved" });
                });
                posterCard.querySelector(".btn-reject")?.addEventListener("click", async ()=>{
                  await updateDoc(doc(db,"posters",pid), { status:"rejected" });
                });
              }

              posterGrid.appendChild(posterCard);
            });

            posterMsg.textContent = any ? "" : "‡§ï‡•ã‡§à poster ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§";
          });

          posterUnsubs.set(id, unsub);
        }

        // View Posters toggle
        card.querySelector(".viewPosters").addEventListener("click", ()=>{
          postersBox.classList.toggle("hidden");
          if (!postersBox.classList.contains("hidden")){
            attachPosterListener();
          } else {
            if (posterUnsubs.has(id)) {
              try { posterUnsubs.get(id)(); } catch {}
              posterUnsubs.delete(id);
            }
          }
        });

        // Add Poster button
        card.querySelector(".addPoster")?.addEventListener("click", ()=>{
          if (!currentUser) {
            alert("Poster ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è login ‡§ï‡§∞‡•á‡§Ç.");
            return;
          }
          openPosterModal(id);
        });

        listDiv.appendChild(card);
      });
    });
  }
</script>
</body>
</html>
